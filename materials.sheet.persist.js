/* materials.sheet.persist.js v1.6b */ (function(){const log=(...a)=>console.log('[mat-sheet-persist v1.6b]',...a);const warn=(...a)=>console.warn('[mat-sheet-persist v1.6b]',...a);const W=window;let CTX=null;const ensured=new Map();function setCtx(ctx){if(!ctx||!ctx.spreadsheetId)return;CTX={spreadsheetId:ctx.spreadsheetId,sheetGid:ctx.sheetGid||0};W.__LM_SHEET_CTX=CTX;log('ctx set',CTX);}if(W.__LM_SHEET_CTX) setCtx(W.__LM_SHEET_CTX);W.addEventListener('lm:sheet-context',(e)=>setCtx(e?.detail),{capture:true});async function waitCtx(ms=8000){if(CTX&&CTX.spreadsheetId) return CTX;const t0=performance.now();return await new Promise((resolve,reject)=>{const on=(e)=>{setCtx(e?.detail);if(CTX?.spreadsheetId){cleanup();resolve(CTX);}};const cleanup=()=>{clearTimeout(to);W.removeEventListener('lm:sheet-context',on,{capture:true});};W.addEventListener('lm:sheet-context',on,{capture:true});const to=setTimeout(()=>{cleanup();reject(new Error('ctx-timeout after '+(performance.now()-t0).toFixed(0)+'ms'));},ms);if(typeof W.__lm_replay_ctx__==='function'&&W.__lm_replay_ctx__()){}});}async function fetchJSONAuth(url,init={}){if(typeof W.__lm_fetchJSONAuth!=='function') throw new Error('__lm_fetchJSONAuth missing');const headers=new Headers(init.headers||{});let body=init.body;const sendable=typeof body==='string'||body instanceof Blob||body instanceof FormData||body instanceof URLSearchParams||body instanceof ArrayBuffer;if(body!=null&&!sendable){body=JSON.stringify(body);if(!headers.has('Content-Type')) headers.set('Content-Type','application/json');}return W.__lm_fetchJSONAuth(url,{...init,headers,body});}async function ensure(sheetId){const memo=ensured.get(sheetId)||{sheet:false,headers:false};if(!memo.sheet){const meta=await fetchJSONAuth(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}`);const titles=(meta.sheets||[]).map(s=>s.properties.title);if(!titles.includes('__LM_MATERIALS')){await fetchJSONAuth(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}:batchUpdate`,{method:'POST',body:{requests:[{addSheet:{properties:{title:'__LM_MATERIALS'}}}]}});log('created sheet __LM_MATERIALS');}else{log('sheet exists');}memo.sheet=true;}if(!memo.headers){const headers=['materialKey','opacity','doubleSided','unlitLike','chromaEnable','chromaColor','chromaTolerance','chromaFeather','roughness','metalness','emissiveHex','updatedAt','updatedBy'];await fetchJSONAuth(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent('__LM_MATERIALS!A1:M1')}?valueInputOption=RAW`,{method:'PUT',body:{values:[headers]}});log('headers ensured A:M');memo.headers=true;}ensured.set(sheetId,memo);}async function upsert({materialKey,opacity=1,doubleSided=false,unlitLike=false}){const ctx=await waitCtx().catch(e=>{warn('waitCtx failed',e.message);throw e;});const sheetId=ctx.spreadsheetId;await ensure(sheetId);const colA=await fetchJSONAuth(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent('__LM_MATERIALS!A:A')}`);const rows=colA.values||[];let rowIndex=rows.findIndex(r=>(r[0]||'')===materialKey);let rowNumber;if(rowIndex<=0){rowNumber=rows.length+1;await fetchJSONAuth(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(`__LM_MATERIALS!A${rowNumber}:A${rowNumber}`)}?valueInputOption=RAW`,{method:'PUT',body:{values:[[materialKey]]}});}else{rowNumber=rowIndex+1;}const iso=new Date().toISOString();const rowValues=[opacity??'',(doubleSided?'TRUE':'FALSE'),(unlitLike?'TRUE':'FALSE'),'FALSE','#000000','0','0','','','',iso,'mat-ui'];await fetchJSONAuth(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(`__LM_MATERIALS!B${rowNumber}:M${rowNumber}`)}?valueInputOption=RAW`,{method:'PUT',body:{values:[rowValues]}});log('persisted',{rowNumber,materialKey,opacity,doubleSided,unlitLike});}window.__LM_MAT_PERSIST__={ensure:async()=>{const ctx=await waitCtx();await ensure(ctx.spreadsheetId);},upsert};log('loaded');})();