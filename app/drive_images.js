const IMAGE_MIMES=['image/jpeg','image/png','image/webp','image/heif','image/heic'];export async function getFileMeta(fileId){if(!window.gapi?.client)throw new Error('gapi.client not available');const res=await gapi.client.drive.files.get({fileId,fields:'id,name,parents,mimeType,thumbnailLink'});return res.result;}export async function listSiblingImages(glbFileId){if(!window.gapi?.client)return[];const me=await getFileMeta(glbFileId);const parent=(me.parents&&me.parents[0])||null;if(!parent)return[];const mimeQuery=IMAGE_MIMES.map(m=>`mimeType='${m}'`).join(' or ');const q=`'${parent}' in parents and (${mimeQuery}) and trashed=false`;const res=await gapi.client.drive.files.list({q,fields:'files(id,name,mimeType,thumbnailLink,webContentLink)',pageSize:200,orderBy:'name_natural'});return(res.result.files||[]).map(f=>({id:f.id,name:f.name,mimeType:f.mimeType,thumbnailLink:f.thumbnailLink,webContentLink:f.webContentLink}));}let heicLoaded=false;export async function ensureHeic2Any(){if(heicLoaded)return;await new Promise((resolve,reject)=>{const s=document.createElement('script');s.src='https://unpkg.com/heic2any/dist/heic2any.min.js';s.onload=()=>{heicLoaded=true;resolve();};s.onerror=reject;document.head.appendChild(s);});}export async function downloadBlob(fileId){if(!window.gapi?.client)throw new Error('gapi.client not available');const token=gapi.client.getToken()?.access_token;const url=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(fileId)}?alt=media`;const res=await fetch(url,{headers:{'Authorization':`Bearer ${token}`}});if(!res.ok)throw new Error(`HTTP ${res.status}`);return await res.blob();}export async function toJpegUrlIfNeeded(file){const isHeic=/heic|heif/i.test(file.mimeType||'');if(!isHeic)return file.thumbnailLink||file.webContentLink;await ensureHeic2Any();const blob=await downloadBlob(file.id);const out=await window.heic2any({blob,toType:'image/jpeg',quality:0.9});return URL.createObjectURL(out);}