<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>LociMyu v6.6</title>
  <link rel="icon" href="./favicon.ico" />

  <!-- three の bare import を暫定的に解決（長期はモジュール側で統一する） -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
      "three/examples/jsm/": "https://unpkg.com/three@0.156.1/examples/jsm/"
    }
  }
  </script>

  <style>
    :root{
      --bg:#0c0d10; --panel:#121318; --line:#262833; --text:#e6e8ef; --muted:#a6a8b0; --accent:#4da3ff;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #app{display:grid;grid-template-columns:1fr 360px;height:100vh}
    #stage{position:relative;background:#0b0c10}
    #gl{width:100%;height:100%;display:block}
    #ui{background:var(--panel);border-left:1px solid var(--line);
      overflow-y:auto;overflow-x:hidden}

    header{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
    #brand{font-weight:600;opacity:.9}
    .row{display:flex;gap:6px;align-items:center}
    input[type="text"]{background:#0f1016;color:var(--text);border:1px solid var(--line);
      border-radius:6px;padding:8px 10px;min-width:0}
    button,select{background:#0f1016;color:var(--text);border:1px solid var(--line);
      border-radius:8px;padding:8px 10px;cursor:pointer}

    .tabs{display:flex;border-bottom:1px solid var(--line)}
    .tabs button{flex:1 1 0;padding:10px 6px;background:transparent;border:none;
      border-bottom:2px solid transparent;color:var(--muted)}
    .tabs button[aria-selected="true"]{color:var(--text);border-bottom-color:var(--accent)}
    .pane{display:none;padding:12px}
    .pane[data-active="true"]{display:block}
    .pad{padding:12px}
    .hint{color:var(--muted);font-size:.86rem}

    /* Material pane layout helpers (wrap nicely, no horizontal scroll) */
    .pm-row{display:flex;flex-wrap:wrap;align-items:center;gap:10px;margin-top:8px}
    .pm-row label{display:inline-flex;align-items:center;gap:8px;white-space:nowrap}
    .pm-row input[type="range"]{min-width:140px;flex:1 1 160px}
    .pm-row input[type="color"]{width:44px;height:28px;padding:0;border:1px solid var(--line);border-radius:6px;background:transparent}
    .pm-chroma-controls{margin-top:6px}
    .pm-chroma-controls label{flex:1 1 160px}

    @media (max-width: 420px){
      #app{grid-template-columns:1fr}
      .pm-row label{flex:1 1 100%}
      .pm-row input[type="range"]{min-width:0}
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="stage"><canvas id="gl"></canvas></div>

    <aside id="ui">
      <!-- top bar -->
      <header>
        <div id="brand">LociMyu v6.6</div>
        <div class="row" style="margin-left:auto;gap:6px">
          <button id="auth-signin">Sign in</button>
        </div>
      </header>

      <!-- URL & sheet controls (IDs keep boot wiring intact) -->
      <div class="pad" style="border-bottom:1px solid var(--line)">
        <div class="row">
          <input id="glbUrl" type="text" placeholder="Drive fileId / GLB URL" />
          <button id="btnGlb">Load</button>
        </div>
        <div class="row" style="margin-top:8px">
          <select id="save-target-sheet"><option value="">Select sheet...</option></select>
          <button id="save-target-create">Create</button>
        </div>
      </div>

      <!-- tabs -->
      <nav class="tabs" role="tablist">
        <button id="tab-caption" role="tab" data-tab="caption" aria-selected="false">Caption</button>
        <button id="tab-material" role="tab" data-tab="material" aria-selected="true">Material</button>
        <button id="tab-views" role="tab" data-tab="views" aria-selected="false">Views</button>
      </nav>

      <!-- MATERIAL -->
      <section id="pane-material" class="pane" data-active="true">
        <div class="pm-row">
          <label><input id="pm-unlit" type="checkbox" /> Unlit</label>
          <label><input id="pm-double" type="checkbox" /> Double-sided</label>
        </div>

        <div class="pm-row">
          <label>Opacity
            <input id="pm-opaque" type="range" min="0" max="1" step="0.01" value="1.00" />
          </label>
          <output id="pm-opaque-out">1.00</output>
        </div>

        <div class="pm-row">
          <label><input id="pm-whitealpha" type="checkbox" /> White → Alpha</label>
        </div>

        <div class="pm-row"><label>Per-material opacity (saved per sheet)</label></div>
        <div class="pm-row">
          <select id="pm-material"><option value="">— Select material —</option></select>
          <input id="pm-opacity-range" type="range" min="0" max="1" step="0.01" value="1.00" />
          <output id="pm-opacity-val">1.00</output>
        </div>
        <div class="hint">Pick a material, then set its opacity. This does not change global opacity above.</div>

        <div class="pm-row" style="margin-top:12px">
          <label><input id="pm-chroma-toggle" type="checkbox" /> Chroma key</label>
        </div>
        <div id="pm-chroma-controls" class="pm-row pm-chroma-controls">
          <label>Key color
            <input id="pm-chroma-color" type="color" value="#00ff00" />
          </label>
          <label>Tolerance
            <input id="pm-chroma-tol" type="range" min="0" max="1" step="0.01" value="0.30" />
          </label>
          <label>Feather
            <input id="pm-chroma-feather" type="range" min="0" max="1" step="0.01" value="0.00" />
          </label>
        </div>
      </section>

      <!-- placeholders -->
      <section id="pane-caption" class="pane" data-active="false"></section>
      <section id="pane-views"   class="pane" data-active="false"></section>
    </aside>
  </div>

  <!-- 既存の起動順は維持 -->
  <script type="module" src="./boot.esm.cdn.js"></script>
  <script type="module" src="./viewer.bridge.module.js"></script>
  <script type="module" src="./material.ui.orch.js"></script>

  <!-- タブ切替（最小・他依存なし） -->
  <script>
    (function () {
      const tabs = document.querySelectorAll('[role="tab"]');
      const panes = {
        caption: document.getElementById('pane-caption'),
        material: document.getElementById('pane-material'),
        views: document.getElementById('pane-views'),
      };
      function activate(tabName){
        tabs.forEach(btn => btn.setAttribute('aria-selected', String(btn.dataset.tab === tabName)));
        Object.entries(panes).forEach(([name,el]) => el?.setAttribute('data-active', String(name === tabName)));
      }
      activate('material');
      tabs.forEach(btn => btn.addEventListener('click', () => activate(btn.dataset.tab)));
    })();
  </script>
</body>
</html>
