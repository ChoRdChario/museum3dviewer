<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LociMyu v6.6</title>

  <!-- 既存のスタイル群（必要に応じて保持） -->
  <link rel="stylesheet" href="./leader.css"/>
  <link rel="stylesheet" href="./app.css"/>

  <!-- three / boot / 既存 ESM/CDN ローダ -->
  <script type="module" src="./boot.esm.cdn.js"></script>
</head>

<body>
  <div id="app">
    <!-- 上部バーなど既存 UI を保持 -->

    <div id="right-panel">
      <div class="tabs">
        <button id="tab-caption">Caption</button>
        <button id="tab-material" class="active">Material</button>
        <button id="tab-views">Views</button>
      </div>

      <!-- ===================== Material Panel ===================== -->
      <div id="panel-material" class="panel active">
        <div class="card">
          <div class="card-header" style="display:flex;align-items:center;gap:8px;">
            <div>Per-material opacity (saved per sheet)</div>
            <!-- ここが追加：ユーザー操作で GIS 同意を出す小ボタン -->
            <button id="pm-auth" class="btn xs" style="margin-left:auto;display:none;">Authorize Sheets</button>
          </div>
          <div class="card-body">
            <div class="row" style="display:flex;gap:8px;align-items:center;">
              <select id="pm-material" style="min-width: 180px;">
                <option value="">— Select material —</option>
              </select>
              <input id="pm-opacity-range" type="range" min="0" max="1" step="0.01" value="1" style="flex:1;"/>
              <span id="pm-opacity-val" style="width:3.5em;text-align:right;">1.00</span>
            </div>
            <p class="help">Pick a material, then set its opacity. This does not change global opacity above.</p>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Shading</div>
          <div class="card-body">
            <label><input id="pm-flag-doublesided" type="checkbox"/> Double-sided</label>
            <label style="margin-left:12px;"><input id="pm-flag-unlit" type="checkbox"/> Unlit-like</label>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Chroma key</div>
          <div class="card-body">
            <div class="row" style="display:flex;align-items:center;gap:12px;">
              <label><input id="pm-chroma-enable" type="checkbox"/> Enable</label>
              <input id="pm-chroma-color" type="color" value="#000000" style="width:52px;height:28px;border-radius:6px;border:1px solid #444;"/>
            </div>
            <div class="row" style="margin-top:8px;">
              <div>Tolerance</div>
              <input id="pm-chroma-tol" type="range" min="0" max="1" step="0.01" value="0.4" style="display:block;width:100%;"/>
            </div>
            <div class="row" style="margin-top:8px;">
              <div>Feather</div>
              <input id="pm-chroma-feather" type="range" min="0" max="1" step="0.01" value="0.2" style="display:block;width:100%;"/>
            </div>
          </div>
        </div>
      </div>
      <!-- ===================== /Material Panel ===================== -->
    </div>
  </div>

  <!-- 既存：viewer bridge は最初に -->
  <script type="module" src="./viewer.bridge.module.js"></script>
  <!-- 既存：シート文脈ブリッジ（spreadsheetId/sheetGid を lm:sheet-context で流す） -->
  <script type="module" src="./sheet.ctx.bridge.js"></script>

  <!-- 本ファイル：認可をユーザー操作に限定した orchestrator -->
  <script type="module" src="./material.orchestrator.js"></script>

  <!-- マテリアル名の遅延取得ホットフィックス（冪等） -->
  <script type="module">
    async function populateWhenReadyHotfix(){
      if (!window.__LM_SCENE) {
        await new Promise(r=>document.addEventListener('lm:scene-ready', r, {once:true}));
      }
      await new Promise(r=>setTimeout(r, 50));
      let tries=0, names=[];
      function listFromScene(){
        const set = new Set();
        const s = window.__LM_SCENE;
        s?.traverse(o=>{
          if (!o.isMesh || !o.material) return;
          (Array.isArray(o.material)?o.material:[o.material]).forEach(m=>m?.name && set.add(m.name));
        });
        return [...set];
      }
      async function listFromViewer(){
        try {
          const viewer = await import('./viewer.module.cdn.js');
          return (viewer?.listMaterials?.() || []).map(r=>r?.name).filter(Boolean);
        } catch { return []; }
      }
      function dedup(a){ return [...new Set(a)].filter(n=>!/^#\d+$/.test(n)); }

      while (tries++ < 30) {
        const a = await listFromViewer();
        const b = listFromScene();
        names = dedup([ ...a, ...b ]);
        if (names.length) break;
        await new Promise(r=>setTimeout(r, 200));
      }
      if (!names.length) {
        console.warn('[mat-orch-hotfix] materials still empty after retries (non-fatal)');
        return;
      }
      const sel = document.querySelector('#pm-material'); if (!sel) return;
      const cur = sel.value;
      sel.innerHTML = '<option value="">— Select material —</option>' +
        names.map(n=>`<option value="${n}">${n}</option>`).join('');
      if (cur && names.includes(cur)) sel.value = cur;
    }
    populateWhenReadyHotfix();
    document.addEventListener('lm:model-ready', populateWhenReadyHotfix);
    document.getElementById('tab-material')?.addEventListener('click', populateWhenReadyHotfix);

    // 認可ボタンの表示/動作：orchestrator が公開する __lm_requestSheetsConsent を検出
    const authBtn = document.getElementById('pm-auth');
    function maybeShowAuth(){ if (typeof window.__lm_requestSheetsConsent === 'function') authBtn.style.display = ''; }
    authBtn?.addEventListener('click', async ()=>{
      try {
        await window.__lm_requestSheetsConsent?.();    // ユーザー操作直後 → ポップアップ同意
        authBtn.style.display = 'none';
        await window.lmMaterials?.ensureMaterialSheet?.();
      } catch (e) { console.warn('[auth] consent failed', e); }
    });
    document.getElementById('tab-material')?.addEventListener('click', maybeShowAuth);
    document.getElementById('pm-opacity-range')?.addEventListener('pointerdown', maybeShowAuth, { once:true });
  </script>

  <!-- 開発用：VSC content script などがあればこのまま保持 -->
  <script src="./content.js"></script>
</body>
</html>
