<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LociMyu v0.1 (UMD strict guards)</title>
  <link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" fill="%230b0f14"/><text x="32" y="39" font-size="28" text-anchor="middle" fill="%2353b7ff" font-family="Arial">L</text></svg>'>
  <style>
    :root{ --bg:#0b0f14; --panel:#121922; --text:#e6edf3; --accent:#53b7ff; --muted:#8fa3bd; --radius:16px;}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    .app{display:grid;grid-template-rows:auto 1fr;height:100vh}
    header{display:flex;gap:.75rem;align-items:center;padding:10px 12px;background:linear-gradient(180deg,#0e1520,#0b0f14);border-bottom:1px solid #1e2837}
    .pill{background:rgba(255,255,255,.06);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.08);font-weight:700}
    input[type=text]{background:#0f1722;border:1px solid #203049;color:var(--text);border-radius:10px;padding:8px 10px;min-width:260px}
    button{background:#152133;color:var(--text);border:1px solid #223146;border-radius:10px;padding:8px 12px;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    button:hover{background:#1a2b45}
    .accent{border-color:#2c82c9}
    .main{display:grid;grid-template-columns:280px 1fr 320px;gap:10px;padding:10px;height:calc(100vh - 58px)}
    .panel{background:#121922;border:1px solid #1e2837;border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;min-height:0}
    .panel h3{margin:0;padding:10px 12px;border-bottom:1px solid #203049;background:#0f1722;font-size:.95rem;font-weight:600}
    .panel .body{padding:10px;overflow:auto}
    #viewer{position:relative}
    #viewerCanvas{display:block;width:100%;height:100%;background:#0a0f16;border-radius:var(--radius)}
    .hud{position:absolute;left:10px;bottom:10px;display:flex;gap:8px}
    .chip{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px}
    .spinner{position:absolute;inset:0;display:grid;place-items:center;background:linear-gradient(180deg, rgba(10,15,22,.75), rgba(10,15,22,.75));backdrop-filter: blur(2px);}
    .lds{width:64px;height:64px;border-radius:50%;border:6px solid rgba(255,255,255,.12);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .signin-gate{position:fixed;inset:0;display:grid;place-items:center;background:radial-gradient(1200px 600px at 50% 15%, rgba(83,183,255,.08), transparent 60%), linear-gradient(180deg,#0a0f16,#05070b);z-index:20}
    .card{width:min(560px,92vw);background:#0c1118;border:1px solid #1d2a3d;border-radius:24px;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:20px}
    .card h1{margin:4px 0 8px;font-size:1.35rem}
    .card p{color:#c2d0e2;opacity:.9}
    .list{display:flex;flex-direction:column;gap:8px}
    .list .row{display:flex;align-items:center;justify-content:space-between;gap:8px;background:#0f1722;border:1px solid #203049;border-radius:12px;padding:10px}
    .row .title{font-weight:600}
    .row .meta{color:#a9b8cf;font-size:.85rem}
    @media (max-width: 900px){ .main{grid-template-columns:1fr; grid-template-rows: 300px 1fr 300px} }
  </style>
</head>
<body>
<div class="app">
  <header>
    <span class="pill">LociMyu</span>
    <div class="toolbar" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input id="inputGLB" type="text" placeholder="GLB fileId or share URL" />
      <input id="inputSheet" type="text" placeholder="SpreadsheetId or share URL" />
      <button id="btnLoad" class="accent" disabled>GLBを読み込む</button>
      <button id="btnViewOnly">閲覧リンクを生成</button>
      <span id="statusLabel" class="chip">初期化中…</span>
    </div>
  </header>
  <div class="main">
    <section class="panel" id="left">
      <h3>キャプション / Pins</h3>
      <div class="body">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button id="btnAddPin" disabled>＋ ピン追加</button>
          <button id="btnGizmo" disabled>ギズモ: OFF</button>
          <button id="btnUndo" disabled>Ctrl+Z</button>
        </div>
        <div id="pinsList" class="list"></div>
      </div>
    </section>
    <section class="panel" id="viewer">
      <div class="spinner" id="loading" hidden><div class="lds"></div></div>
      <canvas id="viewerCanvas"></canvas>
      <div class="hud"><div class="chip" id="modeLabel">Orbit</div></div>
    </section>
    <section class="panel" id="right">
      <h3>キャプション編集</h3>
      <div class="body">
        <div id="noSelection">ピンを選択してください</div>
        <div id="editor" hidden>
          <div style="display:flex;flex-direction:column;gap:8px">
            <label>タイトル<input id="capTitle" type="text" placeholder="タイトル" /></label>
            <label>本文<textarea id="capBody" rows="7" placeholder="キャプション本文"></textarea></label>
            <div style="display:flex;gap:8px;justify-content:space-between;align-items:center">
              <button id="btnSavePin" class="accent" disabled>保存（Sheets）</button>
              <button id="btnDeletePin" style="border-color:#5a1f26;color:#ffb4b4" disabled>削除</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<div class="signin-gate" id="gate">
  <div class="card">
    <h1>Googleにサインイン</h1>
    <p>本ツールは Google Drive / Google Sheets を使用します。先にサインインしてください。</p>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button id="btnSignIn" class="accent" style="font-weight:700">🔐 Sign in with Google</button>
      <span class="meta" style="opacity:.8">OAuth2 (Drive.file / Sheets)</span>
    </div>
  </div>
</div>

<script>
  window.__gm = { gapi:false, gis:false };
  function onGapi(){ window.__gm.gapi = true; }
  function onGis(){  window.__gm.gis  = true; }
</script>
<script async defer src="https://accounts.google.com/gsi/client" onload="onGis()"></script>
<script async defer src="https://apis.google.com/js/api.js" onload="onGapi()"></script>

<!-- THREE UMD r0.152.2 -->
<script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.152.2/examples/js/controls/OrbitControls.js"></script>
<script src="https://unpkg.com/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://unpkg.com/three@0.152.2/examples/js/controls/TransformControls.js"></script>

<script>
const CLIENT_ID = '595200751510-ncahnf7edci6b9925becn5to49r6cguv.apps.googleusercontent.com';
const API_KEY   = 'AIzaSyCUnTCr5yWUWPdEXST9bKP1LpgawU5rIbI';
const DISCOVERY_DOCS = [
  'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
  'https://www.googleapis.com/discovery/v1/apis/sheets/v4/rest'
];
const SCOPES = [
  'https://www.googleapis.com/auth/drive.file',
  'https://www.googleapis.com/auth/drive.readonly',
  'https://www.googleapis.com/auth/drive.metadata.readonly',
  'https://www.googleapis.com/auth/spreadsheets'
].join(' ');

function extractDriveFileId(input){
  if(!input) return '';
  const m1 = input.match(/\/file\/d\/([a-zA-Z0-9_-]{10,})/); if(m1) return m1[1];
  const m2 = input.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);     if(m2) return m2[1];
  const m3 = input.match(/^([a-zA-Z0-9_-]{20,})$/);          if(m3) return m3[1];
  return input.trim();
}
function extractSpreadsheetId(input){
  if(!input) return '';
  const m1 = input.match(/spreadsheets\/d\/([a-zA-Z0-9_-]{10,})/); if(m1) return m1[1];
  const m2 = input.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);           if(m2) return m2[1];
  const m3 = input.match(/^([a-zA-Z0-9_-]{20,})$/);                if(m3) return m3[1];
  return input.trim();
}

let tokenClient; let gapiInited=false, gisInited=false; let accessToken=null;
let renderer, scene, camera, controls, tcontrols, pinGroup;
let raycaster, pointer, loader, currentModel=null;
let threeReady=false;

const el = {};

document.addEventListener('DOMContentLoaded', () => {
  Object.assign(el, {
    gate: document.getElementById('gate'),
    statusLabel: document.getElementById('statusLabel'),
    inputGLB: document.getElementById('inputGLB'),
    inputSheet: document.getElementById('inputSheet'),
    btnLoad: document.getElementById('btnLoad'),
    loading: document.getElementById('loading'),
    viewerCanvas: document.getElementById('viewerCanvas'),
    pinsList: document.getElementById('pinsList'),
    rightNoSel: document.getElementById('noSelection'),
    rightEditor: document.getElementById('editor'),
    capTitle: document.getElementById('capTitle'),
    capBody: document.getElementById('capBody'),
    btnSavePin: document.getElementById('btnSavePin'),
    btnDeletePin: document.getElementById('btnDeletePin'),
    btnAddPin: document.getElementById('btnAddPin'),
    btnGizmo: document.getElementById('btnGizmo'),
    btnUndo: document.getElementById('btnUndo'),
    modeLabel: document.getElementById('modeLabel'),
    btnSignIn: document.getElementById('btnSignIn'),
  });

  // Google init polling
  const tick = setInterval(()=>{
    if(window.__gm.gapi && window.gapi && !gapiInited){ gapi.load('client', initGapiClient); }
    if(window.__gm.gis && !gisInited){ gisInited = true; maybeReady(); }
    if(gapiInited && gisInited){ clearInterval(tick); }
  }, 200);

  el.btnSignIn.addEventListener('click', ()=>{
    if(!tokenClient){ alert('Google API 初期化中。少し待って再試行'); return; }
    tokenClient.requestAccessToken({ prompt:'consent' });
  });

  // Wait for THREE extras then init viewer
  waitForThreeExtras(()=>{
    viewerInit();
    threeReady = true;
    enableUi();
    toast('3D初期化完了');
  });

  // Query seed
  const q = new URLSearchParams(location.search);
  if(q.get('fileId')) el.inputGLB.value = q.get('fileId');
  if(q.get('sheetId')) el.inputSheet.value = q.get('sheetId'));

  // UI events
  el.btnLoad.addEventListener('click', ()=>{
    if(!threeReady){ alert('3Dライブラリ初期化中です。数秒後に再試行してください。'); return; }
    const fid = extractDriveFileId(el.inputGLB.value.trim());
    const sid = extractSpreadsheetId(el.inputSheet.value.trim());
    el.inputGLB.value = fid; el.inputSheet.value = sid;
    loadGLBByFileId(fid);
  });
  el.btnUndo.addEventListener('click', undo);
  el.capTitle && el.capTitle.addEventListener('input', ()=>{ const p=pins.find(x=>x.id===selectedPinId); if(!p) return; p.title=el.capTitle.value; refreshPinsList(); });
  el.capBody && el.capBody.addEventListener('input',  ()=>{ const p=pins.find(x=>x.id===selectedPinId); if(!p) return; p.body =el.capBody.value; });
  el.btnDeletePin && el.btnDeletePin.addEventListener('click', ()=>{ if(!selectedPinId) return; removePin(selectedPinId); });
  el.btnSavePin && el.btnSavePin.addEventListener('click', savePinToSheet);
  document.getElementById('btnViewOnly')?.addEventListener('click', ()=>{
    const fid = extractDriveFileId(el.inputGLB.value.trim());
    const sid = extractSpreadsheetId(el.inputSheet.value.trim());
    const url = new URL(location.href); url.searchParams.set('view','1'); url.searchParams.set('fileId', fid); url.searchParams.set('sheetId', sid);
    navigator.clipboard.writeText(url.toString()); toast('閲覧リンクをコピーしました');
  });

  // Keyboard
  window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='z'){ e.preventDefault(); el.btnUndo?.click(); } });
});

function enableUi(){
  ['btnLoad','btnAddPin','btnGizmo','btnUndo','btnSavePin','btnDeletePin'].forEach(id=>{
    const b = document.getElementById(id); if(b) b.removeAttribute('disabled');
  });
  el.statusLabel.textContent='Ready';
}

// Wait for extras
function waitForThreeExtras(cb){
  const ok = () => window.THREE && (THREE.OrbitControls||window.OrbitControls) && (THREE.GLTFLoader||window.GLTFLoader) && (THREE.TransformControls||window.TransformControls);
  if(ok()) return cb();
  const iv = setInterval(()=>{ if(ok()){ clearInterval(iv); cb(); } }, 100);
}
function ctor_OrbitControls(){ return THREE.OrbitControls || window.OrbitControls; }
function ctor_TransformControls(){ return THREE.TransformControls || window.TransformControls; }
function ctor_GLTFLoader(){ return THREE.GLTFLoader || window.GLTFLoader; }

// Google init
async function initGapiClient(){
  try{
    await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
    gapiInited = true; maybeReady();
  }catch(e){ console.error('gapi init failed', e); }
}
function maybeReady(){
  if(!gapiInited || !gisInited) return;
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID, scope: SCOPES,
    callback: (resp)=>{
      accessToken = resp.access_token;
      if(accessToken){ el.gate.style.display='none'; toast('Signed in'); }
    }
  });
}

// Viewer
function viewerInit(){
  renderer = new THREE.WebGLRenderer({ canvas: el.viewerCanvas, antialias:true });
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0a0f16);
  camera = new THREE.PerspectiveCamera(60, 2, 0.1, 2000);
  camera.position.set(2.8,1.6,3.6);
  const hemi = new THREE.HemisphereLight(0xffffff, 0x223355, 0.6); scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff, 1.0); dir.position.set(3,5,4); scene.add(dir);

  const OrbitCtor = ctor_OrbitControls();
  const TransformCtor = ctor_TransformControls();
  if(!OrbitCtor || !TransformCtor){ console.error('Three extras not ready'); return; }
  controls = new OrbitCtor(camera, el.viewerCanvas); controls.target.set(0,1,0); controls.update();
  tcontrols = new TransformCtor(camera, el.viewerCanvas); tcontrols.setSize(0.9); tcontrols.setSpace('world'); tcontrols.addEventListener('dragging-changed', e=>{ controls.enabled = !e.value; }); scene.add(tcontrols); tcontrols.visible=false;

  pinGroup = new THREE.Group(); scene.add(pinGroup);
  raycaster = new THREE.Raycaster(); pointer = new THREE.Vector2();
  const LoaderCtor = ctor_GLTFLoader();
  if(!LoaderCtor){ console.error('GLTFLoader not ready'); return; }
  loader = new LoaderCtor();

  window.addEventListener('resize', resize); el.viewerCanvas.addEventListener('pointerdown', onPointerDown);
  resize(); animate();
}
function resize(){ const w = el.viewerCanvas.clientWidth || el.viewerCanvas.parentElement.clientWidth; const h = el.viewerCanvas.clientHeight || el.viewerCanvas.parentElement.clientHeight; renderer.setSize(w,h,false); camera.aspect=w/h; camera.updateProjectionMatrix(); }
function animate(){ requestAnimationFrame(animate); renderer.render(scene,camera); }
function renderNow(){ renderer.render(scene,camera); }

// GLB load
async function loadGLBByFileId(fileId){
  if(!accessToken){ alert('先にサインインしてください'); return; }
  if(!loader){ alert('3Dライブラリ初期化中です。数秒後に再試行してください。'); return; }
  try{
    el.loading.hidden = false;
    toast('GLBを読み込み中…');
    const meta = await gapi.client.drive.files.get({ fileId, fields:'id,name,mimeType' });
    const dlUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
    const ab = await fetch(dlUrl, { headers:{ Authorization:`Bearer ${accessToken}` } }).then(r=>{
      if(!r.ok) throw new Error('Drive download failed: ' + r.status);
      return r.arrayBuffer();
    });
    if(currentModel){
      scene.remove(currentModel);
      currentModel.traverse(o=>{ if(o.geometry) o.geometry.dispose(); if(o.material){ if(Array.isArray(o.material)) o.material.forEach(m=>m.dispose()); else o.material.dispose(); } });
      currentModel=null;
    }
    await new Promise((resolve,reject)=>{
      try{
        loader.parse(ab, '', (gltf)=>{ currentModel = gltf.scene; scene.add(currentModel); fitToScene(); resolve(); }, (err)=> reject(err||new Error('parse failed')) );
      }catch(err){ reject(err); }
    });
    toast(`Loaded: ${meta.result.name}`);
  }catch(err){
    console.error(err);
    alert('GLB読み込みに失敗しました（詳細はコンソールを確認）');
  }finally{
    el.loading.hidden = true;
  }
}
function fitToScene(){ if(!currentModel) return; const box = new THREE.Box3().setFromObject(currentModel); const size = box.getSize(new THREE.Vector3()); const center = box.getCenter(new THREE.Vector3()); const maxDim = Math.max(size.x,size.y,size.z)||1; const dist = maxDim*1.6; camera.position.copy(center.clone().add(new THREE.Vector3(dist, dist*0.7, dist))); controls.target.copy(center); controls.update(); }

// Pins (snip: same as before)
let pins=[]; let selectedPinId=null; let undoStack=[];
function addUndo(u){ undoStack.push(u); }
function undo(){ const u = undoStack.pop(); if(!u) return; if(u.type==='move'){ const p=pins.find(x=>x.id===u.id); if(p){ p.pos.copy(u.from); placePinMesh(p); selectPin(p.id); renderNow(); } } else if(u.type==='add'){ removePin(u.id,{silent:true}); } else if(u.type==='delete'){ pins.push(u.pin); placePinMesh(u.pin); refreshPinsList(); selectPin(u.pin.id); renderNow(); } }
function createPin(pos,color){ const id=`p_${Date.now()}_${Math.random().toString(36).slice(2,7)}`; const pin={id,pos:pos.clone(),color:color||'#ff6b6b',title:'',body:'',images:[],mesh:null}; pins.push(pin); placePinMesh(pin); refreshPinsList(); selectPin(id); addUndo({type:'add',id}); }
function placePinMesh(pin){ if(pin.mesh){ pinGroup.remove(pin.mesh); pin.mesh.geometry.dispose(); pin.mesh.material.dispose(); pin.mesh=null; } const geo=new THREE.SphereGeometry(0.01,16,16); const mat=new THREE.MeshBasicMaterial({color:new THREE.Color(pin.color)}); const mesh=new THREE.Mesh(geo,mat); mesh.position.copy(pin.pos); mesh.userData.pinId=pin.id; pin.mesh=mesh; pinGroup.add(mesh); }
function selectPin(id){ selectedPinId=id; const p=pins.find(x=>x.id===id); if(!p){ el.rightEditor.hidden=true; el.rightNoSel.hidden=false; return; } el.rightNoSel.hidden=true; el.rightEditor.hidden=false; el.capTitle.value=p.title||''; el.capBody.value=p.body||''; tcontrols.attach(p.mesh); controls.target.copy(p.pos); controls.update(); }
function refreshPinsList(){ el.pinsList.innerHTML=''; pins.forEach(p=>{ const row=document.createElement('div'); row.className='row'; row.dataset.id=p.id; const left=document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px'; const dot=document.createElement('div'); dot.style.width='10px'; dot.style.height='10px'; dot.style.borderRadius='999px'; dot.style.background=p.color; left.appendChild(dot); const title=document.createElement('div'); title.className='title'; title.textContent=p.title||'(無題)'; left.appendChild(title); const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`x:${p.pos.x.toFixed(2)} y:${p.pos.y.toFixed(2)} z:${p.pos.z.toFixed(2)}`; row.appendChild(left); row.appendChild(meta); row.addEventListener('click',()=>selectPin(p.id)); el.pinsList.appendChild(row); }); }
function removePin(id,{silent}={}){ const idx=pins.findIndex(x=>x.id===id); if(idx<0) return; const pin=pins[idx]; if(pin.mesh){ pinGroup.remove(pin.mesh); pin.mesh.geometry.dispose(); pin.mesh.material.dispose(); } pins.splice(idx,1); if(!silent) addUndo({type:'delete',pin}); refreshPinsList(); el.rightEditor.hidden=true; el.rightNoSel.hidden=false; selectedPinId=null; }

// Sheets save
async function savePinToSheet(){
  const sheetId = extractSpreadsheetId(el.inputSheet.value.trim()); if(!sheetId){ alert('Spreadsheet ID が未設定です'); return; }
  const p = pins.find(x=>x.id===selectedPinId); if(!p){ alert('ピンを選択してください'); return; }
  try{
    const values = [[p.id, p.title, p.body, p.pos.x, p.pos.y, p.pos.z, p.color, JSON.stringify(p.images||[]), Date.now()]];
    await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: sheetId, range: 'pins!A1', valueInputOption:'RAW', resource:{ values } });
    toast('保存しました（append）');
  }catch(e){ console.error(e); alert('保存に失敗しました'); }
}

function toast(msg){ el.statusLabel.textContent=msg; setTimeout(()=> el.statusLabel.textContent='Ready', 2000); }
</script>
</body>
</html>
