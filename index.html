<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LociMyu v6.6</title>
  <link rel="stylesheet" href="./app.css?v=20251005" />
  <style>
    body{margin:0;background:#0f1116;color:#e5e7eb;font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .app{display:grid;grid-template-columns:1fr 360px;height:100vh}
    .viewer{position:relative;background:#0f1116}
    .panel{border-left:1px solid rgba(255,255,255,.06);background:#111319}
    .row{padding:8px 10px}
    .row + .row{border-top:1px solid rgba(255,255,255,.06)}
    h1{margin:0;padding:8px 10px;font-size:12px;letter-spacing:.08em;color:#9aa4b2;border-bottom:1px solid rgba(255,255,255,.06)}
    .grid2{display:grid;grid-template-columns:1fr auto;gap:6px}
    input,textarea,select,button{background:#10131a;border:1px solid rgba(255,255,255,.12);color:#e5e7eb;border-radius:6px;padding:6px 8px}
    textarea{min-height:96px;resize:vertical}
    .btn{cursor:pointer}
    .righthead{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:6px 10px;border-bottom:1px solid rgba(255,255,255,.06)}
    .tabs{display:flex;gap:12px;font-size:13px}
    .tabs button{background:transparent;border:0;color:#cfd6df;cursor:pointer}
    .tabs .on{color:#fff;font-weight:600}
    .auth{display:flex;align-items:center;gap:8px}
    #overlay{position:absolute;top:16px;left:16px;max-width:36ch;padding:8px 10px;border-radius:8px;background:rgba(15,17,22,.75);backdrop-filter:saturate(1.3) blur(6px);border:1px solid rgba(255,255,255,.12);display:none}
    #overlay .ob{margin-top:6px;color:#cbd5e1}
    #capList{height:220px;overflow:auto}
    .caprow{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;cursor:pointer}
    .caprow:hover{background:rgba(255,255,255,.06)}
    .caprow .dot{width:10px;height:10px;border-radius:50%}
    .pin-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    #pinPalette{display:flex;gap:8px}
    #pinPalette .sw{width:18px;height:18px;border-radius:50%;border:1px solid rgba(255,255,255,.25);opacity:.75}
    #pinPalette .sw.active{outline:2px solid #fff;opacity:1}
    #pinFilterToggles{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    #pinFilterToggles label{display:flex;align-items:center;gap:6px}
    #leader{position:absolute;inset:0;pointer-events:none}
  </style>
</head>
<body>
  <div class="app">
    <!-- Left: Viewer -->
    <section class="viewer" id="viewerHost">
      <canvas id="glcanvas"></canvas>
      <svg id="leader" width="0" height="0">
        <line id="leaderLine" x1="0" y1="0" x2="0" y2="0" stroke="#89f" stroke-width="1.5" opacity="0"/>
      </svg>
      <div id="overlay"></div>
    </section>

    <!-- Right: Panel -->
    <aside class="panel">
      <div class="righthead">
        <div class="tabs">
          <button class="on">Caption</button>
          <button disabled>Material</button>
          <button disabled>View</button>
        </div>
        <div class="auth">
          <button id="btnAuth" class="btn">Sign in</button>
        </div>
      </div>

      <h1>Caption</h1>

      <div class="row grid2">
        <input id="glbInput" placeholder="Drive File ID or URL" />
        <button id="btnLoad" class="btn">GLB</button>
      </div>

      <div class="row grid2">
        <select id="sheetSelect"></select>
        <button id="btnNewSheet" class="btn">＋</button>
      </div>

      <div class="row pin-row">
        <div id="pinPalette" aria-label="Pin color palette"></div>
      </div>

      <div class="row">
        <div id="pinFilterToggles"></div>
      </div>

      <div class="row">
        <div id="capList"></div>
      </div>

      <div class="row">
        <label>Title</label>
        <input id="capTitle" placeholder="Title" />
      </div>
      <div class="row">
        <label>Body</label>
        <textarea id="capBody" placeholder="Body"></textarea>
      </div>

      <div class="row grid2">
        <button id="btnAddPin" class="btn">+ Pin</button>
        <button id="btnRefresh" class="btn">Refresh images</button>
      </div>

      <div class="row">
        <div id="imgGrid" class="img-grid"></div>
      </div>
    </aside>
  </div>

  <!-- Scripts (Three.js は各モジュール内で1回だけ読み込まれる想定) -->
  <script type="module" src="./viewer.js?v=20251005"></script>
  <script type="module">
    import { setupPins } from './pins.js?v=20251005';
    import { ensureViewer } from './viewer.js?v=20251005';

    const app = {
      state: { currentGLBId: null },
      viewer: await ensureViewer({
        host: document.getElementById('viewerHost'),
        canvas: document.getElementById('glcanvas'),
      })
    };

    document.getElementById('btnLoad').addEventListener('click', async ()=>{
      const v = document.getElementById('glbInput').value.trim();
      if (!v) { alert('GLB の Drive URL または FileID を入力してください'); return; }
      const id = v.includes('/') ? (new URL(v)).searchParams.get('id') || v.split('/').pop() : v;
      app.state.currentGLBId = id;
      await app.viewer.loadGLBFromDrive(id);
      window.dispatchEvent(new CustomEvent('lmy:model-loaded'));
    });

    document.getElementById('btnAuth').addEventListener('click', ()=> {
      console.log('[auth] clicked');
    });

    setupPins(app);
  </script>
</body>
</html>
