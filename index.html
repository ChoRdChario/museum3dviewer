<!DOCTYPE html>

<html lang="ja">
<head>
<!-- ESM import map for THREE (and addons) -->
<script id="lm-importmap-three" type="importmap">{
  "imports": {
    "three": "https://unpkg.com/three@0.159.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.159.0/examples/jsm/"
  }
}</script>
<!-- Minimal fallback styles while leader.css/app.css are missing -->
<style id="lm-fallback-style">
  :root { color-scheme: dark; }
  body { margin:0; background:#111; color:#e6e6e6; font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
  #right { width:360px; max-width:38vw; padding:12px; box-sizing:border-box; }
  .panel { background:#16181b; border:1px solid #272a30; border-radius:10px; padding:12px; margin:12px 0; }
  .panel h4 { margin:0 0 8px; font-weight:600; opacity:.9; }
  select, input[type="text"], input[type="color"] {
    background:#0f1317; color:#e6e6e6; border:1px solid #2a2f36; border-radius:8px; padding:8px 10px;
  }
  input[type="range"] { width:100%; }
  .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .row .grow { flex:1 1 180px; }
  .muted { color:#9aa4af; font-size:12px; }
</style>
<!-- Optional loader for content.js to avoid 404 -->
<script id="lm-optional-contentjs">
(function(){
  try {
    var url = './content.js';
    fetch(url, {method:'HEAD'}).then(function(r){
      if (r && r.ok) {
        var s = document.createElement('script');
        s.src = url; s.defer = true;
        s.onload = function(){ console.log('[VSC] Content script initialized (optional)'); };
        document.head.appendChild(s);
      } else {
        console.log('[VSC] content.js not present (skipped)');
      }
    }).catch(function(){ console.log('[VSC] content.js check skipped'); });
  } catch(e){
    console.log('[VSC] content.js loader error', e);
  }
})();
</script>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>LociMyu v6.6 (ESM/CDN)</title>
<link href="data:," rel="icon"/>
<!-- Google OAuth (keys are read by boot.esm.cdn.js) -->
<meta content="595200751510-ncahnf7edci6b9925becn5to49r6cguv.apps.googleusercontent.com" name="google-oauth-client_id"/>
<meta content="AIzaSyCUnTCr5yWUWPdEXST9bKP1LpgawU5rIbI" name="google-api-key"/>
<script async="" defer="" src="https://accounts.google.com/gsi/client"></script>
<style>
    :root{
      --bg:#0f1115; --panel:#0b0d11; --line:#1f2937; --acc:#94a3b8; --text:#cbd5e1; --sel:#60a5fa;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    #app{display:flex;height:100%;}
    #stage{flex:1;position:relative;background:var(--panel);}
    #ui{width:360px;max-width:360px;min-width:320px;border-left:1px solid var(--line);
        display:flex;flex-direction:column;overflow:hidden;}
    header#topbar{display:flex;justify-content:space-between;align-items:center;
      padding:8px 12px;border-bottom:1px solid var(--line);}
    header #brand{font-weight:600;opacity:.85}
    button,select,input{background:#111827;border:1px solid var(--line);color:var(--text);
      border-radius:8px;padding:6px 8px}
    input[type="text"]{width:100%;box-sizing:border-box}
    .row{display:flex;gap:8px;align-items:center}
    .row > *{flex:1}
    .tabs{display:flex;border-bottom:1px solid var(--line)}
    .tabs button{flex:1;border:0;border-bottom:2px solid transparent;padding:8px 12px;
      background:transparent;color:var(--acc);cursor:pointer}
    .tabs button[aria-selected="true"]{color:var(--text);border-bottom-color:#64748b}
    .pane{display:none;padding:12px;overflow:auto;max-width:100%;box-sizing:border-box}
    .pane[data-active="true"]{display:block}
    #gl{width:100%;height:100%;display:block}
    .pad{padding:12px}
    .grp{margin:10px 0}
    .hint{opacity:.7;font-size:12px}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{width:18px;height:18px;border-radius:50%;border:1px solid #0003;cursor:pointer;box-shadow:0 0 0 1px #0004 inset}
    #caption-list{height:160px;overflow:auto;border:1px solid var(--line);border-radius:8px}

    /* Material pane layout */
    .mat-grid{display:grid;grid-template-columns: 1fr; gap:12px; max-width:100%}
    .mat-card{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0c1016}
    .mat-card h4{margin:0 0 8px 0;font-size:13px;opacity:.8}
    .mat-row{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center}
    .nowrap{white-space:nowrap}
    .full{text-align:left;width:100%}
    .inline{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    #pm-opacity{display:grid;grid-template-columns: 1fr auto 48px;gap:10px;align-items:center}
    #pm-opacity output{min-width:3ch;text-align:right;opacity:.8}
    /* Prevent horizontal scroll in the right panel */
    #ui *{max-width:100%}
    #ui{overflow-x:hidden}
  </style>
<!-- ESM import map (viewer uses these) -->

<style id="lm-material-layout-fix">
/* ===== Material pane: overflow & wrapping fixes ===== */
#pane-material .scroller {
  overflow-x: hidden;
}

#pane-material .mat-card {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#pane-material .row,
#pane-material .inline,
#pane-material .pair,
#pane-material .controls {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

#pane-material .row > *,
#pane-material .controls > * {
  min-width: 0;
}

#pane-material select,
#pane-material input[type="range"],
#pm-material,
#pm-chroma-tol,
#pm-chroma-feather {
  flex: 1 1 100%;
  width: 100%;
  max-width: 100%;
}

#pane-material .btn,
#pane-material .switch,
#pane-material .mini {
  flex: 0 0 auto;
}

#pm-chroma .tol-row { display: flex; flex-wrap: wrap; gap: 8px; }
#pm-chroma .feather-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; }
</style>
</head>
<body>
<div id="app">
<div id="stage"><canvas id="gl"></canvas></div>
<aside id="ui">
<header id="topbar">
<div id="brand">LociMyu v6.6</div>
<div class="row" style="gap:6px;flex:0 0 auto">
<button id="auth-signin">Sign in</button>
</div>
</header>
<div class="pad" style="border-bottom:1px solid var(--line)">
<div class="row">
<input id="glbUrl" placeholder="Drive fileId / GLB URL" type="text"/>
<button id="btnGlb">Load</button>
</div>
<div class="row" style="margin-top:8px">
<select id="save-target-sheet"><option value="">Select sheet…</option></select>
<button id="save-target-create">Create</button>
</div>
</div>
<nav class="tabs" role="tablist">
<button aria-selected="true" data-tab="caption" id="tab-caption" role="tab">Caption</button>
<button aria-selected="false" data-tab="material" id="tab-material" role="tab">Material</button>
<button aria-selected="false" data-tab="views" id="tab-views" role="tab">Views</button>
</nav>
<!-- Caption pane (unchanged structure) -->
<section class="pane" data-active="true" data-pane="caption" id="pane-caption">
<div class="grp">
<div class="hint">Pin color</div>
<div class="chips" id="pinColorChips"></div>
</div>
<div class="grp">
<div class="hint">Filter</div>
<div class="chips" id="pinFilterChips"></div>
</div>
<div class="grp">
<div class="hint">Caption list</div>
<div id="caption-list"></div>
</div>
<div class="grp">
<div class="hint">Title / Body</div>
<input id="caption-title" placeholder="Title"/>
<input id="caption-body" placeholder="Body"/>
</div>
<div class="grp">
<div class="hint">Images (auto from GLB folder)</div>
<div id="images-grid"></div>
<div class="row" style="margin-top:8px">
<button class="full" id="btnRefreshImages">Refresh images</button>
</div>
<div class="hint" id="images-status" style="margin-top:6px"></div>
</div>
</section>
<!-- Material pane (refined) -->
<section class="pane" data-pane="material" id="pane-material">
<div class="mat-grid">
<div class="mat-card">
<h4>Per‑material opacity (saved per sheet)</h4>
<div id="pm-opacity">
<select aria-label="Select material" id="pm-material">
<option value="">— Select material —</option>
</select>
<input id="pm-opacity-range" max="1" min="0" step="0.01" type="range" value="1"/>
<output id="pm-opacity-val">1.00</output>
</div>
<div class="hint">Pick a material, then set its opacity. This does not change global opacity above.</div>
</div>
<div class="mat-card">
<h4>Shading</h4>
<div class="inline">
<label class="nowrap"><input id="pm-flag-doublesided" type="checkbox"/> Double‑sided</label>
<label class="nowrap"><input id="pm-flag-unlit" type="checkbox"/> Unlit‑like</label>
</div>
</div>
<div class="mat-card">
<h4>Chroma key</h4>
<!-- Row 1: Enable + Color -->
<div class="inline" style="margin-bottom:8px">
<label class="nowrap"><input id="pm-chroma-enable" type="checkbox"/> Enable</label>
<input aria-label="Color" id="pm-chroma-color" type="color" value="#000000"/>
</div>
<!-- Row 2: Tolerance -->
<div class="mat-row" style="margin-bottom:6px">
<span class="nowrap">Tolerance</span>
<input id="pm-chroma-tol" max="1" min="0" step="0.01" type="range" value="0.10"/>
</div>
<!-- Row 3: Feather -->
<div class="mat-row">
<span class="nowrap">Feather</span>
<input id="pm-chroma-feather" max="1" min="0" step="0.01" type="range" value="0.00"/>
</div>
</div>
</div>
</section>
<section class="pane" data-pane="views" id="pane-views">
<div class="grp">
<button id="view-save">Save view</button>
<div class="row"><label><input id="proj-ortho" type="checkbox"> Orthographic</input></label></div>
</div>
<div id="views-preset-list"></div>
</section>
</aside>
</div>
<!-- Tabs behavior -->
<script>
    (function(){
      const tabs = document.querySelectorAll('[role="tab"]');
      const panes = document.querySelectorAll('.pane');
      tabs.forEach(t => t.addEventListener('click', () => {
        tabs.forEach(x => x.setAttribute('aria-selected', String(x===t)));
        panes.forEach(p => p.dataset.active = String(p.dataset.pane===t.dataset.tab));
      }));
    })();
  </script>
<!-- Boot runtime -->
<script src="./boot.esm.cdn.js" type="module"></script>
<link href="app.sheet-rename.css" rel="stylesheet"/>
<script src="sheet-rename.module.js" type="module"></script>
<!-- Event bridge: emit lm:sheet-context / lm:sheet-changed (Approach A) -->
<script defer="" src="./sheet.ctx.bridge.js"></script>
<!-- Keep existing modules (they listen to our custom events if needed) -->
<script src="./viewer.bridge.module.js" type="module"></script>
<script src="./material.orchestrator.js" type="module"></script>

    <!-- LociMyu material bridge stack -->
    <!-- LociMyu: scene bridge + sheet bridge + orchestrator (order matters) -->
    <script type="module" src="./viewer.bridge.module.js"></script>
    <script type="module" src="./materials.sheet.bridge.js"></script>
    <script type="module" src="./material.orchestrator.js"></script>

<!-- lm-inline v9: URL入力とGLBロード配線、Material vNext 安定化、浮遊UI抑止 -->
<style id="lm-inline-v9-style">
  #glbUrl, input[placeholder*="GLB URL" i], input[placeholder*="Drive fileId" i] {
    pointer-events: auto !important;
  }
  #right .lm-z1 { position: relative; z-index: 1; }
  .lm-rogue-mat { display: none !important; }
</style>

<script>
(() => {
  const TAG = '[lm-inline v9]';
  const log  = (...a)=>console.log(TAG, ...a);
  const warn = (...a)=>console.warn(TAG, ...a);

  function onReady(fn){
    if (document.readyState === 'complete' || document.readyState === 'interactive') { fn(); }
    else document.addEventListener('DOMContentLoaded', fn, { once:true });
  }

  function enableUrlInput(){
    const right = document.querySelector('#right') || document.querySelector('aside, .right, .sidebar') || document.body;
    const url = document.querySelector('#glbUrl, input[placeholder*="GLB URL" i], input[placeholder*="Drive fileId" i]');
    if (!right || !url){ warn('url input not found'); return; }

    const wrap = url.closest('section, .card, .panel, .group, form, div') || url.parentElement;
    if (wrap){
      if (getComputedStyle(wrap).position === 'static') wrap.style.position = 'relative';
      wrap.classList.add('lm-z1');
    }
    url.disabled = false;
    url.readOnly = false;
    url.style.pointerEvents = 'auto';
    url.tabIndex = 0;

    const r = url.getBoundingClientRect();
    const pt = { x: r.left + Math.min(120, r.width/2), y: r.top + 12 };
    const chain = document.elementsFromPoint(pt.x, pt.y);
    let killed = 0;
    for (const el of chain){
      if (!right.contains(el)) continue;
      const cs = getComputedStyle(el);
      const fixedLike = cs.position === 'fixed' || cs.position === 'absolute' || cs.position === 'sticky';
      if (fixedLike && cs.pointerEvents !== 'none' && parseInt(cs.zIndex||'0',10) >= 10 && el !== url){
        el.style.pointerEvents = 'none';
        killed++;
      }
      if (el === url) break;
    }
    log('url input enabled; overlays disabled:', killed);
  }

  function hideRogueMaterialUI(){
    const right = document.querySelector('#right, aside, .right, .sidebar') || document.body;
    const rigs = [...document.querySelectorAll('section, .card, .panel, .group')];
    let hid = 0;
    for (const el of rigs){
      if (right.contains(el)) continue;
      const hasSelect = !!el.querySelector('select');
      const hasRange  = !!el.querySelector('input[type="range"]');
      const txt = (el.textContent || '').toLowerCase();
      const looksLikeMaterial = (txt.includes('material') || txt.includes('opacity')) && hasSelect && hasRange;
      if (!looksLikeMaterial) continue;
      const cs = getComputedStyle(el);
      const floaty = (cs.position === 'fixed' || cs.position === 'absolute' || cs.position === 'sticky');
      if (floaty){
        el.classList.add('lm-rogue-mat');
        hid++;
      }
    }
    log('rogue material UI hidden:', hid);
  }

  function bindGlbLoader(){
    const right = document.querySelector('#right') || document.querySelector('aside, .right, .sidebar') || document.body;
    const url = document.querySelector('#glbUrl, input[placeholder*="GLB URL" i], input[placeholder*="Drive fileId" i]');
    const loadBtn = [...right.querySelectorAll('button, .btn, [role="button"]')].find(b => (b.textContent||'').trim().toLowerCase() === 'load');
    if (!url || !loadBtn){ warn('glb loader wiring failed (url or load button missing)'); return; }

    function parseInput(v){
      const s = (v||'').trim();
      if (!s) return { kind:'empty' };
      const m = s.match(/[-\w]{25,}/);
      if (/drive\.google\.com/.test(s) && m) return { kind:'drive', fileId: m[0] };
      if (/\.glb(\?.*)?$/i.test(s)) return { kind:'glb', href: s };
      if (/^[-\w]{25,}$/.test(s)) return { kind:'drive', fileId: s };
      return { kind:'unknown', raw:s };
    }

    async function run(){
      const v = url.value;
      const parsed = parseInput(v);
      log('glb-loader parsed', parsed);
      if (parsed.kind === 'empty'){ warn('invalid GLB input'); return; }

      if (parsed.kind === 'drive' && typeof window.loadFromDrive === 'function'){
        window.loadFromDrive(parsed.fileId);
      } else if (parsed.kind === 'glb' && typeof window.loadGLB === 'function'){
        window.loadGLB(parsed.href);
      } else if (typeof window.doLoad === 'function'){
        window.doLoad();
      } else {
        loadBtn.click();
      }
    }

    loadBtn.addEventListener('click', (e)=>{ setTimeout(run, 0); });
    url.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); run(); }});

    let fired = false;
    const fireOnce = () => {
      if (fired) return;
      fired = true;
      window.dispatchEvent(new CustomEvent('pm:scene-deep-ready', { detail:{ scene: (window.__lm_scene||null) } }));
      log('pm:scene-deep-ready emitted (shim)');
    };
    window.addEventListener('lm:viewer-ready', fireOnce, { once:true });
  }

  function bindMaterialVNext(){
    const right = document.querySelector('#right') || document.querySelector('aside, .right, .sidebar') || document.body;

    function findControls(){
      const cards = [
        ...right.querySelectorAll('[data-section="perMaterialOpacity"], #lm-per-material, section, .card, .panel, .group')
      ];
      for (const c of cards){
        const sel = c.querySelector('select');
        const rng = c.querySelector('input[type="range"]');
        if (sel && rng) return { sel, rng, card:c };
      }
      return { sel:null, rng:null };
    }

    function isGLBName(n){
      if (!n) return false;
      if (/^mesh.*material$/i.test(n)) return false;
      if (/^material(\.\d+)?$/i.test(n)) return false;
      if (n.startsWith('__') || n.startsWith('LM_')) return false;
      return true;
    }

    function collectByName(scene){
      const map = new Map();
      scene?.traverse?.(o=>{
        if (!o?.isMesh) return;
        (Array.isArray(o.material)?o.material:[o.material]).forEach(m=>{
          const name = (m?.name||'').trim();
          if (!isGLBName(name)) return;
          if (!map.has(name)) map.set(name, []);
          map.get(name).push(m);
        });
      });
      return map;
    }

    function populate(sel, nameMap){
      sel.innerHTML = '';
      const names = [...nameMap.keys()].sort((a,b)=>a.localeCompare(b,'ja'));
      if (!names.length){
        const opt = document.createElement('option'); opt.value=''; opt.textContent='(no GLB materials)'; sel.appendChild(opt);
        return 0;
      }
      for (const n of names){
        const opt = document.createElement('option'); opt.value = n; opt.textContent = n; sel.appendChild(opt);
      }
      return names.length;
    }

    function wire(scene, sel, rng, nameMap){
      const apply = ()=>{
        const key = sel.value; if (!key) return;
        const v = parseFloat(rng.value);
        const mats = nameMap.get(key) || [];
        for (const m of mats){
          m.transparent = (v < 1.0) || m.transparent;
          m.opacity = v;
          if ('needsUpdate' in m) m.needsUpdate = true;
        }
        window.dispatchEvent(new CustomEvent('lm:material-opacity-changed', { detail:{ materialKey:key, value:v } }));
      };
      rng.addEventListener('input', apply);
      sel.addEventListener('change', ()=> rng.dispatchEvent(new Event('input')));
      rng.dispatchEvent(new Event('input'));
    }

    async function hydrate(scene){
      const { sel, rng } = findControls();
      if (!sel || !rng){ warn('material controls missing'); return; }
      await Promise.resolve();
      const nameMap = collectByName(scene);
      const n = populate(sel, nameMap);
      if (!n){ log('no GLB materials'); return; }
      wire(scene, sel, rng, nameMap);
      log('materials populated', n);
    }

    window.addEventListener('pm:scene-deep-ready', (e)=>{
      const scene = e?.detail?.scene || window.__lm_scene || null;
      if (!scene){ warn('deep-ready without scene'); return; }
      hydrate(scene);
    });
  }

  onReady(() => {
    hideRogueMaterialUI();
    enableUrlInput();
    bindGlbLoader();
    bindMaterialVNext();
  });
})();
</script>

<!-- lm-inline v11: GLB loader wire + material populate (safe, no extra UI) -->
<script>
(() => {
  const TAG = '[lm-inline v11]';
  const log  = (...a)=>console.log(TAG, ...a);
  const warn = (...a)=>console.warn(TAG, ...a);

  // ---------- URL input & Load button binding ----------
  function findRightPane() {
    return document.querySelector('#right') ||
           document.querySelector('aside, .right, .sidebar') || document.body;
  }

  function findUrlAndLoad() {
    const root = findRightPane();
    const url = document.querySelector('#glbUrl') ||
      root.querySelector('input[type="text"], input:not([type]), input[type="url"]');
    // Pick a nearby "Load" button (same card/section)
    let load = null;
    if (url) {
      const card = url.closest('section, .card, .panel, .group, form, div') || root;
      load = [...card.querySelectorAll('button,.btn,[role="button"]')]
        .find(b => (b.textContent||'').trim().toLowerCase() === 'load') || null;
    }
    if (!load) {
      // fallback: any Load within right pane
      load = [...root.querySelectorAll('button,.btn,[role="button"]')]
        .find(b => (b.textContent||'').trim().toLowerCase() === 'load') || null;
    }
    return {url, load};
  }

  function parseGlbInput(v) {
    const t = (v||'').trim();
    if (!t) return {kind:'empty'};
    // Drive fileId
    const m = t.match(/[-\w]{25,}/);
    if (/drive\.google\.com|id=/.test(t) && m) return {kind:'drive', fileId:m[0]};
    if (/^[\w-]{25,}$/.test(t)) return {kind:'drive', fileId:t};
    // direct GLB
    if (/\.glb(\?.*)?$/i.test(t)) return {kind:'url', url:t};
    return {kind:'unknown', raw:t};
  }

  function ensureClickableUrl(url) {
    if (!url) return;
    url.disabled = false;
    url.readOnly = false;
    url.style.pointerEvents = 'auto';
    // bring to front carefully
    const wrap = url.closest('section, .card, .panel, .group, form, div') || url.parentElement;
    if (wrap) {
      const cs = getComputedStyle(wrap);
      if (cs.position === 'static') wrap.style.position = 'relative';
      wrap.style.zIndex = '10';
    }
  }

  function wireGlbLoader() {
    const {url, load} = findUrlAndLoad();
    ensureClickableUrl(url);
    if (!url || !load) { warn('url/load not found'); return; }

    const run = () => {
      const parsed = parseGlbInput(url.value);
      log('glb parsed', parsed);
      if (parsed.kind === 'drive' && window.doLoad) {
        try { window.doLoad(parsed.fileId); } catch(e){ warn('doLoad failed', e); }
      } else if (parsed.kind === 'url' && window.doLoadUrl) {
        try { window.doLoadUrl(parsed.url); } catch(e){ warn('doLoadUrl failed', e); }
      } else if (window.doLoad) {
        // let the app handle raw value; some builds expect full URL
        try { window.doLoad(url.value); } catch(e){ warn('doLoad(raw) failed', e); }
      } else {
        warn('no loader API available');
      }
    };

    // prevent duplicate bindings
    load.__lm_wired || load.addEventListener('click', run, {passive:true});
    load.__lm_wired = true;
    url.__lm_wired  || url.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') { e.preventDefault(); run(); }
    });
    url.__lm_wired = true;

    log('glb loader wired');
  }

  // ---------- Material populate (name-based) ----------
  const isGLBName = (n)=>{
    if (!n) return false;
    if (/^mesh.*material$/i.test(n)) return false;
    if (/^material(\.\d+)?$/i.test(n)) return false;
    if (n.startsWith('__') || n.startsWith('LM_')) return false;
    return true;
  };

  function findMaterialControlsStrict() {
    const root = findRightPane();
    // Pane "Material" only
    const pane =
      root.querySelector('#pane-material, [data-tab="material"], .tab-material') || root;
    // Try to find card that contains "Per-material opacity"
    const cards = [...pane.querySelectorAll('section,.card,.panel,.group')];
    const card = cards.find(c => /per[\s-]?material.*opacity/i.test(c.textContent||'')) || pane;
    const sel = card.querySelector('select') || document.getElementById('materialSelect');
    const rng = card.querySelector('input[type="range"]') || document.getElementById('opacityRange');
    return {pane, card, sel, rng};
  }

  function collectByName(scene){
    const map = new Map();
    scene?.traverse?.(o=>{
      if (!o?.isMesh) return;
      (Array.isArray(o.material)?o.material:[o.material]).forEach(m=>{
        const name = (m?.name||'').trim();
        if (!isGLBName(name)) return;
        if (!map.has(name)) map.set(name, []);
        map.get(name).push(m);
      });
    });
    return map;
  }

  function populateSelect(sel, nameMap){
    if (!sel) return 0;
    sel.innerHTML = '';
    const names = [...nameMap.keys()].sort((a,b)=>a.localeCompare(b, 'ja'));
    if (!names.length) {
      const opt = document.createElement('option');
      opt.value=''; opt.textContent='(no GLB materials)';
      sel.appendChild(opt); return 0;
    }
    for (const nm of names){
      const opt = document.createElement('option');
      opt.value = nm; opt.textContent = nm;
      sel.appendChild(opt);
    }
    return names.length;
  }

  function wireOpacity(scene, sel, rng, nameMap){
    if (!sel || !rng) return;
    const apply = ()=>{
      const key = sel.value; if (!key) return;
      const v = parseFloat(rng.value);
      const mats = nameMap.get(key) || [];
      for (const m of mats){
        m.transparent = (v < 1.0) || m.transparent;
        m.opacity = v;
        if ('needsUpdate' in m) m.needsUpdate = true;
      }
      // persistence event (picked up by materials.sheet.bridge.js)
      window.dispatchEvent(new CustomEvent('lm:material-opacity-changed', {
        detail: { materialKey: key, value: v }
      }));
    };
    rng.addEventListener('input', apply);
    sel.addEventListener('change', ()=>rng.dispatchEvent(new Event('input')));
    rng.dispatchEvent(new Event('input'));
  }

  let deepReadyOnce = false;
  async function hydrateFromScene(sceneCandidate){
    const {sel, rng} = findMaterialControlsStrict();
    if (!sel || !rng) { warn('material controls missing'); return; }

    const scene = sceneCandidate ||
      (typeof getScene==='function' && getScene()) ||
      window.__lm_scene || null;
    if (!scene) { warn('scene not ready'); return; }

    // quick mesh check
    let hasMesh=false; try{ scene.traverse(o=>{ if(o?.isMesh) hasMesh=true; }); }catch(_){}
    if (!hasMesh) { warn('scene has no meshes yet'); return; }

    const nameMap = collectByName(scene);
    const n = populateSelect(sel, nameMap);
    if (!n) { log('no GLB materials'); return; }
    wireOpacity(scene, sel, rng, nameMap);
    log('materials populated', n);
  }

  function installDeepReadyListener(){
    // If app dispatches pm:scene-deep-ready, hook it
    window.addEventListener('pm:scene-deep-ready', (e)=>{
      deepReadyOnce = true;
      log('pm:scene-deep-ready observed');
      setTimeout(()=>hydrateFromScene(e?.detail?.scene || null), 0);
    }, {once:false});
    // Fallback polling (if event not fired)
    const tid = setInterval(()=>{
      if (deepReadyOnce) { clearInterval(tid); return; }
      const s = (typeof getScene==='function' && getScene()) || window.__lm_scene || null;
      if (!s) return;
      let hasMesh=false; try{s.traverse(o=>{if(o?.isMesh) hasMesh=true;});}catch(_){}
      if (hasMesh) {
        clearInterval(tid);
        log('deep-ready (polled)');
        hydrateFromScene(s);
      }
    }, 600);
  }

  // ---------- init ----------
  document.addEventListener('DOMContentLoaded', () => {
    // do not create any new UI. Only wire.
    wireGlbLoader();
    installDeepReadyListener();
  });
})();
</script>

</body>
</html>
