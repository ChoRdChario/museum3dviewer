<!DOCTYPE html>

<html lang="ja">
<head>
<!-- ESM import map for THREE (and addons) -->
<script id="lm-importmap-three" type="importmap">{
  "imports": {
    "three": "https://unpkg.com/three@0.159.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.159.0/examples/jsm/"
  }
}</script>
<!-- Minimal fallback styles while leader.css/app.css are missing -->
<style id="lm-fallback-style">
  :root { color-scheme: dark; }
  body { margin:0; background:#111; color:#e6e6e6; font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
  #right { width:360px; max-width:38vw; padding:12px; box-sizing:border-box; }
  .panel { background:#16181b; border:1px solid #272a30; border-radius:10px; padding:12px; margin:12px 0; }
  .panel h4 { margin:0 0 8px; font-weight:600; opacity:.9; }
  select, input[type="text"], input[type="color"] {
    background:#0f1317; color:#e6e6e6; border:1px solid #2a2f36; border-radius:8px; padding:8px 10px;
  }
  input[type="range"] { width:100%; }
  .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .row .grow { flex:1 1 180px; }
  .muted { color:#9aa4af; font-size:12px; }
</style>
<!-- Optional loader for content.js to avoid 404 -->
<script id="lm-optional-contentjs">
(function(){
  try {
    var url = './content.js';
    fetch(url, {method:'HEAD'}).then(function(r){
      if (r && r.ok) {
        var s = document.createElement('script');
        s.src = url; s.defer = true;
        s.onload = function(){ console.log('[VSC] Content script initialized (optional)'); };
        document.head.appendChild(s);
      } else {
        console.log('[VSC] content.js not present (skipped)');
      }
    }).catch(function(){ console.log('[VSC] content.js check skipped'); });
  } catch(e){
    console.log('[VSC] content.js loader error', e);
  }
})();
</script>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>LociMyu v6.6 (ESM/CDN)</title>
<link href="data:," rel="icon"/>
<!-- Google OAuth (keys are read by boot.esm.cdn.js) -->
<meta content="595200751510-ncahnf7edci6b9925becn5to49r6cguv.apps.googleusercontent.com" name="google-oauth-client_id"/>
<meta content="AIzaSyCUnTCr5yWUWPdEXST9bKP1LpgawU5rIbI" name="google-api-key"/>
<script async="" defer="" src="https://accounts.google.com/gsi/client"></script>
<style>
    :root{
      --bg:#0f1115; --panel:#0b0d11; --line:#1f2937; --acc:#94a3b8; --text:#cbd5e1; --sel:#60a5fa;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    #app{display:flex;height:100%;}
    #stage{flex:1;position:relative;background:var(--panel);}
    #ui{width:360px;max-width:360px;min-width:320px;border-left:1px solid var(--line);
        display:flex;flex-direction:column;overflow:hidden;}
    header#topbar{display:flex;justify-content:space-between;align-items:center;
      padding:8px 12px;border-bottom:1px solid var(--line);}
    header #brand{font-weight:600;opacity:.85}
    button,select,input{background:#111827;border:1px solid var(--line);color:var(--text);
      border-radius:8px;padding:6px 8px}
    input[type="text"]{width:100%;box-sizing:border-box}
    .row{display:flex;gap:8px;align-items:center}
    .row > *{flex:1}
    .tabs{display:flex;border-bottom:1px solid var(--line)}
    .tabs button{flex:1;border:0;border-bottom:2px solid transparent;padding:8px 12px;
      background:transparent;color:var(--acc);cursor:pointer}
    .tabs button[aria-selected="true"]{color:var(--text);border-bottom-color:#64748b}
    .pane{display:none;padding:12px;overflow:auto;max-width:100%;box-sizing:border-box}
    .pane[data-active="true"]{display:block}
    #gl{width:100%;height:100%;display:block}
    .pad{padding:12px}
    .grp{margin:10px 0}
    .hint{opacity:.7;font-size:12px}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{width:18px;height:18px;border-radius:50%;border:1px solid #0003;cursor:pointer;box-shadow:0 0 0 1px #0004 inset}
    #caption-list{height:160px;overflow:auto;border:1px solid var(--line);border-radius:8px}

    /* Material pane layout */
    .mat-grid{display:grid;grid-template-columns: 1fr; gap:12px; max-width:100%}
    .mat-card{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0c1016}
    .mat-card h4{margin:0 0 8px 0;font-size:13px;opacity:.8}
    .mat-row{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center}
    .nowrap{white-space:nowrap}
    .full{text-align:left;width:100%}
    .inline{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    #pm-opacity{display:grid;grid-template-columns: 1fr auto 48px;gap:10px;align-items:center}
    #pm-opacity output{min-width:3ch;text-align:right;opacity:.8}
    /* Prevent horizontal scroll in the right panel */
    #ui *{max-width:100%}
    #ui{overflow-x:hidden}
  </style>
<!-- ESM import map (viewer uses these) -->

<style id="lm-material-layout-fix">
/* ===== Material pane: overflow & wrapping fixes ===== */
#pane-material .scroller {
  overflow-x: hidden;
}

#pane-material .mat-card {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#pane-material .row,
#pane-material .inline,
#pane-material .pair,
#pane-material .controls {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

#pane-material .row > *,
#pane-material .controls > * {
  min-width: 0;
}

#pane-material select,
#pane-material input[type="range"],
#pm-material,
#pm-chroma-tol,
#pm-chroma-feather {
  flex: 1 1 100%;
  width: 100%;
  max-width: 100%;
}

#pane-material .btn,
#pane-material .switch,
#pane-material .mini {
  flex: 0 0 auto;
}

#pm-chroma .tol-row { display: flex; flex-wrap: wrap; gap: 8px; }
#pm-chroma .feather-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; }
</style>
</head>
<body>
<div id="app">
<div id="stage"><canvas id="gl"></canvas></div>
<aside id="ui">
<header id="topbar">
<div id="brand">LociMyu v6.6</div>
<div class="row" style="gap:6px;flex:0 0 auto">
<button id="auth-signin">Sign in</button>
</div>
</header>
<div class="pad" style="border-bottom:1px solid var(--line)">
<div class="row">
<input id="glbUrl" placeholder="Drive fileId / GLB URL" type="text"/>
<button id="btnGlb">Load</button>
</div>
<div class="row" style="margin-top:8px">
<select id="save-target-sheet"><option value="">Select sheet…</option></select>
<button id="save-target-create">Create</button>
</div>
</div>
<nav class="tabs" role="tablist">
<button aria-selected="true" data-tab="caption" id="tab-caption" role="tab">Caption</button>
<button aria-selected="false" data-tab="material" id="tab-material" role="tab">Material</button>
<button aria-selected="false" data-tab="views" id="tab-views" role="tab">Views</button>
</nav>
<!-- Caption pane (unchanged structure) -->
<section class="pane" data-active="true" data-pane="caption" id="pane-caption">
<div class="grp">
<div class="hint">Pin color</div>
<div class="chips" id="pinColorChips"></div>
</div>
<div class="grp">
<div class="hint">Filter</div>
<div class="chips" id="pinFilterChips"></div>
</div>
<div class="grp">
<div class="hint">Caption list</div>
<div id="caption-list"></div>
</div>
<div class="grp">
<div class="hint">Title / Body</div>
<input id="caption-title" placeholder="Title"/>
<input id="caption-body" placeholder="Body"/>
</div>
<div class="grp">
<div class="hint">Images (auto from GLB folder)</div>
<div id="images-grid"></div>
<div class="row" style="margin-top:8px">
<button class="full" id="btnRefreshImages">Refresh images</button>
</div>
<div class="hint" id="images-status" style="margin-top:6px"></div>
</div>
</section>
<!-- Material pane (refined) -->
<section class="pane" data-pane="material" id="pane-material">
<div class="mat-grid">
<div class="mat-card">
<h4>Per‑material opacity (saved per sheet)</h4>
<div id="pm-opacity">
<select aria-label="Select material" id="pm-material">
<option value="">— Select material —</option>
</select>
<input id="pm-opacity-range" max="1" min="0" step="0.01" type="range" value="1"/>
<output id="pm-opacity-val">1.00</output>
</div>
<div class="hint">Pick a material, then set its opacity. This does not change global opacity above.</div>
</div>
<div class="mat-card">
<h4>Shading</h4>
<div class="inline">
<label class="nowrap"><input id="pm-flag-doublesided" type="checkbox"/> Double‑sided</label>
<label class="nowrap"><input id="pm-flag-unlit" type="checkbox"/> Unlit‑like</label>
</div>
</div>
<div class="mat-card">
<h4>Chroma key</h4>
<!-- Row 1: Enable + Color -->
<div class="inline" style="margin-bottom:8px">
<label class="nowrap"><input id="pm-chroma-enable" type="checkbox"/> Enable</label>
<input aria-label="Color" id="pm-chroma-color" type="color" value="#000000"/>
</div>
<!-- Row 2: Tolerance -->
<div class="mat-row" style="margin-bottom:6px">
<span class="nowrap">Tolerance</span>
<input id="pm-chroma-tol" max="1" min="0" step="0.01" type="range" value="0.10"/>
</div>
<!-- Row 3: Feather -->
<div class="mat-row">
<span class="nowrap">Feather</span>
<input id="pm-chroma-feather" max="1" min="0" step="0.01" type="range" value="0.00"/>
</div>
</div>
</div>
</section>
<section class="pane" data-pane="views" id="pane-views">
<div class="grp">
<button id="view-save">Save view</button>
<div class="row"><label><input id="proj-ortho" type="checkbox"> Orthographic</input></label></div>
</div>
<div id="views-preset-list"></div>
</section>
</aside>
</div>
<!-- Tabs behavior -->
<script>
    (function(){
      const tabs = document.querySelectorAll('[role="tab"]');
      const panes = document.querySelectorAll('.pane');
      tabs.forEach(t => t.addEventListener('click', () => {
        tabs.forEach(x => x.setAttribute('aria-selected', String(x===t)));
        panes.forEach(p => p.dataset.active = String(p.dataset.pane===t.dataset.tab));
      }));
    })();
  </script>
<!-- Boot runtime -->
<script src="./boot.esm.cdn.js" type="module"></script>
<link href="app.sheet-rename.css" rel="stylesheet"/>
<script src="sheet-rename.module.js" type="module"></script>
<!-- Event bridge: emit lm:sheet-context / lm:sheet-changed (Approach A) -->
<script defer="" src="./sheet.ctx.bridge.js"></script>
<!-- Keep existing modules (they listen to our custom events if needed) -->
<script src="./viewer.bridge.module.js" type="module"></script>
<script src="./material.orchestrator.js" type="module"></script>

    <!-- LociMyu material bridge stack -->
    <!-- LociMyu: scene bridge + sheet bridge + orchestrator (order matters) -->
    <script type="module" src="./viewer.bridge.module.js"></script>
    <script type="module" src="./materials.sheet.bridge.js"></script>
    <script type="module" src="./material.orchestrator.js"></script>

<!-- LM MATERIAL ADAPTER vNext: GLB-only material list + Sheets bridge shim -->
<script type="module">
// ===== pm-bridge v6b + sheets-bridge shim (inline) =====
(() => {
  const dbg = (...a)=>console.log("[lm-mat-vNext]", ...a);
  const warn = (...a)=>console.warn("[lm-mat-vNext]", ...a);

  // ---------- Scene wait ----------
  async function waitForSceneReady({timeoutMs=8000}={}) {
    const t0 = performance.now();
    const hasMeshes = (s)=>{ let n=0; try{ s?.traverse?.(o=>{ if (o?.isMesh) n++; }); }catch(_){ } return n>0; };
    if (window.__lm_last_deep_scene && hasMeshes(window.__lm_last_deep_scene)) return window.__lm_last_deep_scene;
    while (performance.now()-t0 < timeoutMs) {
      try{
        const s = (typeof window.getScene==='function' && window.getScene()) || window.__lm_scene || null;
        if (s && hasMeshes(s)) return s;
      }catch(_){}
      const p = new Promise(res=>{
        const once = e=>{ window.removeEventListener('pm:scene-deep-ready', once); res(e?.detail?.scene||null); };
        window.addEventListener('pm:scene-deep-ready', once, {once:true});
        setTimeout(()=>{ try{ window.removeEventListener('pm:scene-deep-ready', once);}catch(_){ } res(null); }, 300);
      });
      const ev = await p;
      if (ev && hasMeshes(ev)) return ev;
    }
    warn("scene not ready (timeout)");
    return null;
  }

  // ---------- GLB material filter ----------
  function isGLBMaterial(m){
    if (!m) return false;
    const n = (m.name||"").trim();
    if (!n) return false;
    if (/^mesh.*material$/i.test(n)) return false;
    if (/^material(\.\d+)?$/i.test(n)) return false;
    if (n.startsWith("__") || n.startsWith("LM_")) return false;
    return true;
  }

  function collectMaterialsByName(scene){
    const map = new Map(); // name -> material[]
    scene?.traverse?.(o=>{
      if (!o?.isMesh) return;
      (Array.isArray(o.material) ? o.material : [o.material]).forEach(m=>{
        if (!isGLBMaterial(m)) return;
        const key = m.name.trim();
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(m);
      });
    });
    return map;
  }

  function uiRefs(){
    const sel = document.getElementById("materialSelect");
    const rng = document.getElementById("opacityRange");
    return {sel, rng, ok: !!sel && !!rng};
  }

  function populateSelect(sel, nameMap){
    sel.innerHTML = "";
    const names = [...nameMap.keys()];
    if (names.length === 0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "(no GLB)";
      sel.appendChild(opt);
      return 0;
    }
    names.sort((a,b)=>a.localeCompare(b, "ja"));
    for (const name of names){
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    }
    return names.length;
  }

  function wireHandlers(sel, rng, nameMap){
    const applyOpacity = ()=>{
      const name = sel.value;
      if (!name) return;
      const v = parseFloat(rng.value);
      const mats = nameMap.get(name) || [];
      for (const m of mats){
        m.transparent = (v < 1.0) || m.transparent;
        m.opacity = v;
        if ("needsUpdate" in m) m.needsUpdate = true;
      }
      // Emit event for sheet bridge (name-based)
      window.dispatchEvent(new CustomEvent("lm:material-opacity-changed", {
        detail: { materialKey: name, value: v }
      }));
    };
    rng.addEventListener("input", applyOpacity);
    sel.addEventListener("change", ()=> rng.dispatchEvent(new Event("input")));
    // initial
    rng.dispatchEvent(new Event("input"));
  }

  async function hydrateOnce(){
    const {sel, rng, ok} = uiRefs();
    if (!ok){ warn("controls missing"); return false; }
    const scene = await waitForSceneReady();
    if (!scene){ warn("scene unavailable"); return false; }
    const nameMap = collectMaterialsByName(scene);
    const n = populateSelect(sel, nameMap);
    wireHandlers(sel, rng, nameMap);
    window.dispatchEvent(new CustomEvent("lm:materials-populated", { detail: { names: [...nameMap.keys()] } }));
    dbg("materials populated (GLB-only)", n);
    return n>0;
  }

  // ---------- Sheets bridge shim ----------
  // 既存の materials.sheet.bridge への呼び出しを吸収。なければキューして待つ。
  const queue = new Map(); // name -> lastValue
  let flushTimer = 0;

  function tryCallBridge(name, value){
    const b = window.materialsSheetBridge || window.__lm_materialsSheetBridge || null;
    if (!b) return false;
    // 候補メソッドを順に試す
    const candidates = [
      "saveOpacity", "setOpacity", "persistOpacity", "save", "persist"
    ];
    for (const fn of candidates){
      if (typeof b[fn] === "function"){
        try {
          b[fn]({ materialKey: name, value });
          return true;
        } catch(e){ console.warn("[lm-mat-vNext] bridge call failed:", fn, e); }
      }
    }
    // イベントで拾うタイプにも対応（最終手段）
    window.dispatchEvent(new CustomEvent("lm:material-opacity-commit", { detail: { materialKey: name, value } }));
    return true;
  }

  function scheduleFlush(){
    if (flushTimer) return;
    flushTimer = window.setTimeout(()=>{
      flushTimer = 0;
      const entries = [...queue.entries()];
      if (!entries.length) return;
      let okAny = false;
      for (const [name, value] of entries){
        const ok = tryCallBridge(name, value);
        okAny = okAny || ok;
        if (ok) queue.delete(name);
      }
      if (!okAny){
        // まだブリッジが来ていない。少し後で再挑戦。
        scheduleFlush();
      }
    }, 200);
  }

  window.addEventListener("lm:material-opacity-changed", (e)=>{
    const { materialKey, value } = e.detail || {};
    if (!materialKey) return;
    queue.set(materialKey, value);
    scheduleFlush();
  });

  // シートコンテキストがバインドされたら即フラッシュ
  window.addEventListener("lm:sheet-context", ()=> scheduleFlush());

  // ---------- boot ----------
  (async () => {
    await hydrateOnce();
    window.addEventListener("pm:scene-deep-ready", ()=> setTimeout(()=>{ hydrateOnce(); }, 0));
  })();
})();
</script>
</body>
</html>
