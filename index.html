<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LociMyu v6.6</title>
  <style>
    :root { --right-w: 360px; --gap: 0px; --bg: #0f1115; --panel:#111521; --text:#d7dce5; --muted:#8892a6; --stroke:#2a3142; }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    #app { display: grid; grid-template-columns: minmax(0,1fr) var(--right-w); grid-template-rows: 100vh; gap: var(--gap); height: 100vh; width: 100vw; overflow: hidden; }
    /* Left viewer area */
    #stage { position: relative; min-width: 0; }
    #viewer { position: absolute; inset: 0; }
    /* Right sidebar */
    #right { min-width: var(--right-w); max-width: var(--right-w); height: 100%; border-left: 1px solid var(--stroke); background: rgba(255,255,255,0.01); overflow: auto; }
    .pad { padding: 10px 12px; }
    /* Toolbar */
    .toolbar { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; align-items: center; }
    .row { display: flex; align-items: center; gap: 8px; }
    input[type="text"], input[type="url"] { width: 100%; background: #0c0f16; color: var(--text); border: 1px solid var(--stroke); border-radius: 8px; padding: 8px 10px; }
    button, .btn { background: #1b2131; color: var(--text); border: 1px solid var(--stroke); border-radius: 10px; padding: 8px 12px; cursor: pointer; }
    button:disabled { opacity: .6; cursor: default; }
    /* Tabs */
    .tabs { display: flex; gap: 8px; padding: 8px 12px 0; position: sticky; top: 0; background: linear-gradient(180deg, rgba(15,17,21,1) 75%, rgba(15,17,21,0)); z-index: 2; }
    .tabs button { padding: 6px 10px; border-radius: 10px; }
    .tabs button.active { outline: 2px solid #2f6feb; }
    .panes { padding: 8px 12px 16px; }
    .pane { display: none; background: var(--panel); border: 1px solid var(--stroke); border-radius: 12px; padding: 12px; }
    .pane.active { display: block; }
    .group { border: 1px solid var(--stroke); border-radius: 12px; padding: 10px; margin: 10px 0; background: rgba(255,255,255,0.02); }
    label { display: block; color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    select, input[type="range"] { width: 100%; }
    /* Guard: never allow form controls inside the tab button row */
    .tabs select, .tabs input, .tabs .group { display: none !important; }
  </style>
</head>
<body>
  <div id="app">
    <!-- Left: viewer -->
    <div id="stage">
      <div id="viewer"><!-- canvas injected by app --></div>
    </div>

    <!-- Right: sidebar -->
    <aside id="right">
      <div class="pad">
        <div class="toolbar row">
          <input id="glbUrl" type="url" placeholder="https://drive.google.com/... or GLB URL" />
          <button id="btnGlb">Load</button>
          <button id="auth-signin">Sign in</button>
        </div>

        <div class="row" style="margin-top:8px; gap:6px;">
          <button id="btnPickSheet">シート1</button>
          <button id="btnPickSheet2">シート1</button>
          <button id="btnCreate">Create</button>
        </div>
      </div>

      <div class="tabs">
        <button id="tab-caption" class="active">Caption</button>
        <button id="tab-material">Material</button>
        <button id="tab-views">Views</button>
      </div>

      <div class="panes">
        <!-- Caption pane: keep as-is; real UI is driven by app scripts -->
        <section id="pane-caption" class="pane active">
          <div class="group">
            <strong>Caption panel</strong> <span style="color:var(--muted); font-size:12px;">(existing UI remains controlled by app scripts)</span>
          </div>
          <div class="group">
            <label>Pin color</label>
            <div id="pinColors"></div>
          </div>
          <div class="group"><label>Filter</label><div id="pinFilters"></div></div>
          <div class="group"><label>Caption list</label><div id="captionList"></div></div>
          <div class="group"><label>Title / Body</label>
            <input id="title" type="text" placeholder="Title" />
            <input id="body" type="text" placeholder="Body" style="margin-top:6px;" />
          </div>
          <div class="group"><label>Images (auto from GLB folder)</label><button id="btnRefresh">Refresh images</button></div>
        </section>

        <!-- Material pane: this is the only place that contains the anchors -->
        <section id="pane-material" class="pane">
          <div class="group">
            <label for="materialSelect">Select material</label>
            <select id="materialSelect"></select>
          </div>
          <div class="group">
            <label for="opacityRange">Per‑material opacity (saved per sheet)</label>
            <input id="opacityRange" type="range" min="0" max="1" step="0.01" value="1.00" />
          </div>

          <div class="group">
            <label>Shading</label>
            <div class="row">
              <label><input type="checkbox" id="chkDoubleSided" /> Double‑sided</label>
              <label><input type="checkbox" id="chkUnlit" /> Unlit‑like</label>
            </div>
          </div>

          <div class="group">
            <label>Chroma key</label>
            <div class="row">
              <label><input type="checkbox" id="chkChromaEnable" /> Enable</label>
              <button id="btnChromaPick">—</button>
            </div>
            <label for="rngTolerance" style="margin-top:6px;">Tolerance</label>
            <input id="rngTolerance" type="range" min="0" max="1" step="0.01" value="0" />
            <label for="rngFeather" style="margin-top:6px;">Feather</label>
            <input id="rngFeather" type="range" min="0" max="1" step="0.01" value="0" />
          </div>
        </section>

        <!-- Views pane placeholder -->
        <section id="pane-views" class="pane">
          <div class="group">Views panel</div>
        </section>
      </div>
    </aside>
  </div>

  <!-- Tabs: minimal, non-invasive -->
  <script>
    (function () {
      const panes = {
        caption: document.getElementById('pane-caption'),
        material: document.getElementById('pane-material'),
        views: document.getElementById('pane-views')
      };
      const tabs = {
        caption: document.getElementById('tab-caption'),
        material: document.getElementById('tab-material'),
        views: document.getElementById('tab-views')
      };
      function show(name){
        for (const k in panes){ panes[k].classList.toggle('active', k===name); }
        for (const k in tabs){ tabs[k].classList.toggle('active', k===name); }
        // Notify orchestrator that pane became visible
        if (name === 'material') {
          window.dispatchEvent(new CustomEvent('lm:pane-material-visible'));
        }
      }
      tabs.caption.addEventListener('click', ()=>show('caption'));
      tabs.material.addEventListener('click', ()=>show('material'));
      tabs.views.addEventListener('click', ()=>show('views'));
    })();
  </script>

  <!-- App scripts (unchanged) -->
  <script type="module" src="boot.esm.cdn.js"></script>
  <script src="material.orchestrator.js"></script>
</body>
</html>
