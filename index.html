<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LociMyu</title>
  <link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" fill="%230b0f14"/><text x="32" y="39" font-size="28" text-anchor="middle" fill="%2353b7ff" font-family="Arial">L</text></svg>'>
  <style>
    :root{ --bg:#0b0f14; --panel:#121922; --text:#e6edf3; --accent:#53b7ff; --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.3);}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .app{display:grid;grid-template-rows:auto 1fr;height:100vh}
    header{display:flex;gap:.75rem;align-items:center;padding:10px 12px;background:linear-gradient(180deg,#0e1520,#0b0f14);border-bottom:1px solid #1e2837}
    .pill{background:rgba(255,255,255,.06);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.08);font-weight:700}
    input[type=text], select, textarea{background:#0f1722;border:1px solid #203049;color:var(--text);border-radius:10px;padding:8px 10px;min-width:240px}
    button{background:#152133;color:var(--text);border:1px solid #223146;border-radius:10px;padding:8px 12px;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    button:hover{background:#1a2b45}
    .accent{border-color:#2c82c9}
    .main{display:grid;grid-template-columns:360px 1fr 420px;gap:10px;padding:10px;height:calc(100vh - 58px)}
    body.wide #leftToolbox, body.wide #rightCaption{display:none}
    body.wide .main{grid-template-columns:1fr}
    .panel{background:#121922;border:1px solid #1e2837;border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;min-height:0}
    .panel h3{margin:0;padding:10px 12px;border-bottom:1px solid #203049;background:#0f1722;font-size:.95rem;font-weight:600}
    .panel .body{padding:10px;overflow:auto}
    #viewer{position:relative}
    #viewerCanvas{display:block;width:100%;height:100%;background:#0a0f16;border-radius:var(--radius)}
    #connector{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}
    #connector line{stroke:#7cc4ff;stroke-width:2;stroke-opacity:.9;filter:url(#dropshadow)}
    #connector circle{fill:#7cc4ff;opacity:.9}
    .hud{position:absolute;left:10px;bottom:10px;display:flex;gap:8px}
    .chip{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px}
    .spinner{position:absolute;inset:0;display:grid;place-items:center;background:linear-gradient(180deg, rgba(10,15,22,.75), rgba(10,15,22,.75));backdrop-filter: blur(2px);}
    .spinner[hidden]{display:none}
    .lds{width:64px;height:64px;border-radius:50%;border:6px solid rgba(255,255,255,.12);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .signin-gate{position:fixed;inset:0;display:grid;place-items:center;background:radial-gradient(1200px 600px at 50% 15%, rgba(83,183,255,.08), transparent 60%), linear-gradient(180deg,#0a0f16,#05070b);z-index:20}
    .card{width:min(560px,92vw);background:#0c1118;border:1px solid #1d2a3d;border-radius:24px;box-shadow:var(--shadow);padding:20px}
    .card h1{margin:4px 0 8px;font-size:1.35rem}
    .card p{color:#c2d0e2;opacity:.9}
    .list{display:flex;flex-direction:column;gap:8px}
    .list .row{display:flex;align-items:center;justify-content:space-between;gap:8px;background:#0f1722;border:1px solid #203049;border-radius:12px;padding:10px;cursor:pointer}
    .row .title{font-weight:600}
    .row .meta{color:#a9b8cf;font-size:.85rem}
    .row:hover{background:#132035}
    .small{font-size:.85rem;color:#a9b8cf}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .field{display:flex;gap:8px;align-items:center;margin:8px 0}
    .field label{min-width:120px;color:#a9b8cf}
    input[type="range"]{width:160px}
    .viewgrid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .thumb{position:relative}
    .thumb img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid #223146;display:block}
    .thumb .del{position:absolute;top:-6px;right:-6px;width:20px;height:20px;border-radius:50%;background:#1e2a3b;border:1px solid #334966;color:#e8f0ff;line-height:18px;text-align:center;font-weight:700;cursor:pointer}
    .thumb .del:hover{background:#2a3b55}
    #viewerPreview{position:absolute;top:10px;right:10px;max-height:60%;border:1px solid #203049;border-radius:8px;background:#0a0f16cc;backdrop-filter: blur(2px);display:grid;grid-template-rows:auto 1fr auto;gap:0;resize:both;overflow:hidden;min-width:260px;min-height:200px}
    #viewerPreview.hidden{display:none}
    #previewControls{position:sticky;top:0;background:#0a0f16f0;border-bottom:1px solid #203049;padding:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;z-index:1}
    #previewWrap{position:relative;overflow:auto}
    #previewInner{transform-origin: top left;}
    #previewInner img{display:block;max-width:none;max-height:none;border-radius:0}
    #viewerPreview .cap{border-top:1px solid #203049;background:#0a0f16f0;display:grid;grid-template-rows:auto auto;gap:4px;padding:6px 8px}
    #capTitleLine{font-weight:700}
    #capBodyLine{font-size:.85rem;color:#c9d7ea;max-height:8em;overflow:auto}
    body.viewonly #pinTools{display:none}
    body.viewonly #btnSavePin,
    body.viewonly #btnDeletePin,
    body.viewonly #btnAttach,
    body.viewonly #btnPickFromFolder,
    body.viewonly #autosaveTip,
    body.viewonly #listNew,
    body.viewonly #listDelete { display:none; }
    @media (max-width:1100px){
      .main{grid-template-columns:1fr; grid-template-rows: 360px 1fr 480px}
    }
  /* ===== M3D UI vNext (namespaced) ===== */
.m3d-ui-vnext #rightCaption{ display:none !important; }
@media (max-width: 900px){
  .m3d-ui-vnext #leftToolbox, 
  .m3d-ui-vnext #rightCaption{ display:none !important; }
}

/* Overlay caption layer (desktop) */
#m3d-caption-layer{
  position:absolute; inset:0;
  pointer-events:none; z-index: 1200;
}
#m3d-caption-layer .m3d-capwin{
  position:absolute; min-width:220px; max-width:340px;
  background:#0b132b; color:#d6e4ff; border:1px solid #1f2a44; border-radius:12px;
  box-shadow:0 8px 28px rgba(0,0,0,.35);
  pointer-events:auto; user-select:none; overflow:hidden;
}
.m3d-capwin__titlebar{
  cursor:move; padding:8px 12px; font-weight:600; background:#16223a;
  display:flex; align-items:center; gap:8px;
}
.m3d-capwin__close{
  margin-left:auto; background:transparent; border:none; color:#aac4ff; font-size:16px; cursor:pointer;
}
.m3d-capwin__body{ padding:10px 12px; }
.m3d-capwin__img{ display:block; max-width:240px; max-height:180px; width:auto; height:auto; border-radius:8px; margin:6px 0; }
.m3d-capwin__meta{ font-size:12px; opacity:.8; }
.m3d-capwin__actions{ display:flex; gap:8px; margin-top:8px; }

/* Mobile caption panel (single) */
#m3d-mobile-caption{
  display:none;
  position:relative;
  background:#0b132b; color:#d6e4ff; border-top:1px solid #1f2a44;
  padding:10px 12px; z-index:1100;
}
@media (max-width: 900px){
  #m3d-mobile-caption{ display:block; }
}
#m3d-mobile-caption .m3d-cap__img{
  max-width:50vw; max-height:40vh; width:auto; height:auto; border-radius:8px; display:block;
}
#m3d-mobile-caption .m3d-cap__placeholder{
  border:1px dashed #345; border-radius:10px; color:#9aa;
  min-height:80px; display:flex; align-items:center; justify-content:center; margin:6px 0;
}

/* Ensure viewer container is a positioning context for overlay */
.m3d-ui-vnext #viewer{ position:relative; }

/* vNext: right caption panel split (desktop) */
@media (min-width: 901px){
  #rightCaption .body{
    display:grid; grid-template-rows: 7fr 3fr; gap:10px;
  }
  #m3d-caplist{ overflow:auto; }
  #m3d-capeditor{ overflow:auto; }
}

</style>

  <!-- ES Modules -->
  <script type="importmap">{
  "imports": {
    "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/"
  }
}
</script>
  <!-- HEIC fallback -->
  <script src="https://unpkg.com/heic2any@0.0.5/dist/heic2any.min.js"></script>
</head>
<body>
<div class="app">
  <header>
    <span class="pill">LociMyu</span>
    <div class="toolbar" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input id="inputGLB" type="text" placeholder="GLB fileId or share URL" />
      <input id="inputSheet" type="text" placeholder="SpreadsheetId or share URLï¼ˆç©ºãªã‚‰è‡ªå‹•ä½œæˆï¼‰" />
      <button id="btnLoad" class="accent" disabled>GLBã‚’èª­ã¿è¾¼ã‚€</button>
      <button id="btnViewOnly">é–²è¦§ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ</button>
      <button id="btnWide">ğŸ“º ãƒ“ãƒ¥ãƒ¼ã‚¢æ‹¡å¤§</button>
      <span id="statusLabel" class="chip">ã‚µã‚¤ãƒ³ã‚¤ãƒ³å¾…ã¡â€¦</span>
    </div>
  </header>

  <div class="main">
    <!-- å·¦ï¼šãƒ„ãƒ¼ãƒ« -->
    <section class="panel" id="leftToolbox">
      <h3>ãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ï¼ˆãƒãƒ†ãƒªã‚¢ãƒ« & ã‚«ãƒ¡ãƒ© & ãƒ”ãƒ³ï¼‰</h3>
      <div class="body">
        <div id="pinTools">
          <div class="small">Shift + ã‚¯ãƒªãƒƒã‚¯ ã§ãƒ”ãƒ³ã‚’é…ç½®ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰</div>
          <div class="flex" style="margin-top:6px;margin-bottom:6px">
            <button id="btnAddPin" disabled>ï¼‹ ãƒ”ãƒ³è¿½åŠ ãƒ¢ãƒ¼ãƒ‰</button>
            <button id="btnGizmo" disabled>ã‚®ã‚ºãƒ¢: OFF</button>
            <button id="btnUndo" disabled>Ctrl+Z</button>
            <button id="btnTogglePins" disabled>ãƒ”ãƒ³è¡¨ç¤º: ON</button>
          </div>
          <div class="flex" style="align-items:center;flex-wrap:nowrap">
            <div class="small">ãƒ”ãƒ³è‰²:</div>
            <div id="colorPresets" class="flex" style="flex-wrap:nowrap"></div>
          </div>
          <hr style="border-color:#203049;border-width:1px 0;margin:12px 0">
        </div>

        <div class="small" style="margin:4px 0 6px">ãƒãƒ†ãƒªã‚¢ãƒ«ç·¨é›†ï¼ˆã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒˆã”ã¨ã«ä¿å­˜ï¼‰</div>
        <div class="field"><label>å¯¾è±¡</label>
          <select id="matSelect"><option value="__all__">ï¼ˆå…¨ãƒãƒ†ãƒªã‚¢ãƒ«ï¼šç·¨é›†ä¸å¯ï¼‰</option></select>
        </div>
        <div class="field"><label>Unlit</label><input id="matUnlit" type="checkbox"><span class="small">æ˜æš—ãªã—</span></div>
        <div class="field"><label>è£é¢æç”»</label><input id="matDoubleSided" type="checkbox"></div>
        <div class="field"><label>ä¸é€æ˜åº¦</label><input id="matOpacity" type="range" min="0" max="1" step="0.01" value="1"><span id="matOpacityVal" class="small">1.00</span></div>
        <div class="field"><label>ãƒ†ã‚¯ã‚¹ãƒãƒ£åè»¢</label><input id="matInvert" type="checkbox"></div>
        <div class="field"><label>ç™½â†’é€æ˜</label><input id="matWhiteTransparent" type="checkbox"></div>
        <div class="field"><label>é–¾å€¤ï¼ˆÎ±Testï¼‰</label><input id="matThreshold" type="range" min="0" max="1" step="0.01" value="0"><span id="matThresholdVal" class="small">0.00</span></div>

        <hr style="border-color:#203049;border-width:1px 0;margin:12px 0">

        <div class="small" style="margin:4px 0 6px">ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒˆã”ã¨ã«ä¿å­˜ï¼‰</div>
        <div class="viewgrid" style="margin-bottom:8px">
          <button id="viewFront">å‰é¢</button>
          <button id="viewBack">èƒŒé¢</button>
          <button id="viewLeft">å·¦é¢</button>
          <button id="viewRight">å³é¢</button>
          <button id="viewTop">ä¸Šé¢</button>
          <button id="viewBottom">ä¸‹é¢</button>
        </div>
        <div class="field"><label>å¹³è¡ŒæŠ•å½±</label><input id="projOrtho" type="checkbox"><span class="small">ON: Orthographic</span></div>
        <div class="field"><label>èƒŒæ™¯è‰²</label><input id="bgColor" type="color" value="#0a0f16"></div>
      </div>
    </section>

    <!-- ä¸­å¤®ï¼šãƒ“ãƒ¥ãƒ¼ã‚¢ -->
    <section class="panel" id="viewer">
      <div class="spinner" id="loading" hidden><div class="lds"></div></div>
      <canvas id="viewerCanvas"></canvas>
      <svg id="connector">
        <defs><filter id="dropshadow" x="-20%" y="-20%" width="140%"><feDropShadow dx="0" dy="0" stdDeviation="2" flood-color="#001a33" flood-opacity="0.9"/></filter></defs>
        <line id="connLine" x1="0" y1="0" x2="0" y2="0" style="display:none"/>
        <circle id="connDot" r="3" cx="0" cy="0" style="display:none"/>
      </svg>

      <div id="viewerPreview" class="hidden">
        <button id="previewClose" aria-label="é–‰ã˜ã‚‹" style="position:absolute;right:8px;top:8px;z-index:3;background:#162234;border:1px solid #24324b;color:#e6edf3;border-radius:10px;padding:6px 10px;cursor:pointer">é–‰ã˜ã‚‹</button>
        <div id="previewControls">
          <span class="small">å€ç‡</span>
          <input id="previewZoom" type="range" min="0.1" max="3" step="0.05" value="1">
          <span id="previewZoomVal" class="small">1.00Ã—</span>
          <button id="previewReset">ãƒªã‚»ãƒƒãƒˆ</button>
          <span id="previewErr" class="small" style="margin-left:auto;color:#ffb4b4;display:none">ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</span>
        </div>
        <div id="previewWrap" style="position:relative"><div id="previewInner"><img id="previewImg" alt="preview"/></div><div id="previewMsg" class="small" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:#9fb3c8;display:none;text-align:center;pointer-events:none">ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div></div>
        <div class="cap">
          <div id="capTitleLine"></div>
          <div id="capBodyLine"></div>
        </div>
      </div>

      <div class="hud"><div class="chip" id="modeLabel">Orbit</div></div>
    </section>

    <!-- å³ï¼šã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ -->
    <section class="panel" id="rightCaption">
      <h3>ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³</h3>
      <div class="body">
        <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:6px">
          <div class="flex" style="gap:8px;align-items:center">
            <div class="small">ãƒ”ãƒ³ä¸€è¦§</div>
            <button id="btnColorFilter">è‰²ã§çµã‚Šè¾¼ã¿ â–¾</button>
          </div>
          <div class="flex" style="gap:6px;align-items:center">
            <select id="listSelect" disabled></select>
            <button id="listNew" disabled>æ–°è¦</button>
            <button id="listDelete" disabled>å‰Šé™¤</button>
          </div>
        </div>

        <div id="colorFilterPanel" class="panel body" style="display:none;margin-bottom:8px;padding:8px">
          <div class="small" style="margin-bottom:6px">è¡¨ç¤ºã™ã‚‹è‰²ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div>
          <div id="colorFilterList"></div>
          <div class="flex" style="justify-content:flex-end;margin-top:8px">
            <button id="btnFilterAll">ã™ã¹ã¦</button>
            <button id="btnFilterNone">ãªã—</button>
            <button id="btnFilterClose">é–‰ã˜ã‚‹</button>
          </div>
        </div>

        <div id="pinsList" class="list" style="margin:8px 0 14px"></div>
        <div id="noSelection">ãƒ”ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</div>

        <div id="editor" class="hidden">
          <div class="field" style="width:100%"><label>ã‚¿ã‚¤ãƒˆãƒ«</label><input id="capTitle" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" style="flex:1"/></div>
          <div class="field" style="width:100%"><label>æœ¬æ–‡</label><textarea id="capBody" rows="6" placeholder="ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³æœ¬æ–‡" style="flex:1"></textarea></div>

          <div class="flex">
            <input id="imgLocal" type="file" accept="image/*,.heic,.HEIC" style="display:none"/>
            <button id="btnAttach" class="accent" disabled>ç”»åƒã‚’æ·»ä»˜ã—ã¦Driveã«ä¿å­˜</button>
            <button id="btnPickFromFolder" class="accent" disabled>Driveã‹ã‚‰ä¿å­˜</button>
          </div>

          <div class="thumbs" id="thumbs"></div>

          <div class="flex" style="justify-content:space-between;margin-top:8px;margin-bottom:8px">
            <button id="btnSavePin" class="accent" disabled>ä¿å­˜ï¼ˆSheetsï¼‰</button>
            <button id="btnDeletePin" style="border-color:#5a1f26;color:#ffb4b4" disabled>ãƒ”ãƒ³å‰Šé™¤</button>
            <span class="small" id="autosaveTip">å…¥åŠ›ã¯æ•°ç§’å¾Œã«è‡ªå‹•ä¿å­˜</span>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- Driveç”»åƒãƒ”ãƒƒã‚«ãƒ¼ -->
<div id="pickerModal" class="signin-gate" style="display:none;background:rgba(0,0,0,.55)">
  <div class="card" style="width:min(90vw,980px);max-height:80vh;overflow:hidden">
    <h1 style="margin:0 0 6px">Driveã‹ã‚‰ä¿å­˜</h1>
    <div class="flex" style="justify-content:flex-end;margin-bottom:8px">
      <button id="btnPickerReload">å†èª­ã¿è¾¼ã¿</button>
      <button id="btnPickerClose">é–‰ã˜ã‚‹</button>
    </div>
    <div id="pickerGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;overflow:auto;max-height:60vh"></div>
  </div>
</div>

<!-- ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚²ãƒ¼ãƒˆ -->
<div class="signin-gate" id="gate">
  <div class="card">
    <h1>Googleã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³</h1>
    <p>æœ¬ãƒ„ãƒ¼ãƒ«ã¯ Google Drive / Google Sheets ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚å…ˆã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button id="btnSignIn" class="accent" style="font-weight:700">ğŸ” Sign in with Google</button>
      <span class="small" style="opacity:.8">OAuth2 (Drive.file / Sheets)</span>
    </div>
  </div>
</div>

<!-- Google SDK -->
<script>
  window.__flags = { gapi:false, gis:false };
  function onGapi(){ window.__flags.gapi = true; }
  function onGis(){  window.__flags.gis  = true; }
</script>
<script async defer src="https://accounts.google.com/gsi/client" onload="onGis()"></script>
<script async defer src="https://apis.google.com/js/api.js" onload="onGapi()"></script>

<script type="module">
/* ===== Three.js imports ===== */
/* ===== Three.js imports ===== */
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { TransformControls } from 'three/addons/controls/TransformControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';</script>
<!-- M3D vNext UI containers -->
<div id="m3d-caption-layer" aria-label="caption overlay layer" hidden></div>
<div id="m3d-mobile-caption" aria-label="mobile caption panel" hidden>
  <div class="m3d-cap__title" id="m3d-mcap-title"></div>
  <div class="m3d-cap__imgwrap">
    <img id="m3d-mcap-img" class="m3d-cap__img" alt="caption image" />
    <div id="m3d-mcap-ph" class="m3d-cap__placeholder">ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
  </div>
  <div class="m3d-cap__body" id="m3d-mcap-body"></div>
  <div class="m3d-cap__actions" id="m3d-mcap-actions"></div>
</div>
<script>
(function(){
  if (window.M3DUI && window.M3DUI.__ready) return;

  function $(id){ return document.getElementById(id); }
  function isMobile(){
    try{ return window.matchMedia("(max-width: 900px)"").matches; }\n    catch(e){ return (window.innerWidth||1024) <= 900; }\n  }\n\n  var state = { desktopWindows:{}, activePin:null };\n\n  function ensureRoot(){\n    document.body.classList.add('m3d-ui-vnext');\n    var overlay = $(""m3d-caption-layer"");\n    var mcap    = $(""m3d-mobile-caption"");\n    var viewer  = $(""viewer"");\n    // keep hidden until first use\n    /* if (overlay) overlay.hidden = false;\n    if (mcap)    mcap.hidden = false; */\n    if (viewer){\n      if (getComputedStyle(viewer).position === 'static'){ viewer.style.position = 'relative'; }\n      // ensure overlay is a child of #viewer for proper absolute positioning\n      if (overlay && overlay.parentElement !== viewer){ viewer.appendChild(overlay); }\n      // on mobile, place mobile caption just after viewer\n      if (isMobile() && mcap && mcap.parentElement !== viewer.parentElement){\n        viewer.parentElement.insertBefore(mcap, viewer.nextSibling);\n      }\n    }\n  }\n\n  function makeDraggable(handle, target){\n    var sx=0, sy=0, ox=0, oy=0, dragging=false;\n    handle.addEventListener('mousedown', function(e){\n      dragging=true; sx=e.clientX; sy=e.clientY;\n      var r = target.getBoundingClientRect(); ox=r.left + window.scrollX; oy=r.top + window.scrollY;\n      e.preventDefault();\n    });\n    document.addEventListener('mousemove', function(e){\n      if(!dragging) return;\n      var dx=e.clientX-sx, dy=e.clientY-sy;\n      target.style.left = (ox+dx) + 'px';\n      target.style.top  = (oy+dy) + 'px';\n    });\n    document.addEventListener('mouseup', function(){ dragging=false; });\n  }\n\n  function createCapWindow(pin){\n    try{ if(!(window.M3DUI && window.M3DUI.__modelReady)) return null; }catch(_){ return null; }\n    var overlay = $(""m3d-caption-layer"");\n    if(!overlay) return null;\n    overlay.hidden = false;\n    var div = document.createElement('div');\n    div.className = 'm3d-capwin';\n    div.style.left = (24 + Math.floor(Math.random()*60)) + 'px';\n    div.style.top  = (24 + Math.floor(Math.random()*40)) + 'px';\n\n    var bar = document.createElement('div'); bar.className = 'm3d-capwin__titlebar';\n    var title = document.createElement('div'); title.textContent = (pin && pin.title) ? pin.title : 'ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³';\n    var btnX = document.createElement('button'); btnX.className='m3d-capwin__close'; btnX.textContent='âœ•';\n    btnX.addEventListener('click', function(){ if(div.parentElement) div.parentElement.removeChild(div); });\n    bar.appendChild(title); bar.appendChild(btnX);\n    div.appendChild(bar);\n\n    var body = document.createElement('div'); body.className='m3d-capwin__body';\n    if(pin && pin.img){\n      var img = document.createElement('img'); img.className='m3d-capwin__img'; img.src=pin.img; img.alt='caption image';\n      body.appendChild(img);\n      var act = document.createElement('div'); act.className='m3d-capwin__actions';\n      var a = document.createElement('a'); a.href=pin.img; a.target='_blank'; a.rel='noopener'; a.textContent='å…ƒç”»åƒã‚’é–‹ã';\n      act.appendChild(a); body.appendChild(act);\n    }else{\n      var ph = document.createElement('div'); ph.className='m3d-cap__placeholder'; ph.textContent='ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';\n      body.appendChild(ph);\n    }\n    var meta = document.createElement('div'); meta.className='m3d-capwin__meta'; meta.textContent = (pin && pin.id) ? ('#'+pin.id) : '';\n    body.appendChild(meta);\n    var text = document.createElement('div'); text.textContent = (pin && pin.body) ? pin.body : '';\n    body.appendChild(text);\n\n    div.appendChild(body);\n    overlay.appendChild(div);\n    makeDraggable(bar, div);\n    return div;\n  }\n\n  function showMobileCaption(pin){\n    var panel = $(""m3d-mobile-caption""); if(!panel) return;\n    var t=$(""m3d-mcap-title""), b=$(""m3d-mcap-body""), img=$(""m3d-mcap-img""), ph=$(""m3d-mcap-ph""), acts=$(""m3d-mcap-actions"");\n    t.textContent = (pin && pin.title) ? pin.title : 'ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³';\n    b.textContent = (pin && pin.body)  ? pin.body  : '';\n    acts.innerHTML = '';\n    if(pin && pin.img){\n      img.src = pin.img; img.style.display='block'; ph.style.display='none';\n      var a = document.createElement('a'); a.href=pin.img; a.target='_blank'; a.rel='noopener'; a.textContent='å…ƒç”»åƒã‚’é–‹ã';\n      acts.appendChild(a);\n    }else{\n      img.removeAttribute('src'); img.style.display='none'; ph.style.display='flex';\n    }\n    try{\n      var viewer=$(""viewer"");\n      if(viewer){\n        var vw = viewer.clientWidth || window.innerWidth || 360;\n        var vh = viewer.clientHeight|| Math.max(320, Math.floor((window.innerHeight||640)*0.6));\n        img.style.maxWidth  = Math.round(vw*0.5) + 'px';\n        img.style.maxHeight = Math.round(vh*0.4) + 'px';\n      }\n    }catch(_){}\n  }\n\n  function readCurrentPinFromLegacy(){\n    var imgEl = document.getElementById('previewImg');\n    var title = (document.getElementById('capTitleLine')||{}).textContent || '';\n    var body  = (document.getElementById('capBodyLine')||{}).textContent || '';\n    var id    = (window.currentPin && window.currentPin.id) || '';\n    var src   = (imgEl && imgEl.src) || '';\n    var hasImg= !!(imgEl && imgEl.naturalWidth);\n    return { id:id||'', title:title||'', body:body||'', img: hasImg ? src : '' };\n  }\n\n  function onPinSelected(pinLike){\n    var pin = pinLike || readCurrentPinFromLegacy();\n    state.activePin = pin;\n    if (isMobile()){ showMobileCaption(pin); }\n    else { createCapWindow(pin); }\n  }\n\n  window.M3DUI = { __ready:true, onPinSelected:onPinSelected, showMobileCaption:showMobileCaption, createCapWindow:createCapWindow };\n\n  document.addEventListener('DOMContentLoaded', function(){\n    ensureRoot();\n    if (typeof window.selectPin === 'function'){\n      var orig = window.selectPin;\n      window.selectPin = function(){\n        try{ orig.apply(this, arguments); }catch(e){ console.warn(e); }\n        try{ if(window.M3DUI && window.M3DUI.onPinSelected) window.M3DUI.onPinSelected(); }catch(e){ console.warn(e); }\n      };\n    }\n    });window.addEventListener('resize', function(){\n    try{ if (isMobile() && state.activePin) showMobileCaption(state.activePin); }catch(_){}\n  });\n})();\n</script>
<script>

document.addEventListener('DOMContentLoaded'', function(){\n  try{\n    var rc = document.getElementById('rightCaption');\n    if(!rc) return;\n    var body = rc.querySelector('.body') || rc;\n    if(!document.getElementById('m3d-caplist')){\n      var list = document.createElement('div'); list.id='m3d-caplist'; body.insertBefore(list, body.firstChild);\n    }\n    if(!document.getElementById('m3d-capeditor')){\n      var ed = document.createElement('div'); ed.id='m3d-capeditor'; body.appendChild(ed);\n    }\n    // Move known editor block to bottom if exists\n    var editor = document.getElementById('editor');\n    if(editor && editor.parentElement !== document.getElementById('m3d-capeditor')){\n      document.getElementById('m3d-capeditor').appendChild(editor);\n    }\n    // Move known preview out of right pane (overlay/mobile handles viewing)\n    var prev = document.getElementById('viewerPreview');\n    if(prev && prev.parentElement === body){\n      // leave it where it is or let overlay handle; no action\n    }\n    // Heuristic: move non-editor controls to list\n    var caplist = document.getElementById('m3d-caplist');\n    Array.from(body.children).forEach(function(node){\n      var id = node.id||'''';\n      if(id==='m3d-caplist' || id==='m3d-capeditor' || id==='editor') return;\n      if(node === caplist || node === document.getElementById('m3d-capeditor')) return;\n      // keep tabs/headers at top of list\n      if(caplist && node.parentElement===body){\n        caplist.appendChild(node);\n      }\n    });\n  }catch(e){ console.warn('right panel split failed', e); }\n});\n\n</script>

<script>
(function(){
  if(!window.M3DUI) return;
  window.M3DUI.__modelReady = false;
  window.M3DUI.modelLoaded = function(){
    window.M3DUI.__modelReady = true;
    try{
      var p = window.M3DUI.__pendingPin;
      if(p){
        window.M3DUI.__pendingPin = null;
        if (window.matchMedia && window.matchMedia('(max-width: 900px)'').matches){\n          window.M3DUI.showMobileCaption(p);\n          var mcapEl=document.getElementById('m3d-mobile-caption'); if(mcapEl) mcapEl.hidden=false;\n        }else{\n          window.M3DUI.createCapWindow(p);\n          var overlayEl=document.getElementById('m3d-caption-layer'); if(overlayEl) overlayEl.hidden=false;\n        }\n      }\n    }catch(_){}\n  };\n  function wrapSuccess(fnName){\n    try{\n      var fn = window[fnName];\n      if(typeof fn !== 'function') return;\n      window[fnName] = async function(){\n        var res = await fn.apply(this, arguments);\n        try{ window.M3DUI.modelLoaded(); }catch(_){}\n        return res;\n      };\n    }catch(_){}\n  }\n  wrapSuccess('loadGLBFromURL');\n  wrapSuccess('loadGLBByFileId');\n  if(typeof window.M3DUI.onPinSelected === 'function'){\n    var orig = window.M3DUI.onPinSelected;\n    window.M3DUI.onPinSelected = function(pinLike){\n      try{\n        if(!window.M3DUI.__modelReady){\n          window.M3DUI.__pendingPin = pinLike;\n          return;\n        }\n      }catch(_){}\n      return orig.apply(this, arguments);\n    };\n  }\n})();\n</script>


<!-- Minimal HUD & material-queue drain -->
<style>
#_m3d_hud_overlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.35);z-index:99999}
#_m3d_hud_center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;text-align:center;font:14px system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
._m3d_spinner{width:48px;height:48px;border:4px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:m3dspin 1s linear infinite;margin:0 auto 10px}
@keyframes m3dspin{to{transform:rotate(360deg)}}
</style>
<div id="_m3d_hud_overlay" aria-hidden="true"><div id="_m3d_hud_center"><div class="_m3d_spinner"></div><div id="_m3d_hud_msg">é€šä¿¡ä¸­â€¦</div></div></div>
<script>
(function(){
  var overlay, msg, ref=0;
  function ensure(){
    overlay = document.getElementById('_m3d_hud_overlay');\n    msg = document.getElementById('_m3d_hud_msg');\n  }\n  window.M3DBusy = {\n    show: function(m){ try{ ensure(); if(m) msg.textContent=m; ref++; overlay.style.display='block'; }catch(_){}},\n    hide: function(){ try{ ensure(); ref=Math.max(0,ref-1); if(ref===0) overlay.style.display='none'; }catch(_){} }\n  };\n  // Drain queued material updates after modelLoaded\n  (function(){\n    if(!window.M3DUI) window.M3DUI = {};\n    var orig = window.M3DUI.modelLoaded;\n    window.M3DUI.modelLoaded = function(){\n      try{\n        var q = window.__matQueue || [];\n        window.__matQueue = [];\n        for (var i=0;i<q.length;i++){\n          try{ applyStateToMaterial(q[i][0], q[i][1]); }catch(e){}\n        }\n      }catch(_){}\n      if (typeof orig==='function') return orig.apply(this, arguments);\n    };\n  })();\n  // Optional: hook fetch/XHR to show busy on Drive/Sheets calls\n  try{\n    var _fetch = window.fetch;\n    window.fetch = function(input, init){\n      try{\n        var url = (typeof input==='string') ? input : (input && input.url ? input.url : '''');\n        var busy = url && (url.indexOf(''alt=media'')>0 || url.indexOf('googleapis.com')>0 || url.indexOf('/spreadsheets/')>0);\n        if (busy) M3DBusy.show(''é€šä¿¡ä¸­â€¦'');\n        var p = _fetch.apply(this, arguments);\n        if (p && typeof p.then==='function'){\n          return p.then(function(v){ if(busy) M3DBusy.hide(); return v; }, function(e){ if(busy) M3DBusy.hide(); throw e; });\n        }\n        if (busy) M3DBusy.hide();\n        return p;\n      }catch(e){ try{ return _fetch.apply(this, arguments); }catch(e2){ throw e2; } }\n    };\n  }catch(_){}\n  try{\n    var X = window.XMLHttpRequest;\n    if (X){\n      var H = function(){ var x = new X(); var url=''''; var open=x.open; x.open=function(m,u){url=String(u||''''); return open.apply(this, arguments);}; var send=x.send; x.send=function(){ var busy=(url.indexOf(''alt=media'')>0||url.indexOf('googleapis.com')>0||url.indexOf('/spreadsheets/')>0); if(busy) M3DBusy.show(''é€šä¿¡ä¸­â€¦''); x.addEventListener('loadend', function(){ if(busy) M3DBusy.hide(); }); return send.apply(this, arguments); }; return x; };\n      H.prototype = X.prototype; window.XMLHttpRequest = H;\n    }\n  }catch(_){}\n})();\n</script>
</body>
</html>
