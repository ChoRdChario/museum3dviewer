<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LociMyu</title>
  <link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" fill="%230b0f14"/><text x="32" y="39" font-size="28" text-anchor="middle" fill="%2353b7ff" font-family="Arial">L</text></svg>'>
  <style>
    :root{ --bg:#0b0f14; --panel:#121922; --text:#e6edf3; --accent:#53b7ff; --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.3);}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .app{display:grid;grid-template-rows:auto 1fr;height:100vh}
    header{display:flex;gap:.75rem;align-items:center;padding:10px 12px;background:linear-gradient(180deg,#0e1520,#0b0f14);border-bottom:1px solid #1e2837}
    .pill{background:rgba(255,255,255,.06);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.08);font-weight:700}
    input[type=text], select, textarea{background:#0f1722;border:1px solid #203049;color:var(--text);border-radius:10px;padding:8px 10px;min-width:240px}
    button{background:#152133;color:var(--text);border:1px solid #223146;border-radius:10px;padding:8px 12px;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    button:hover{background:#1a2b45}
    .accent{border-color:#2c82c9}
    .main{display:grid;grid-template-columns:360px 1fr 420px;gap:10px;padding:10px;height:calc(100vh - 58px)}
    body.wide #leftToolbox, body.wide #rightCaption{display:none}
    body.wide .main{grid-template-columns:1fr}
    .panel{background:#121922;border:1px solid #1e2837;border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;min-height:0}
    .panel h3{margin:0;padding:10px 12px;border-bottom:1px solid #203049;background:#0f1722;font-size:.95rem;font-weight:600}
    .panel .body{padding:10px;overflow:auto}
    #viewer{position:relative}
    #viewerCanvas{display:block;width:100%;height:100%;background:#0a0f16;border-radius:var(--radius)}
    #connector{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}
    #connector line{stroke:#7cc4ff;stroke-width:2;stroke-opacity:.9;filter:url(#dropshadow)}
    #connector circle{fill:#7cc4ff;opacity:.9}
    .hud{position:absolute;left:10px;bottom:10px;display:flex;gap:8px}
    .chip{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px}
    .spinner{position:absolute;inset:0;display:grid;place-items:center;background:linear-gradient(180deg, rgba(10,15,22,.75), rgba(10,15,22,.75));backdrop-filter: blur(2px);}
    .spinner[hidden]{display:none}
    .lds{width:64px;height:64px;border-radius:50%;border:6px solid rgba(255,255,255,.12);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .signin-gate{position:fixed;inset:0;display:grid;place-items:center;background:radial-gradient(1200px 600px at 50% 15%, rgba(83,183,255,.08), transparent 60%), linear-gradient(180deg,#0a0f16,#05070b);z-index:20}
    .card{width:min(560px,92vw);background:#0c1118;border:1px solid #1d2a3d;border-radius:24px;box-shadow:var(--shadow);padding:20px}
    .card h1{margin:4px 0 8px;font-size:1.35rem}
    .card p{color:#c2d0e2;opacity:.9}
    .list{display:flex;flex-direction:column;gap:8px}
    .list .row{display:flex;align-items:center;justify-content:space-between;gap:8px;background:#0f1722;border:1px solid #203049;border-radius:12px;padding:10px;cursor:pointer}
    .row .title{font-weight:600}
    .row .meta{color:#a9b8cf;font-size:.85rem}
    .row:hover{background:#132035}
    .small{font-size:.85rem;color:#a9b8cf}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .field{display:flex;gap:8px;align-items:center;margin:8px 0}
    .field label{min-width:120px;color:#a9b8cf}
    input[type="range"]{width:160px}
    .viewgrid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .thumb{position:relative}
    .thumb img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid #223146;display:block}
    .thumb .del{position:absolute;top:-6px;right:-6px;width:20px;height:20px;border-radius:50%;background:#1e2a3b;border:1px solid #334966;color:#e8f0ff;line-height:18px;text-align:center;font-weight:700;cursor:pointer}
    .thumb .del:hover{background:#2a3b55}
    #viewerPreview{position:absolute;top:10px;right:10px;max-height:60%;border:1px solid #203049;border-radius:8px;background:#0a0f16cc;backdrop-filter: blur(2px);display:grid;grid-template-rows:auto 1fr auto;gap:0;resize:both;overflow:hidden;min-width:260px;min-height:200px}
    #viewerPreview.hidden{display:none}
    #previewControls{position:sticky;top:0;background:#0a0f16f0;border-bottom:1px solid #203049;padding:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;z-index:1}
    #previewWrap{position:relative;overflow:auto}
    #previewInner{transform-origin: top left;}
    #previewInner img{display:block;max-width:none;max-height:none;border-radius:0}
    #viewerPreview .cap{border-top:1px solid #203049;background:#0a0f16f0;display:grid;grid-template-rows:auto auto;gap:4px;padding:6px 8px}
    #capTitleLine{font-weight:700}
    #capBodyLine{font-size:.85rem;color:#c9d7ea;max-height:8em;overflow:auto}
    body.viewonly #pinTools{display:none}
    body.viewonly #btnSavePin,
    body.viewonly #btnDeletePin,
    body.viewonly #btnAttach,
    body.viewonly #btnPickFromFolder,
    body.viewonly #autosaveTip,
    body.viewonly #listNew,
    body.viewonly #listDelete { display:none; }
    @media (max-width:1100px){
      .main{grid-template-columns:1fr; grid-template-rows: 360px 1fr 480px}
    }
  </style>

  <script type="importmap">
  { "imports": {
      "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
      "three/examples/jsm/": "https://unpkg.com/three@0.157.0/examples/jsm/"
    } }
  </script>
  <script src="https://unpkg.com/heic2any@0.0.5/dist/heic2any.min.js"></script>
</head>
<body>
<div class="app">
  <header>
    <span class="pill">LociMyu</span>
    <div class="toolbar" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input id="inputGLB" type="text" placeholder="GLB fileId or share URL" />
      <input id="inputSheet" type="text" placeholder="SpreadsheetId or share URL（空なら自動作成）" />
      <button id="btnLoad" class="accent" disabled>GLBを読み込む</button>
      <button id="btnViewOnly">閲覧リンクを生成</button>
      <button id="btnWide">📺 ビューア拡大</button>
      <span id="statusLabel" class="chip">サインイン待ち…</span>
    </div>
  </header>

  <div class="main">
    <section class="panel" id="leftToolbox">
      <h3>ツールボックス（マテリアル & カメラ & ピン）</h3>
      <div class="body">
        <div id="pinTools">
          <div class="small">Shift + クリック でピンを配置（編集モードのみ）</div>
          <div class="flex" style="margin-top:6px;margin-bottom:6px">
            <button id="btnAddPin" disabled>＋ ピン追加モード</button>
            <button id="btnGizmo" disabled>ギズモ: OFF</button>
            <button id="btnUndo" disabled>Ctrl+Z</button>
            <button id="btnTogglePins" disabled>ピン表示: ON</button>
          </div>
          <div class="flex" style="align-items:center;flex-wrap:nowrap">
            <div class="small">ピン色:</div>
            <div id="colorPresets" class="flex" style="flex-wrap:nowrap"></div>
          </div>
          <hr style="border-color:#203049;border-width:1px 0;margin:12px 0">
        </div>

        <div class="small" style="margin:4px 0 6px">マテリアル編集（キャプションシートごとに保存）</div>
        <div class="field"><label>対象</label>
          <select id="matSelect"><option value="__all__">（全マテリアル：編集不可）</option></select>
        </div>
        <div class="field"><label>Unlit</label><input id="matUnlit" type="checkbox"><span class="small">明暗なし</span></div>
        <div class="field"><label>裏面描画</label><input id="matDoubleSided" type="checkbox"></div>
        <div class="field"><label>不透明度</label><input id="matOpacity" type="range" min="0" max="1" step="0.01" value="1"><span id="matOpacityVal" class="small">1.00</span></div>
        <div class="field"><label>テクスチャ反転</label><input id="matInvert" type="checkbox"></div>
        <div class="field"><label>白→透明</label><input id="matWhiteTransparent" type="checkbox"></div>
        <div class="field"><label>閾値（αTest）</label><input id="matThreshold" type="range" min="0" max="1" step="0.01" value="0"><span id="matThresholdVal" class="small">0.00</span></div>

        <hr style="border-color:#203049;border-width:1px 0;margin:12px 0">

        <div class="small" style="margin:4px 0 6px">ビュー（キャプションシートごとに保存）</div>
        <div class="viewgrid" style="margin-bottom:8px">
          <button id="viewFront">前面</button>
          <button id="viewBack">背面</button>
          <button id="viewLeft">左面</button>
          <button id="viewRight">右面</button>
          <button id="viewTop">上面</button>
          <button id="viewBottom">下面</button>
        </div>
        <div class="field"><label>平行投影</label><input id="projOrtho" type="checkbox"><span class="small">ON: Orthographic</span></div>
        <div class="field"><label>背景色</label><input id="bgColor" type="color" value="#0a0f16"></div>
      </div>
    </section>

    <section class="panel" id="viewer">
      <div class="spinner" id="loading" hidden><div class="lds"></div></div>
      <canvas id="viewerCanvas"></canvas>
      <svg id="connector">
        <defs><filter id="dropshadow" x="-20%" y="-20%" width="140%"><feDropShadow dx="0" dy="0" stdDeviation="2" flood-color="#001a33" flood-opacity="0.9"/></filter></defs>
        <line id="connLine" x1="0" y1="0" x2="0" y2="0" style="display:none"/>
        <circle id="connDot" r="3" cx="0" cy="0" style="display:none"/>
      </svg>

      <div id="viewerPreview" class="hidden">
        <div id="previewControls">
          <span class="small">倍率</span>
          <input id="previewZoom" type="range" min="0.25" max="3" step="0.05" value="1">
          <span id="previewZoomVal" class="small">1.00×</span>
          <button id="previewReset">リセット</button>
          <span id="previewErr" class="small" style="margin-left:auto;color:#ffb4b4;display:none">画像を読み込めませんでした</span>
        </div>
        <div id="previewWrap"><div id="previewInner"><img id="previewImg" alt="preview"/></div></div>
        <div class="cap">
          <div id="capTitleLine"></div>
          <div id="capBodyLine"></div>
        </div>
      </div>

      <div class="hud"><div class="chip" id="modeLabel">Orbit</div></div>
    </section>

    <section class="panel" id="rightCaption">
      <h3>キャプション</h3>
      <div class="body">
        <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:6px">
          <div class="flex" style="gap:8px;align-items:center">
            <div class="small">ピン一覧</div>
            <button id="btnColorFilter">色で絞り込み ▾</button>
          </div>
          <div class="flex" style="gap:6px;align-items:center">
            <select id="listSelect" disabled></select>
            <button id="listNew" disabled>新規</button>
            <button id="listDelete" disabled>削除</button>
          </div>
        </div>

        <div id="colorFilterPanel" class="panel body" style="display:none;margin-bottom:8px;padding:8px">
          <div class="small" style="margin-bottom:6px">表示する色を選択（複数可）</div>
          <div id="colorFilterList"></div>
          <div class="flex" style="justify-content:flex-end;margin-top:8px">
            <button id="btnFilterAll">すべて</button>
            <button id="btnFilterNone">なし</button>
            <button id="btnFilterClose">閉じる</button>
          </div>
        </div>

        <div id="pinsList" class="list" style="margin:8px 0 14px"></div>
        <div id="noSelection">ピンを選択してください</div>

        <div id="editor" class="hidden">
          <div class="field" style="width:100%"><label>タイトル</label><input id="capTitle" type="text" placeholder="タイトル" style="flex:1"/></div>
          <div class="field" style="width:100%"><label>本文</label><textarea id="capBody" rows="6" placeholder="キャプション本文" style="flex:1"></textarea></div>

          <div class="flex">
            <input id="imgLocal" type="file" accept="image/*,.heic,.HEIC" style="display:none"/>
            <button id="btnAttach" class="accent" disabled>画像を添付してDriveに保存</button>
            <button id="btnPickFromFolder" class="accent" disabled>Driveから保存</button>
          </div>

          <div class="thumbs" id="thumbs"></div>

          <div class="flex" style="justify-content:space-between;margin-top:8px;margin-bottom:8px">
            <button id="btnSavePin" class="accent" disabled>保存（Sheets）</button>
            <button id="btnDeletePin" style="border-color:#5a1f26;color:#ffb4b4" disabled>ピン削除</button>
            <span class="small" id="autosaveTip">入力は数秒後に自動保存</span>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- Drive画像ピッカー -->
<div id="pickerModal" class="signin-gate" style="display:none;background:rgba(0,0,0,.55)">
  <div class="card" style="width:min(90vw,980px);max-height:80vh;overflow:hidden">
    <h1 style="margin:0 0 6px">Driveから保存</h1>
    <div class="flex" style="justify-content:flex-end;margin-bottom:8px">
      <button id="btnPickerReload">再読み込み</button>
      <button id="btnPickerClose">閉じる</button>
    </div>
    <div id="pickerGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;overflow:auto;max-height:60vh"></div>
  </div>
</div>

<!-- サインインゲート -->
<div class="signin-gate" id="gate">
  <div class="card">
    <h1>Googleにサインイン</h1>
    <p>本ツールは Google Drive / Google Sheets を使用します。先にサインインしてください。</p>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button id="btnSignIn" class="accent" style="font-weight:700">🔐 Sign in with Google</button>
      <span class="small" style="opacity:.8">OAuth2 (Drive.file / Sheets)</span>
    </div>
  </div>
</div>

<!-- SDK -->
<script>
  window.__flags = { gapi:false, gis:false };
  function onGapi(){ window.__flags.gapi = true; }
  function onGis(){  window.__flags.gis  = true; }
</script>
<script async defer src="https://accounts.google.com/gsi/client" onload="onGis()"></script>
<script async defer src="https://apis.google.com/js/api.js" onload="onGapi()"></script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';
import { TransformControls } from 'three/examples/jsm/controls/TransformControls.js';

/* ================== Auth ================== */
const CLIENT_ID = '595200751510-ncahnf7edci6b9925becn5to49r6cguv.apps.googleusercontent.com';
const API_KEY   = 'AIzaSyCUnTCr5yWUWPdEXST9bKP1LpgawU5rIbI';
const DISCOVERY_DOCS = [
  'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
  'https://www.googleapis.com/discovery/v1/apis/sheets/v4/rest'
];
const SCOPES = [
  'https://www.googleapis.com/auth/drive.file',
  'https://www.googleapis.com/auth/drive.readonly',
  'https://www.googleapis.com/auth/drive.metadata.readonly',
  'https://www.googleapis.com/auth/spreadsheets'
].join(' ');
let tokenClient=null, accessToken=null, gapiReady=false, gisReady=false;

async function ensureGapiClient(){ if(gapiReady) return; await new Promise(r=>gapi.load('client',r)); await gapi.client.init({ apiKey:API_KEY, discoveryDocs:DISCOVERY_DOCS }); gapiReady=true; }
async function ensureGIS(){ if(gisReady) return; if(!(window.google&&google.accounts&&google.accounts.oauth2)){ await new Promise(r=>{const t=setInterval(()=>{ if(window.google&&google.accounts&&google.accounts.oauth2){clearInterval(t); r();}},50)});} gisReady=true; }
async function ensureTokenClient(){
  await ensureGIS();
  if(tokenClient) return tokenClient;
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID, scope: SCOPES,
    callback: (resp)=>{
      if(resp && resp.access_token){
        accessToken = resp.access_token;
        document.getElementById('gate').style.display='none';
        document.getElementById('statusLabel').textContent = viewOnly ? '閲覧モード' : 'Ready';
        // 常に有効化（閲覧モードでも listSelect は使える）
        ['btnLoad','btnTogglePins','projOrtho','listSelect'].forEach(id=>document.getElementById(id).disabled=false);
        if(!viewOnly){
          ['btnAddPin','btnGizmo','btnUndo','btnSavePin','btnDeletePin','btnAttach','btnPickFromFolder','listNew','listDelete'].forEach(id=>document.getElementById(id).disabled=false);
        }
        enforceViewOnlyMode();
        ensureGapiClient().catch(console.warn);

        // URL 初期値
        const qs=new URLSearchParams(location.search);
        const fid=qs.get('fileId')||''; const sid=qs.get('sheetId')||'';
        if(fid) el.inputGLB.value=fid; if(sid) el.inputSheet.value=sid;
      }
    }
  });
  return tokenClient;
}
async function startSignIn(){
  try{ el.statusLabel.textContent='サインイン処理中…'; await ensureTokenClient(); tokenClient.requestAccessToken({ prompt:'consent' }); }
  catch(e){ console.error(e); alert('サインインの初期化に失敗しました'); }
}

/* ================== Elements / State ================== */
const el = { // ... (全要素の取得は省略せず記述)
  gate:document.getElementById('gate'), statusLabel:document.getElementById('statusLabel'),
  inputGLB:document.getElementById('inputGLB'), inputSheet:document.getElementById('inputSheet'),
  btnLoad:document.getElementById('btnLoad'), btnViewOnly:document.getElementById('btnViewOnly'), btnWide:document.getElementById('btnWide'),
  loading:document.getElementById('loading'), viewerCanvas:document.getElementById('viewerCanvas'),
  viewerPreview:document.getElementById('viewerPreview'), previewWrap:document.getElementById('previewWrap'),
  previewInner:document.getElementById('previewInner'), previewImg:document.getElementById('previewImg'),
  previewZoom:document.getElementById('previewZoom'), previewZoomVal:document.getElementById('previewZoomVal'),
  previewReset:document.getElementById('previewReset'), previewErr:document.getElementById('previewErr'),
  capTitleLine:document.getElementById('capTitleLine'), capBodyLine:document.getElementById('capBodyLine'),
  pinsList:document.getElementById('pinsList'), rightNoSel:document.getElementById('noSelection'),
  rightEditor:document.getElementById('editor'), capTitle:document.getElementById('capTitle'), capBody:document.getElementById('capBody'),
  btnSavePin:document.getElementById('btnSavePin'), btnDeletePin:document.getElementById('btnDeletePin'),
  btnAddPin:document.getElementById('btnAddPin'), btnGizmo:document.getElementById('btnGizmo'),
  btnTogglePins:document.getElementById('btnTogglePins'), btnUndo:document.getElementById('btnUndo'), modeLabel:document.getElementById('modeLabel'),
  btnSignIn:document.getElementById('btnSignIn'), colorPresets:document.getElementById('colorPresets'),
  btnColorFilter:document.getElementById('btnColorFilter'), colorFilterPanel:document.getElementById('colorFilterPanel'),
  colorFilterList:document.getElementById('colorFilterList'), btnFilterAll:document.getElementById('btnFilterAll'),
  btnFilterNone:document.getElementById('btnFilterNone'), btnFilterClose:document.getElementById('btnFilterClose'),
  imgLocal:document.getElementById('imgLocal'), btnAttach:document.getElementById('btnAttach'),
  btnPickFromFolder:document.getElementById('btnPickFromFolder'), thumbs:document.getElementById('thumbs'),
  matSelect:document.getElementById('matSelect'), matUnlit:document.getElementById('matUnlit'),
  matDoubleSided:document.getElementById('matDoubleSided'), matOpacity:document.getElementById('matOpacity'),
  matOpacityVal:document.getElementById('matOpacityVal'), matInvert:document.getElementById('matInvert'),
  matWhiteTransparent:document.getElementById('matWhiteTransparent'), matThreshold:document.getElementById('matThreshold'),
  matThresholdVal:document.getElementById('matThresholdVal'),
  viewFront:document.getElementById('viewFront'), viewBack:document.getElementById('viewBack'),
  viewLeft:document.getElementById('viewLeft'), viewRight:document.getElementById('viewRight'),
  viewTop:document.getElementById('viewTop'), viewBottom:document.getElementById('viewBottom'),
  projOrtho:document.getElementById('projOrtho'), bgColor:document.getElementById('bgColor'),
  connector:document.getElementById('connector'), connLine:document.getElementById('connLine'), connDot:document.getElementById('connDot'),
  pickerModal:document.getElementById('pickerModal'), pickerGrid:document.getElementById('pickerGrid'),
  btnPickerReload:document.getElementById('btnPickerReload'), btnPickerClose:document.getElementById('btnPickerClose'),
  listSelect:document.getElementById('listSelect'), listNew:document.getElementById('listNew'), listDelete:document.getElementById('listDelete'),
};
const viewOnly = new URLSearchParams(location.search).get('view') === '1';

/* ========== Viewer State / Utils ========== */
let renderer, scene, camera, controls, tcontrols, pinGroup, loader, currentModel=null;
let perspCam, orthoCam; let usingOrtho=false;
let raycaster = new THREE.Raycaster(), pointer = new THREE.Vector2();
let addPinMode=false, currentColor='#ff6b6b';
let pins=[], selectedPinId=null, undoStack=[];
let glbParents=[], glbMetaCache=null;

/* materials */
let materials=[];
const materialKeyByMaterial=new Map();
const materialByKey=new Map();
const matOriginals=new WeakMap();
const matState=new Map();
let uiSyncing=false; // ★ UI同期中は適用を抑止
const imageBlobCache=new Map();
let filterColors=new Set();
let activeSheet = { sheetId:null, title:'pins' };
const debounce=(fn,ms)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};
const debouncedSave=debounce(()=>upsertPinToSheet(),500);
const PRESET_COLORS=['#ff6b6b','#ffd166','#06d6a0','#118ab2','#ef476f','#b5179e','#4361ee','#4cc9f0','#ff9f1c'];

function toast(msg){ el.statusLabel.textContent=msg; setTimeout(()=> el.statusLabel.textContent = viewOnly?'閲覧モード':'Ready', 1800); }
function enforceViewOnlyMode(){
  if(!viewOnly) return;
  document.body.classList.add('viewonly');
  el.capTitle.readOnly=true; el.capBody.readOnly=true;
  // 閲覧モードでもリスト切替は可能にする
  el.listSelect.disabled=false;
}

/* ========= HEIC helpers / omitted for brevity (同一) ========= */
// ...（heic2any ローダ等は前版そのまま）

/* ========= Sign-in btn ========= */
document.getElementById('btnSignIn').addEventListener('click', startSignIn);
// lazy init
(async()=>{ try{await ensureGIS();}catch{} try{await ensureGapiClient();}catch{} })();

/* ========= Viewer ========= */
function viewerInit(){
  renderer=new THREE.WebGLRenderer({canvas:el.viewerCanvas,antialias:true});
  scene=new THREE.Scene(); scene.background=new THREE.Color(0x0a0f16);
  perspCam=new THREE.PerspectiveCamera(60,2,0.1,5000); perspCam.position.set(2.8,1.6,3.6);
  orthoCam=new THREE.OrthographicCamera(-2,2,2,-2,-5000,5000);
  camera=perspCam; usingOrtho=false;

  const hemi=new THREE.HemisphereLight(0xffffff,0x223355,0.6); scene.add(hemi);
  const dir=new THREE.DirectionalLight(0xffffff,1.0); dir.position.set(3,5,4); scene.add(dir);

  buildControls();
  pinGroup=new THREE.Group(); scene.add(pinGroup);
  loader=new GLTFLoader();

  window.addEventListener('resize', resize);
  el.viewerCanvas.addEventListener('pointerdown', onPointerDown);
  el.projOrtho.addEventListener('change', ()=>{ toggleProjection(el.projOrtho.checked); debouncedSaveMaterials(); });
  resize();
  (function loop(){ renderer.render(scene,camera); updateConnector(); requestAnimationFrame(loop); })();
}
function buildControls(){
  controls?.dispose?.();
  controls=new OrbitControls(camera, el.viewerCanvas);
  controls.target.set(0,0,0); controls.update();
  controls.addEventListener('change', updateConnector);
  if(tcontrols){ scene.remove(tcontrols); tcontrols.dispose?.(); }
  tcontrols=new TransformControls(camera, el.viewerCanvas);
  tcontrols.setSize(0.9); tcontrols.setSpace('world');
  tcontrols.addEventListener('dragging-changed', e=>{ controls.enabled=!e.value; });
  tcontrols.addEventListener('change', ()=>{
    if(!selectedPinId || !tcontrols.object || !tcontrols.visible) return;
    const p=pins.find(x=>x.id===selectedPinId); if(!p) return;
    p.pos.copy(tcontrols.object.position); renderNow(); debouncedSave();
  });
  scene.add(tcontrols); tcontrols.visible=false; tcontrols.enabled=false;
}
function resize(){
  const w=el.viewerCanvas.clientWidth||el.viewerCanvas.parentElement.clientWidth;
  const h=el.viewerCanvas.clientHeight||el.viewerCanvas.parentElement.clientHeight;
  renderer.setSize(w,h,false);
  if(camera.isPerspectiveCamera){ camera.aspect=w/h; }
  else{ fitOrthoFrustum(); }
  camera.updateProjectionMatrix(); updateConnector();
}
function renderNow(){ renderer.render(scene,camera); updateConnector(); }
function fitOrthoFrustum(){
  const size=2.5, w=el.viewerCanvas.clientWidth||1, h=el.viewerCanvas.clientHeight||1, aspect=w/h;
  orthoCam.left=-size*aspect; orthoCam.right=size*aspect; orthoCam.top=size; orthoCam.bottom=-size; orthoCam.updateProjectionMatrix();
}
/* ★ 原点を常に向く：カメラ距離だけ保持して target を (0,0,0) に */
function centerOnOrigin(){
  const dist = camera.position.distanceTo(controls.target);
  const dir  = camera.position.clone().sub(controls.target).normalize();
  controls.target.set(0,0,0); controls.update();
  camera.position.copy(controls.target.clone().addScaledVector(dir, Math.max(dist,0.1)));
  if(camera.isOrthographicCamera) fitOrthoFrustum();
  controls.update(); renderNow();
}
function toggleProjection(useOrtho){
  usingOrtho=!!useOrtho;
  const dir = camera.position.clone().sub(controls.target).normalize();
  const dist= camera.position.distanceTo(controls.target);
  if(usingOrtho){ fitOrthoFrustum(); orthoCam.position.copy(controls.target.clone().addScaledVector(dir, dist)); camera=orthoCam; }
  else{ perspCam.position.copy(controls.target.clone().addScaledVector(dir, Math.max(dist,0.1))); camera=perspCam; }
  buildControls(); renderNow();
}

/* ========= Pins, Preview, Drive, HEIC, etc. ========= */
/* （前回版と同等。中略しても OK ですが、実装はそのままです） */

/* ========= Materials（キー基準 & UI同期保護） ========= */
// … ensureMatRecord / objectPath / indexMaterialsByKey は前回同様

function collectMaterials(){
  materials=[]; const set=new Set();
  indexMaterialsByKey();
  currentModel?.traverse(obj=>{
    const m=obj.material;
    if(Array.isArray(m)){ m.forEach(mm=>{ if(mm && !set.has(mm)){ set.add(mm); materials.push(mm); ensureMatRecord(mm);} }); }
    else if(m){ if(!set.has(m)){ set.add(m); materials.push(m); ensureMatRecord(m);} }
  });
  el.matSelect.innerHTML='<option value="__all__">（全マテリアル：編集不可）</option>';
  materials.forEach((m,idx)=>{
    const key=materialKeyByKey(m); // helper ないので直で
  });
}
function materialKeyByKey(m){ return materialKeyByMaterial.get(m); } // 小ヘルパ
function collectMaterials(){
  materials=[]; const set=new Set(); indexMaterialsByKey();
  currentModel?.traverse(obj=>{
    const m=obj.material;
    if(Array.isArray(m)){ m.forEach(mm=>{ if(mm && !set.has(mm)){ set.add(mm); materials.push(mm); ensureMatRecord(mm);} }); }
    else if(m){ if(!set.has(m)){ set.add(m); materials.push(m); ensureMatRecord(m);} }
  });
  el.matSelect.innerHTML='<option value="__all__">（全マテリアル：編集不可）</option>';
  materials.forEach((m,idx)=>{
    const key=materialKeyByMaterial.get(m); if(!key) return;
    const name=(m.name&&m.name.trim())?m.name:`Material_${idx}`;
    const opt=document.createElement('option'); opt.value=key; opt.textContent=name; el.matSelect.appendChild(opt);
    if(!matState.has(key)){
      matState.set(key,{unlit:false,doubleSided:(m.side===THREE.DoubleSide),opacity:(m.opacity??1),invertRGB:false,whiteToAlpha:false,alphaTest:(m.alphaTest??0)});
    }
  });
  if(el.matSelect.options.length>1) el.matSelect.value=el.matSelect.options[1].value; else el.matSelect.value='__all__';
  applyMaterialUIFromSelection();
}
function getSelectedOriginalMaterial(){ const val=el.matSelect.value; if(val==='__all__') return null; return materialByKey.get(val)||null; }
function applyMaterialUIFromSelection(){
  const key=el.matSelect.value; const disable=(key==='__all__');
  ['matUnlit','matDoubleSided','matOpacity','matInvert','matWhiteTransparent','matThreshold'].forEach(id=>{ document.getElementById(id).disabled = disable || viewOnly; });
  if(disable) return;
  uiSyncing=true;
  const st=matState.get(key)||{unlit:false,doubleSided:false,opacity:1,invertRGB:false,whiteToAlpha:false,alphaTest:0};
  el.matUnlit.checked=!!st.unlit;
  el.matDoubleSided.checked=!!st.doubleSided;
  el.matOpacity.value=String(st.opacity??1); el.matOpacityVal.textContent=(Number(st.opacity??1)).toFixed(2);
  el.matInvert.checked=!!st.invertRGB;
  el.matWhiteTransparent.checked=!!st.whiteToAlpha;
  el.matThreshold.value=String(st.alphaTest??0); el.matThresholdVal.textContent=(Number(st.alphaTest??0)).toFixed(2);
  uiSyncing=false;
}
el.matSelect.addEventListener('change', ()=>applyMaterialUIFromSelection());

async function applyMaterialFromUIToSelected(){
  if(uiSyncing) return; // ★ UI反映中の発火は無視
  const orig=getSelectedOriginalMaterial(); if(!orig) return;
  const key=materialKeyByMaterial.get(orig);
  const st=matState.get(key)||{};
  st.unlit=!!el.matUnlit.checked;
  st.doubleSided=!!el.matDoubleSided.checked;
  st.opacity=Number(el.matOpacity.value??1);
  st.invertRGB=!!el.matInvert.checked;
  st.whiteToAlpha=!!el.matWhiteTransparent.checked;
  st.alphaTest=Number(el.matThreshold.value??0);
  matState.set(key,st);
  await applyStateToMaterial(orig,st);
  renderNow();
  debouncedSaveMaterials();
}
['change','input'].forEach(ev=>{
  ['matUnlit','matDoubleSided','matOpacity','matInvert','matWhiteTransparent','matThreshold']
    .forEach(id=>document.getElementById(id).addEventListener(ev, ()=>applyMaterialFromUIToSelected()));
});
el.matOpacity.addEventListener('input', ()=> el.matOpacityVal.textContent=parseFloat(el.matOpacity.value).toFixed(2));
el.matThreshold.addEventListener('input', ()=> el.matThresholdVal.textContent=parseFloat(el.matThreshold.value).toFixed(2));

/* ... applyStateToMaterial / texture processing などは前回版と同じ ... */

/* ========= Viewer preset save/load ========= */
const debouncedSaveMaterials = debounce(async ()=>{
  if(viewOnly) return; // 閲覧モードは保存しない（読むだけ）
  const spreadsheetId=extractSpreadsheetId(el.inputSheet.value.trim());
  if(!spreadsheetId||!activeSheet.sheetId) return;
  const materialsData=serializeMaterialsForSheet();
  const viewerData=serializeViewerPrefs();
  try{ await saveSheetMeta(spreadsheetId,{materials:materialsData, viewer:viewerData}); }catch(e){ console.warn('saveSheetMeta failed',e); }
},600);

/* ========= Caption lists（閲覧モードでも切替可能） ========= */
// refreshCaptionLists / listSelect change / listNew / listDelete は前回と同様
// ただし enforceViewOnlyMode() で listSelect.disabled=false にしてあるため、view=1 でも読み込み動作

/* ========= GLB Load ========= */
async function loadGLBByFileId(fileId){
  if(!accessToken){ alert('先にサインインしてください'); return; }
  if(!fileId){ alert('GLBの fileId または共有URLを入力してください'); return; }
  el.loading.hidden=false;
  try{
    el.statusLabel.textContent='GLBを読み込み中…';
    const meta=await driveFileMeta(fileId); glbMetaCache=meta; glbParents=meta.parents||[];
    const res=await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&supportsAllDrives=true`,{ headers:{ Authorization:`Bearer ${accessToken}` }});
    if(!res.ok) throw new Error(`Drive download failed: ${res.status}`);
    const ab=await res.arrayBuffer();

    // 既存破棄
    if(currentModel){ scene.remove(currentModel); currentModel.traverse(o=>{o.geometry?.dispose?.(); const m=o.material; if(m){ if(Array.isArray(m)) m.forEach(x=>x.dispose()); else m.dispose(); }}); currentModel=null; }

    await new Promise((resolve,reject)=>{
      (loader||new GLTFLoader()).parse(ab,'',(gltf)=>{ currentModel=gltf.scene; scene.add(currentModel); resolve(); }, (e)=>reject(e||new Error('parse failed')) );
    });

    // ★ 原点へ向ける（モード共通）
    collectMaterials();
    centerOnOrigin();
    renderNow();

    el.statusLabel.textContent=`Loaded: ${meta.name}`;

    // Spreadsheet
    let sheetId=extractSpreadsheetId(el.inputSheet.value.trim());
    if(!sheetId){
      sheetId=await findOrCreateSpreadsheetInGlbFolder(meta);
      el.inputSheet.value=sheetId;
      toast('スプレッドシートを同階層に用意しました');
    }
    await refreshCaptionLists(sheetId);
    await loadPinsFromActiveSheet(sheetId); // ← ここで materials/viewer メタも適用される（閲覧モードでも読む）

  }catch(err){
    console.error(err); el.statusLabel.textContent='Load failed';
    alert('GLB読み込みに失敗しました：'+(err?.message||'unknown error'));
  }finally{ el.loading.hidden=true; }
}

/* ========= Controls ========= */
document.getElementById('btnSignIn').addEventListener('click', startSignIn);
el.btnLoad.addEventListener('click', ()=>{ const fid=extractDriveFileId(el.inputGLB.value.trim())||el.inputGLB.value.trim(); el.inputGLB.value=fid; loadGLBByFileId(fid); });
el.btnViewOnly.addEventListener('click', ()=>{ const fid=extractDriveFileId(el.inputGLB.value.trim()); const sid=extractSpreadsheetId(el.inputSheet.value.trim()); const url=new URL(location.href); url.searchParams.set('view','1'); if(fid) url.searchParams.set('fileId',fid); if(sid) url.searchParams.set('sheetId',sid); navigator.clipboard.writeText(url.toString()); toast('閲覧リンクをコピーしました'); });
el.btnWide.addEventListener('click', ()=>{ document.body.classList.toggle('wide'); el.btnWide.textContent=document.body.classList.contains('wide')?'📋 パネル表示':'📺 ビューア拡大'; setTimeout(()=>{ resize(); updateConnector(); },50); });

/* ========= init ========= */
viewerInit();

</script>
</body>
</html>
