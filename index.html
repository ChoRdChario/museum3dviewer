<!DOCTYPE html>
<html lang="ja">
<head>
  <script id="lm-importmap-three" type="importmap">{
    "imports": {
      "three": "https://unpkg.com/three@0.159.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.159.0/examples/jsm/"
    }
  }</script>

  <style id="lm-fallback-style">
    :root { color-scheme: dark; }
    body { margin:0; background:#111; color:#e6e6e6; font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    #right { width:360px; max-width:38vw; padding:12px; box-sizing:border-box; }
    .panel { background:#16181b; border:1px solid #272a30; border-radius:10px; padding:12px; margin:12px 0; }
    .panel h2 { margin:0 0 8px; font-size:15px; }
    label { display:block; margin:4px 0; font-size:12px; opacity:.8; }
    input,select,button { font:inherit; }
    input[type="text"] { width:100%; box-sizing:border-box; padding:4px 6px; background:#0b0d11; border:1px solid #272a30; border-radius:4px; color:inherit; }
    button { padding:4px 10px; border-radius:4px; border:1px solid #272a30; background:#1f2933; color:inherit; cursor:pointer; }
    button:hover { background:#243447; }
    small { opacity:.7; font-size:11px; }
  </style>

  <script>
  (function(){
    const el = document.currentScript.previousElementSibling;
    if (!el || el.id!=="lm-fallback-style") return;
    try {
      const test = document.createElement("div");
      test.style.setProperty("color", "rgb(1,2,3)", "important");
      const supported = test.style.getPropertyPriority("color") === "important";
      if (supported) {
        // modern browser - leave styling to the main CSS below
        el.remove();
      }
    } catch(e){}
  })();
  </script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LociMyu v6.6 (ESM/CDN)</title>
  <link rel="icon" href="data:,"/>

  <meta name="google-oauth-client_id" content="595200751510-ncahnf7edci6b9925becn5to49r6cguv.apps.googleusercontent.com"/>
  <meta name="google-api-key" content="AIzaSyCUnTCr5yWUWPdEXST9bKP1LpgawU5rIbI"/>
  <script defer async src="https://accounts.google.com/gsi/client"></script>

  <style>
    :root{
      --bg:#0f1115; --panel:#0b0d11; --line:#1f2937; --acc:#94a3b8; --text:#cbd5e1; --sel:#60a5fa;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    #app{display:flex;height:100%;}
    #stage{flex:1;position:relative;background:var(--panel);}
    #ui{width:360px;max-width:360px;min-width:320px;border-left:1px solid var(--line);
        display:flex;flex-direction:column;overflow:hidden;}
    header#topbar{display:flex;justify-content:space-between;align-items:center;
      padding:8px 12px;border-bottom:1px solid var(--line);}
    header #brand{font-weight:600;opacity:.85}
    button,select,input{background:#111827;border:1px solid var(--line);color:var(--text);
      border-radius:6px;font:inherit;padding:4px 8px;box-sizing:border-box;}
    button{cursor:pointer;}
    button.primary{background:#1d4ed8;border-color:#1d4ed8;}
    button.primary:disabled{opacity:.5;cursor:default;}
    button.full{width:100%;}
    main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
    .panel{padding:8px 10px;}
    .panel h2{margin:0 0 4px;font-size:13px;font-weight:600;}
    .row{display:flex;gap:6px;}
    .row>*{flex:1;}
    .small{font-size:11px;opacity:.7;}
    nav.tabs{display:flex;border-bottom:1px solid var(--line);margin-top:4px;}
    nav.tabs button{flex:1;border-radius:0;border:none;border-bottom:2px solid transparent;
      padding:6px 4px;font-size:12px;background:transparent;}
    nav.tabs button[aria-selected="true"]{border-bottom-color:var(--sel);color:var(--sel);}
    .pane{display:none;padding:8px 10px 12px;overflow:auto;}
    .pane[data-active="true"]{display:block;}
    .hint{font-size:11px;opacity:.7;margin-bottom:4px;}
    .grp{margin-bottom:10px;}
    #viewer-canvas{width:100%;height:100%;}
    #pinColorChips{display:flex;flex-wrap:wrap;gap:4px;}
    #pinColorChips button{width:18px;height:18px;border-radius:50%;border:1px solid rgba(15,23,42,.8);padding:0;}
    #pinFilterChips{display:flex;gap:4px;flex-wrap:wrap;}
    #caption-list{border:1px solid var(--line);border-radius:6px;min-height:120px;max-height:260px;overflow:auto;font-size:12px;}
    .lm-caption-row{display:flex;align-items:center;gap:6px;padding:4px 6px;border-bottom:1px solid rgba(15,23,42,.6);cursor:pointer;}
    .lm-caption-row:last-child{border-bottom:none;}
    .lm-caption-row.active{background:rgba(37,99,235,.25);}
    .lm-caption-color-dot{width:10px;height:10px;border-radius:50%;border:1px solid rgba(15,23,42,.9);}
    .lm-caption-title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .lm-caption-meta{font-size:11px;opacity:.8;}
    #images-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(72px,1fr));gap:6px;}
    #images-grid .thumb{position:relative;border-radius:6px;overflow:hidden;border:1px solid var(--line);}
    #images-grid img{display:block;width:100%;height:auto;}
    #images-grid .thumb span{position:absolute;left:4px;bottom:4px;font-size:10px;
      background:rgba(15,23,42,.8);padding:1px 3px;border-radius:3px;}
    #sheet-rename-root{margin-top:8px;border-top:1px dashed var(--line);padding-top:6px;}
    #sheet-rename-root h3{margin:0 0 4px;font-size:12px;}
    #sheet-rename-root ul{margin:0;padding-left:16px;font-size:12px;max-height:120px;overflow:auto;}
    #sheet-rename-root li{margin:2px 0;}
    .mat-card{border:1px solid var(--line);border-radius:8px;padding:8px;margin-bottom:8px;}
    .mat-card h4{margin:0 0 4px;font-size:12px;}
    .inline{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
    .inline label{display:inline-flex;align-items:center;gap:4px;margin:0;font-size:12px;}
    #pm-opacity{display:flex;align-items:center;gap:6px;}
    #pm-opacity-range{flex:1;}
    #pm-opacity-val{min-width:40px;text-align:right;font-size:12px;}
  </style>
</head>
<body>
  <div id="app">
    <div id="stage">
      <canvas id="viewer-canvas"></canvas>
    </div>
    <div id="ui">
      <header id="topbar">
        <div id="brand">LociMyu v6.6</div>
        <button id="auth-signin" class="primary">Sign in</button>
      </header>
      <main>
        <div class="panel" id="panel-main">
          <h2>GLB &amp; Save</h2>
          <div class="grp">
            <div class="hint">GLB URL or Drive fileId</div>
            <div class="row">
              <input id="glbUrl" placeholder="https://... or 1AbCdEf..."/>
              <button id="btnGlb">Load</button>
            </div>
            <div class="row" style="margin-top:8px">
              <select id="save-target-sheet"><option value="">Select sheet…</option></select>
              <button id="save-target-create">Create</button>
            </div>
          </div>

          <nav class="tabs" role="tablist">
            <button id="tab-caption" role="tab" data-tab="caption" aria-selected="true">Caption</button>
            <button id="tab-material" role="tab" data-tab="material" aria-selected="false">Material</button>
            <button id="tab-views" role="tab" data-tab="views" aria-selected="false">Views</button>
          </nav>

          <!-- ★★★ Caption ペイン：data-caption-* 属性と template を追加 ★★★ -->
          <section id="pane-caption" class="pane" data-pane="caption" data-active="true">
            <div class="grp">
              <div class="hint">Pin color</div>
              <div id="pinColorChips" class="chips" data-hook="pin-color" data-caption-color-row></div>
            </div>
            <div class="grp">
              <div class="hint">Filter</div>
              <div id="pinFilterChips" class="chips" data-hook="pin-filter" data-caption-filter-row></div>
            </div>
            <div class="grp">
              <div class="hint">Caption list</div>
              <div id="caption-list" data-hook="caption-list" data-caption-list></div>
            </div>
            <div class="grp">
              <div class="hint">Title / Body</div>
              <input id="caption-title" placeholder="Title" data-hook="caption-title" data-caption-title/>
              <input id="caption-body" placeholder="Body" data-hook="caption-body" data-caption-body/>
            </div>
            <div class="grp">
              <div class="hint">Images (auto from GLB folder)</div>
              <div id="images-grid" data-hook="images-grid" data-caption-images data-caption-image-list></div>
              <template data-caption-image-template>
                <div data-caption-image-item>
                  <img loading="lazy" decoding="async"/>
                </div>
              </template>
              <div class="row" style="margin-top:8px">
                <button id="btnRefreshImages" class="full">Refresh images</button>
              </div>
              <div id="images-status" class="hint" style="margin-top:6px"></div>
            </div>
          </section>
          <!-- ★★★ ここまで Caption ペイン ★★★ -->

          <section id="pane-material" class="pane" data-pane="material" data-active="false">
            <div class="grp">
              <div class="hint">Materials sheet (auto)</div>
              <div class="small">__LM_MATERIALS will be created if not present.</div>
            </div>

            <div class="mat-card">
              <h4>Per-material opacity (saved per sheet)</h4>
              <div id="pm-opacity">
                <select id="pm-material" aria-label="Select material">
                  <option value="">— Select material —</option>
                </select>
                <input id="pm-opacity-range" type="range" min="0" max="1" step="0.01" value="1"/>
                <output id="pm-opacity-val">1.00</output>
              </div>
              <div class="hint">Pick a material, then set its opacity.</div>
            </div>

            <div class="mat-card">
              <h4>Shading</h4>
              <div class="inline">
                <label class="nowrap"><input type="checkbox" id="pm-double-sided"/>Double-sided</label>
                <label class="nowrap"><input type="checkbox" id="pm-unlit"/>Unlit-like</label>
              </div>
              <div class="hint">These settings are saved per material per sheet.</div>
            </div>

            <div class="mat-card">
              <h4>Chroma key (experimental)</h4>
              <div class="inline">
                <label>Key color <input type="color" id="pm-key-color" value="#00ff00"/></label>
                <label>Tolerance <input type="range" id="pm-key-range" min="0" max="1" step="0.01" value="0.1"/></label>
              </div>
              <div class="hint">Hide mesh areas near the selected color. Saved per material per sheet.</div>
            </div>
          </section>

          <section id="pane-views" class="pane" data-pane="views" data-active="false">
            <div class="grp">
              <div class="hint">Views (coming soon)</div>
              <div class="small">Save camera positions / presets here in future versions.</div>
            </div>
          </section>
        </div>

        <div class="panel">
          <h2>Sheet rename (beta)</h2>
          <div id="sheet-rename-root"></div>
        </div>
      </main>
    </div>
  </div>

  <script type="module" src="./boot.esm.cdn.js"></script>

  <script>
  (function(){
    const btns = document.querySelectorAll('nav.tabs button[role="tab"]');
    const panes = document.querySelectorAll('.pane[data-pane]');
    function activate(tab){
      const target = tab.getAttribute('data-tab');
      btns.forEach(b=>{
        b.setAttribute('aria-selected', b===tab ? 'true' : 'false');
      });
      panes.forEach(p=>{
        p.dataset.active = (p.getAttribute('data-pane')===target ? 'true' : 'false');
      });
    }
    btns.forEach(b=>{
      b.addEventListener('click', ()=>activate(b));
    });
  })();
  </script>

  <script>
  (function(){
    try {
      fetch('./content.js',{method:'HEAD'}).then(function(r){
        if(r && r.ok){
          var s = document.createElement('script');
          s.src = './content.js';
          document.body.appendChild(s);
          console.log('[VSC] content.js loaded');
        } else {
          console.log('[VSC] content.js not present (skipped)');
        }
      }).catch(function(){ console.log('[VSC] content.js check skipped'); });
    } catch(e){
      console.log('[VSC] content.js loader error', e);
    }
  })();
  </script>
</body>
</html>
