<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LociMyu</title>
  <link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" fill="%230b0f14"/><text x="32" y="39" font-size="28" text-anchor="middle" fill="%2353b7ff" font-family="Arial">L</text></svg>'>
  <style>
    :root{ --bg:#0b0f14; --panel:#121922; --text:#e6edf3; --accent:#53b7ff; --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.3);}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .app{display:grid;grid-template-rows:auto 1fr;height:100vh}
    header{display:flex;gap:.75rem;align-items:center;padding:10px 12px;background:linear-gradient(180deg,#0e1520,#0b0f14);border-bottom:1px solid #1e2837}
    .pill{background:rgba(255,255,255,.06);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.08);font-weight:700}
    input[type=text], select, textarea{background:#0f1722;border:1px solid #203049;color:var(--text);border-radius:10px;padding:8px 10px;min-width:240px}
    button{background:#152133;color:var(--text);border:1px solid #223146;border-radius:10px;padding:8px 12px;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    button:hover{background:#1a2b45}
    .accent{border-color:#2c82c9}
    .main{display:grid;grid-template-columns:360px 1fr 420px;gap:10px;padding:10px;height:calc(100vh - 58px)}
    body.wide #leftToolbox, body.wide #rightCaption{display:none}
    body.wide .main{grid-template-columns:1fr}
    .panel{background:#121922;border:1px solid #1e2837;border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;min-height:0}
    .panel h3{margin:0;padding:10px 12px;border-bottom:1px solid #203049;background:#0f1722;font-size:.95rem;font-weight:600}
    .panel .body{padding:10px;overflow:auto}
    #viewer{position:relative}
    #viewerCanvas{display:block;width:100%;height:100%;background:#0a0f16;border-radius:var(--radius)}
    #connector{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}
    #connector line{stroke:#7cc4ff;stroke-width:2;stroke-opacity:.9;filter:url(#dropshadow)}
    #connector circle{fill:#7cc4ff;opacity:.9}
    .hud{position:absolute;left:10px;bottom:10px;display:flex;gap:8px}
    .chip{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px}
    .spinner{position:absolute;inset:0;display:grid;place-items:center;background:linear-gradient(180deg, rgba(10,15,22,.75), rgba(10,15,22,.75));backdrop-filter: blur(2px);}
    .spinner[hidden]{display:none}
    .lds{width:64px;height:64px;border-radius:50%;border:6px solid rgba(255,255,255,.12);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .signin-gate{position:fixed;inset:0;display:grid;place-items:center;background:radial-gradient(1200px 600px at 50% 15%, rgba(83,183,255,.08), transparent 60%), linear-gradient(180deg,#0a0f16,#05070b);z-index:20}
    .card{width:min(560px,92vw);background:#0c1118;border:1px solid #1d2a3d;border-radius:24px;box-shadow:var(--shadow);padding:20px}
    .card h1{margin:4px 0 8px;font-size:1.35rem}
    .card p{color:#c2d0e2;opacity:.9}
    .list{display:flex;flex-direction:column;gap:8px}
    .list .row{display:flex;align-items:center;justify-content:space-between;gap:8px;background:#0f1722;border:1px solid #203049;border-radius:12px;padding:10px;cursor:pointer}
    .row .title{font-weight:600}
    .row .meta{color:#a9b8cf;font-size:.85rem}
    .row:hover{background:#132035}
    .small{font-size:.85rem;color:#a9b8cf}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .field{display:flex;gap:8px;align-items:center;margin:8px 0}
    .field label{min-width:120px;color:#a9b8cf}
    input[type="range"]{width:160px}
    .viewgrid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .thumb{position:relative}
    .thumb img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid #223146;display:block}
    .thumb .del{position:absolute;top:-6px;right:-6px;width:20px;height:20px;border-radius:50%;background:#1e2a3b;border:1px solid #334966;color:#e8f0ff;line-height:18px;text-align:center;font-weight:700;cursor:pointer}
    .thumb .del:hover{background:#2a3b55}
    #viewerPreview{position:absolute;top:10px;right:10px;max-height:60%;border:1px solid #203049;border-radius:8px;background:#0a0f16cc;backdrop-filter: blur(2px);display:grid;grid-template-rows:auto 1fr auto;gap:0;resize:both;overflow:hidden;min-width:260px;min-height:200px}
    #viewerPreview.hidden{display:none}
    #previewControls{position:sticky;top:0;background:#0a0f16f0;border-bottom:1px solid #203049;padding:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;z-index:1}
    #previewWrap{position:relative;overflow:auto}
    #previewInner{transform-origin: top left;}
    #previewInner img{display:block;max-width:none;max-height:none;border-radius:0}
    #viewerPreview .cap{border-top:1px solid #203049;background:#0a0f16f0;display:grid;grid-template-rows:auto auto;gap:4px;padding:6px 8px}
    #capTitleLine{font-weight:700}
    #capBodyLine{font-size:.85rem;color:#c9d7ea;max-height:8em;overflow:auto}
    body.viewonly #pinTools{display:none}
    body.viewonly #btnSavePin,
    body.viewonly #btnDeletePin,
    body.viewonly #btnAttach,
    body.viewonly #btnPickFromFolder,
    body.viewonly #autosaveTip,
    body.viewonly #listNew,
    body.viewonly #listDelete { display:none; }
    @media (max-width:1100px){
      .main{grid-template-columns:1fr; grid-template-rows: 360px 1fr 480px}
    }
  /* ===== M3D UI vNext (namespaced) ===== */
.m3d-ui-vnext #rightCaption{ display:none !important; }
@media (max-width: 900px){
  .m3d-ui-vnext #leftToolbox, 
  .m3d-ui-vnext #rightCaption{ display:none !important; }
}

/* Overlay caption layer (desktop) */
#m3d-caption-layer{
  position:absolute; inset:0;
  pointer-events:none; z-index: 1200;
}
#m3d-caption-layer .m3d-capwin{
  position:absolute; min-width:220px; max-width:340px;
  background:#0b132b; color:#d6e4ff; border:1px solid #1f2a44; border-radius:12px;
  box-shadow:0 8px 28px rgba(0,0,0,.35);
  pointer-events:auto; user-select:none; overflow:hidden;
}
.m3d-capwin__titlebar{
  cursor:move; padding:8px 12px; font-weight:600; background:#16223a;
  display:flex; align-items:center; gap:8px;
}
.m3d-capwin__close{
  margin-left:auto; background:transparent; border:none; color:#aac4ff; font-size:16px; cursor:pointer;
}
.m3d-capwin__body{ padding:10px 12px; }
.m3d-capwin__img{ display:block; max-width:240px; max-height:180px; width:auto; height:auto; border-radius:8px; margin:6px 0; }
.m3d-capwin__meta{ font-size:12px; opacity:.8; }
.m3d-capwin__actions{ display:flex; gap:8px; margin-top:8px; }

/* Mobile caption panel (single) */
#m3d-mobile-caption{
  display:none;
  position:relative;
  background:#0b132b; color:#d6e4ff; border-top:1px solid #1f2a44;
  padding:10px 12px; z-index:1100;
}
@media (max-width: 900px){
  #m3d-mobile-caption{ display:block; }
}
#m3d-mobile-caption .m3d-cap__img{
  max-width:50vw; max-height:40vh; width:auto; height:auto; border-radius:8px; display:block;
}
#m3d-mobile-caption .m3d-cap__placeholder{
  border:1px dashed #345; border-radius:10px; color:#9aa;
  min-height:80px; display:flex; align-items:center; justify-content:center; margin:6px 0;
}

/* Ensure viewer container is a positioning context for overlay */
.m3d-ui-vnext #viewer{ position:relative; }

/* vNext: right caption panel split (desktop) */
@media (min-width: 901px){
  #rightCaption .body{
    display:grid; grid-template-rows: 7fr 3fr; gap:10px;
  }
  #m3d-caplist{ overflow:auto; }
  #m3d-capeditor{ overflow:auto; }
}

</style>

  <!-- ES Modules -->
  <script type="importmap">
  { "imports"": {\n      ""three"": ""https://unpkg.com/three@0.157.0/build/three.module.js"",\n      ""three/examples/jsm/"": ""https://unpkg.com/three@0.157.0/examples/jsm/""\n    } }\n  </script>
  <!-- HEIC fallback -->
  <script src="https://unpkg.com/heic2any@0.0.5/dist/heic2any.min.js"></script>
</head>
<body>
<div class="app">
  <header>
    <span class="pill">LociMyu</span>
    <div class="toolbar" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input id="inputGLB" type="text" placeholder="GLB fileId or share URL" />
      <input id="inputSheet" type="text" placeholder="SpreadsheetId or share URLÔºàÁ©∫„Å™„ÇâËá™Âãï‰ΩúÊàêÔºâ" />
      <button id="btnLoad" class="accent" disabled>GLB„ÇíË™≠„ÅøËæº„ÇÄ</button>
      <button id="btnViewOnly">Èñ≤Ë¶ß„É™„É≥„ÇØ„ÇíÁîüÊàê</button>
      <button id="btnWide">üì∫ „Éì„É•„Éº„Ç¢Êã°Â§ß</button>
      <span id="statusLabel" class="chip">„Çµ„Ç§„É≥„Ç§„É≥ÂæÖ„Å°‚Ä¶</span>
    </div>
  </header>

  <div class="main">
    <!-- Â∑¶Ôºö„ÉÑ„Éº„É´ -->
    <section class="panel" id="leftToolbox">
      <h3>„ÉÑ„Éº„É´„Éú„ÉÉ„ÇØ„ÇπÔºà„Éû„ÉÜ„É™„Ç¢„É´ & „Ç´„É°„É© & „Éî„É≥Ôºâ</h3>
      <div class="body">
        <div id="pinTools">
          <div class="small">Shift + „ÇØ„É™„ÉÉ„ÇØ „Åß„Éî„É≥„ÇíÈÖçÁΩÆÔºàÁ∑®ÈõÜ„É¢„Éº„Éâ„ÅÆ„ÅøÔºâ</div>
          <div class="flex" style="margin-top:6px;margin-bottom:6px">
            <button id="btnAddPin" disabled>Ôºã „Éî„É≥ËøΩÂä†„É¢„Éº„Éâ</button>
            <button id="btnGizmo" disabled>„ÇÆ„Ç∫„É¢: OFF</button>
            <button id="btnUndo" disabled>Ctrl+Z</button>
            <button id="btnTogglePins" disabled>„Éî„É≥Ë°®Á§∫: ON</button>
          </div>
          <div class="flex" style="align-items:center;flex-wrap:nowrap">
            <div class="small">„Éî„É≥Ëâ≤:</div>
            <div id="colorPresets" class="flex" style="flex-wrap:nowrap"></div>
          </div>
          <hr style="border-color:#203049;border-width:1px 0;margin:12px 0">
        </div>

        <div class="small" style="margin:4px 0 6px">„Éû„ÉÜ„É™„Ç¢„É´Á∑®ÈõÜÔºà„Ç≠„É£„Éó„Ç∑„Éß„É≥„Ç∑„Éº„Éà„Åî„Å®„Å´‰øùÂ≠òÔºâ</div>
        <div class="field"><label>ÂØæË±°</label>
          <select id="matSelect"><option value="__all__">ÔºàÂÖ®„Éû„ÉÜ„É™„Ç¢„É´ÔºöÁ∑®ÈõÜ‰∏çÂèØÔºâ</option></select>
        </div>
        <div class="field"><label>Unlit</label><input id="matUnlit" type="checkbox"><span class="small">ÊòéÊöó„Å™„Åó</span></div>
        <div class="field"><label>Ë£èÈù¢ÊèèÁîª</label><input id="matDoubleSided" type="checkbox"></div>
        <div class="field"><label>‰∏çÈÄèÊòéÂ∫¶</label><input id="matOpacity" type="range" min="0" max="1" step="0.01" value="1"><span id="matOpacityVal" class="small">1.00</span></div>
        <div class="field"><label>„ÉÜ„ÇØ„Çπ„ÉÅ„É£ÂèçËª¢</label><input id="matInvert" type="checkbox"></div>
        <div class="field"><label>ÁôΩ‚ÜíÈÄèÊòé</label><input id="matWhiteTransparent" type="checkbox"></div>
        <div class="field"><label>ÈñæÂÄ§ÔºàŒ±TestÔºâ</label><input id="matThreshold" type="range" min="0" max="1" step="0.01" value="0"><span id="matThresholdVal" class="small">0.00</span></div>

        <hr style="border-color:#203049;border-width:1px 0;margin:12px 0">

        <div class="small" style="margin:4px 0 6px">„Éì„É•„ÉºÔºà„Ç≠„É£„Éó„Ç∑„Éß„É≥„Ç∑„Éº„Éà„Åî„Å®„Å´‰øùÂ≠òÔºâ</div>
        <div class="viewgrid" style="margin-bottom:8px">
          <button id="viewFront">ÂâçÈù¢</button>
          <button id="viewBack">ËÉåÈù¢</button>
          <button id="viewLeft">Â∑¶Èù¢</button>
          <button id="viewRight">Âè≥Èù¢</button>
          <button id="viewTop">‰∏äÈù¢</button>
          <button id="viewBottom">‰∏ãÈù¢</button>
        </div>
        <div class="field"><label>Âπ≥Ë°åÊäïÂΩ±</label><input id="projOrtho" type="checkbox"><span class="small">ON: Orthographic</span></div>
        <div class="field"><label>ËÉåÊôØËâ≤</label><input id="bgColor" type="color" value="#0a0f16"></div>
      </div>
    </section>

    <!-- ‰∏≠Â§ÆÔºö„Éì„É•„Éº„Ç¢ -->
    <section class="panel" id="viewer">
      <div class="spinner" id="loading" hidden><div class="lds"></div></div>
      <canvas id="viewerCanvas"></canvas>
      <svg id="connector">
        <defs><filter id="dropshadow" x="-20%" y="-20%" width="140%"><feDropShadow dx="0" dy="0" stdDeviation="2" flood-color="#001a33" flood-opacity="0.9"/></filter></defs>
        <line id="connLine" x1="0" y1="0" x2="0" y2="0" style="display:none"/>
        <circle id="connDot" r="3" cx="0" cy="0" style="display:none"/>
      </svg>

      <div id="viewerPreview" class="hidden">
        <button id="previewClose" aria-label="Èñâ„Åò„Çã" style="position:absolute;right:8px;top:8px;z-index:3;background:#162234;border:1px solid #24324b;color:#e6edf3;border-radius:10px;padding:6px 10px;cursor:pointer">Èñâ„Åò„Çã</button>
        <div id="previewControls">
          <span class="small">ÂÄçÁéá</span>
          <input id="previewZoom" type="range" min="0.1" max="3" step="0.05" value="1">
          <span id="previewZoomVal" class="small">1.00√ó</span>
          <button id="previewReset">„É™„Çª„ÉÉ„Éà</button>
          <span id="previewErr" class="small" style="margin-left:auto;color:#ffb4b4;display:none">ÁîªÂÉè„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü</span>
        </div>
        <div id="previewWrap" style="position:relative"><div id="previewInner"><img id="previewImg" alt="preview"/></div><div id="previewMsg" class="small" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:#9fb3c8;display:none;text-align:center;pointer-events:none">ÁîªÂÉè„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div></div>
        <div class="cap">
          <div id="capTitleLine"></div>
          <div id="capBodyLine"></div>
        </div>
      </div>

      <div class="hud"><div class="chip" id="modeLabel">Orbit</div></div>
    </section>

    <!-- Âè≥Ôºö„Ç≠„É£„Éó„Ç∑„Éß„É≥ -->
    <section class="panel" id="rightCaption">
      <h3>„Ç≠„É£„Éó„Ç∑„Éß„É≥</h3>
      <div class="body">
        <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:6px">
          <div class="flex" style="gap:8px;align-items:center">
            <div class="small">„Éî„É≥‰∏ÄË¶ß</div>
            <button id="btnColorFilter">Ëâ≤„ÅßÁµû„ÇäËæº„Åø ‚ñæ</button>
          </div>
          <div class="flex" style="gap:6px;align-items:center">
            <select id="listSelect" disabled></select>
            <button id="listNew" disabled>Êñ∞Ë¶è</button>
            <button id="listDelete" disabled>ÂâäÈô§</button>
          </div>
        </div>

        <div id="colorFilterPanel" class="panel body" style="display:none;margin-bottom:8px;padding:8px">
          <div class="small" style="margin-bottom:6px">Ë°®Á§∫„Åô„ÇãËâ≤„ÇíÈÅ∏ÊäûÔºàË§áÊï∞ÂèØÔºâ</div>
          <div id="colorFilterList"></div>
          <div class="flex" style="justify-content:flex-end;margin-top:8px">
            <button id="btnFilterAll">„Åô„Åπ„Å¶</button>
            <button id="btnFilterNone">„Å™„Åó</button>
            <button id="btnFilterClose">Èñâ„Åò„Çã</button>
          </div>
        </div>

        <div id="pinsList" class="list" style="margin:8px 0 14px"></div>
        <div id="noSelection">„Éî„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>

        <div id="editor" class="hidden">
          <div class="field" style="width:100%"><label>„Çø„Ç§„Éà„É´</label><input id="capTitle" type="text" placeholder="„Çø„Ç§„Éà„É´" style="flex:1"/></div>
          <div class="field" style="width:100%"><label>Êú¨Êñá</label><textarea id="capBody" rows="6" placeholder="„Ç≠„É£„Éó„Ç∑„Éß„É≥Êú¨Êñá" style="flex:1"></textarea></div>

          <div class="flex">
            <input id="imgLocal" type="file" accept="image/*,.heic,.HEIC" style="display:none"/>
            <button id="btnAttach" class="accent" disabled>ÁîªÂÉè„ÇíÊ∑ª‰ªò„Åó„Å¶Drive„Å´‰øùÂ≠ò</button>
            <button id="btnPickFromFolder" class="accent" disabled>Drive„Åã„Çâ‰øùÂ≠ò</button>
          </div>

          <div class="thumbs" id="thumbs"></div>

          <div class="flex" style="justify-content:space-between;margin-top:8px;margin-bottom:8px">
            <button id="btnSavePin" class="accent" disabled>‰øùÂ≠òÔºàSheetsÔºâ</button>
            <button id="btnDeletePin" style="border-color:#5a1f26;color:#ffb4b4" disabled>„Éî„É≥ÂâäÈô§</button>
            <span class="small" id="autosaveTip">ÂÖ•Âäõ„ÅØÊï∞ÁßíÂæå„Å´Ëá™Âãï‰øùÂ≠ò</span>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- DriveÁîªÂÉè„Éî„ÉÉ„Ç´„Éº -->
<div id="pickerModal" class="signin-gate" style="display:none;background:rgba(0,0,0,.55)">
  <div class="card" style="width:min(90vw,980px);max-height:80vh;overflow:hidden">
    <h1 style="margin:0 0 6px">Drive„Åã„Çâ‰øùÂ≠ò</h1>
    <div class="flex" style="justify-content:flex-end;margin-bottom:8px">
      <button id="btnPickerReload">ÂÜçË™≠„ÅøËæº„Åø</button>
      <button id="btnPickerClose">Èñâ„Åò„Çã</button>
    </div>
    <div id="pickerGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;overflow:auto;max-height:60vh"></div>
  </div>
</div>

<!-- „Çµ„Ç§„É≥„Ç§„É≥„Ç≤„Éº„Éà -->
<div class="signin-gate" id="gate">
  <div class="card">
    <h1>Google„Å´„Çµ„Ç§„É≥„Ç§„É≥</h1>
    <p>Êú¨„ÉÑ„Éº„É´„ÅØ Google Drive / Google Sheets „Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇÂÖà„Å´„Çµ„Ç§„É≥„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button id="btnSignIn" class="accent" style="font-weight:700">üîê Sign in with Google</button>
      <span class="small" style="opacity:.8">OAuth2 (Drive.file / Sheets)</span>
    </div>
  </div>
</div>

<!-- Google SDK -->
<script>
  window.__flags = { gapi:false, gis:false };
  function onGapi(){ window.__flags.gapi = true; }
  function onGis(){  window.__flags.gis  = true; }
</script>
<script async defer src="https://accounts.google.com/gsi/client" onload="onGis()"></script>
<script async defer src="https://apis.google.com/js/api.js" onload="onGapi()"></script>

<script type="module">
/* ===== Three.js imports ===== */
import * as THREE from 'three'';\nimport { OrbitControls } from ''three/examples/jsm/controls/OrbitControls.js'';\nimport { GLTFLoader } from ''three/examples/jsm/loaders/GLTFLoader.js'';\nimport { TransformControls } from ''three/examples/jsm/controls/TransformControls.js'';\n\n/* ================== iOS Detection & constants ================== */\nconst IS_IOS = /iP(hone|ad|od)/.test(navigator.platform) ||\n               (navigator.userAgent.includes(''Mac'') && ''ontouchend'' in document);\nconst ORTHO_MARGIN = IS_IOS ? 1.6 : 1.8;\n\n/* ================== Google Auth ================== */\nconst CLIENT_ID = ''595200751510-ncahnf7edci6b9925becn5to49r6cguv.apps.googleusercontent.com'';\nconst API_KEY   = ''AIzaSyCUnTCr5yWUWPdEXST9bKP1LpgawU5rIbI'';\nconst DISCOVERY_DOCS = [\n  ''https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'',\n  ''https://www.googleapis.com/discovery/v1/apis/sheets/v4/rest''\n];\nconst SCOPES = [\n  ''https://www.googleapis.com/auth/drive.file'',\n  ''https://www.googleapis.com/auth/drive.readonly'',\n  ''https://www.googleapis.com/auth/drive.metadata.readonly'',\n  ''https://www.googleapis.com/auth/spreadsheets''\n].join('' '');\n\nlet tokenClient = null;\nlet accessToken = null;\nlet gapiReady = false;\nlet gisReady  = false;\n\nasync function ensureGapiClient() {\n  if (gapiReady) return;\n  if (!(window.gapi && gapi && gapi.load)) {\n    await new Promise(r => {\n      const t = setInterval(() => {\n        if (window.gapi && gapi && gapi.load) { clearInterval(t); r(); }\n      }, 50);\n    });\n  }\n  await new Promise((resolve) => gapi.load(''client'', resolve));\n  await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });\n  gapiReady = true;\n}\nasync function ensureGIS() {\n  if (gisReady) return;\n  if (!(window.google && google.accounts && google.accounts.oauth2)) {\n    await new Promise(r => {\n      const t = setInterval(() => {\n        if (window.google && google.accounts && google.accounts.oauth2) { clearInterval(t); r(); }\n      }, 50);\n    });\n  }\n  gisReady = true;\n}\nasync function ensureTokenClient() {\n  await ensureGIS();\n  if (tokenClient) return tokenClient;\n  tokenClient = google.accounts.oauth2.initTokenClient({\n    client_id: CLIENT_ID,\n    scope: SCOPES,\n    callback: (resp) => {\n      if (resp && resp.access_token) {\n        accessToken = resp.access_token;\n        document.getElementById(''gate'').style.display = ''none'';\n        const viewOnly = new URLSearchParams(location.search).get(''view'') === ''1'';\n        document.getElementById(''statusLabel'').textContent = viewOnly ? ''Èñ≤Ë¶ß„É¢„Éº„Éâ'' : ''Ready'';\n        [''btnLoad'',''btnTogglePins'',''projOrtho'',''listSelect''].forEach(id=> document.getElementById(id).removeAttribute(''disabled''));\n        if(!viewOnly){\n          [''btnAddPin'',''btnGizmo'',''btnUndo'',''btnSavePin'',''btnDeletePin'',''btnAttach'',''btnPickFromFolder'',''listNew'',''listDelete'']\n            .forEach(id=> document.getElementById(id).removeAttribute(''disabled''));\n        }\n        enforceViewOnlyMode();\n\n        const qs = new URLSearchParams(location.search);\n        const fid = qs.get(''fileId'') || '''';\n        const sid = qs.get(''sheetId'') || '''';\n        if(fid) el.inputGLB.value = fid;\n        if(sid) el.inputSheet.value = sid;\n      }\n    }\n  });\n  return tokenClient;\n}\nasync function startSignIn() {\n  try {\n    el.statusLabel.textContent = ''„Çµ„Ç§„É≥„Ç§„É≥Âá¶ÁêÜ‰∏≠‚Ä¶'';\n    await ensureTokenClient();\n    tokenClient.requestAccessToken({ prompt: ''consent'' });\n  } catch (e) {\n    console.error(e);\n    alert(''„Çµ„Ç§„É≥„Ç§„É≥„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÁä∂ÊÖã„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ'');\n  }\n}\n\n/* ================== Elements / State ================== */\nconst el = {\n  gate: document.getElementById(''gate''),\n  statusLabel: document.getElementById(''statusLabel''),\n  inputGLB: document.getElementById(''inputGLB''),\n  inputSheet: document.getElementById(''inputSheet''),\n  btnLoad: document.getElementById(''btnLoad''),\n  btnViewOnly: document.getElementById(''btnViewOnly''),\n  btnWide: document.getElementById(''btnWide''),\n  loading: document.getElementById(''loading''),\n  viewerCanvas: document.getElementById(''viewerCanvas''),\n  viewerPreview: document.getElementById(''viewerPreview''),\n  previewWrap: document.getElementById(''previewWrap''),\n  previewInner: document.getElementById(''previewInner''),\n  previewImg: document.getElementById(''previewImg''),\n  previewZoom: document.getElementById(''previewZoom''),\n  previewZoomVal: document.getElementById(''previewZoomVal''),\n  previewReset: document.getElementById(''previewReset''),\n  previewErr: document.getElementById(''previewErr''),\n  capTitleLine: document.getElementById(''capTitleLine''),\n  capBodyLine: document.getElementById(''capBodyLine''),\n  pinsList: document.getElementById(''pinsList''),\n  rightNoSel: document.getElementById(''noSelection''),\n  rightEditor: document.getElementById(''editor''),\n  capTitle: document.getElementById(''capTitle''),\n  capBody: document.getElementById(''capBody''),\n  btnSavePin: document.getElementById(''btnSavePin''),\n  btnDeletePin: document.getElementById(''btnDeletePin''),\n  btnAddPin: document.getElementById(''btnAddPin''),\n  btnGizmo: document.getElementById(''btnGizmo''),\n  btnTogglePins: document.getElementById(''btnTogglePins''),\n  btnUndo: document.getElementById(''btnUndo''),\n  modeLabel: document.getElementById(''modeLabel''),\n  btnSignIn: document.getElementById(''btnSignIn''),\n  colorPresets: document.getElementById(''colorPresets''),\n  btnColorFilter: document.getElementById(''btnColorFilter''),\n  colorFilterPanel: document.getElementById(''colorFilterPanel''),\n  colorFilterList: document.getElementById(''colorFilterList''),\n  btnFilterAll: document.getElementById(''btnFilterAll''),\n  btnFilterNone: document.getElementById(''btnFilterNone''),\n  btnFilterClose: document.getElementById(''btnFilterClose''),\n  imgLocal: document.getElementById(''imgLocal''),\n  btnAttach: document.getElementById(''btnAttach''),\n  btnPickFromFolder: document.getElementById(''btnPickFromFolder''),\n  thumbs: document.getElementById(''thumbs''),\n  matSelect: document.getElementById(''matSelect''),\n  matUnlit: document.getElementById(''matUnlit''),\n  matDoubleSided: document.getElementById(''matDoubleSided''),\n  matOpacity: document.getElementById(''matOpacity''),\n  matOpacityVal: document.getElementById(''matOpacityVal''),\n  matInvert: document.getElementById(''matInvert''),\n  matWhiteTransparent: document.getElementById(''matWhiteTransparent''),\n  matThreshold: document.getElementById(''matThreshold''),\n  matThresholdVal: document.getElementById(''matThresholdVal''),\n  viewFront: document.getElementById(''viewFront''),\n  viewBack: document.getElementById(''viewBack''),\n  viewLeft: document.getElementById(''viewLeft''),\n  viewRight: document.getElementById(''viewRight''),\n  viewTop: document.getElementById(''viewTop''),\n  viewBottom: document.getElementById(''viewBottom''),\n  projOrtho: document.getElementById(''projOrtho''),\n  bgColor: document.getElementById(''bgColor''),\n  connector: document.getElementById(''connector''),\n  connLine: document.getElementById(''connLine''),\n  connDot: document.getElementById(''connDot''),\n  pickerModal: document.getElementById(''pickerModal''),\n  pickerGrid: document.getElementById(''pickerGrid''),\n  btnPickerReload: document.getElementById(''btnPickerReload''),\n  btnPickerClose: document.getElementById(''btnPickerClose''),\n  listSelect: document.getElementById(''listSelect''),\n  listNew: document.getElementById(''listNew''),\n  listDelete: document.getElementById(''listDelete''),\n};\nconst viewOnly = new URLSearchParams(location.search).get(''view'') === ''1'';\n\n/* ================== Viewer State ================== */\nlet renderer, scene, camera, controls, tcontrols, pinGroup, loader, currentModel=null;\nlet perspCam, orthoCam; let usingOrtho=false;\nlet raycaster = new THREE.Raycaster(), pointer = new THREE.Vector2();\nlet addPinMode=false, currentColor=''#ff6b6b'';\nlet pins=[], selectedPinId=null, undoStack=[];\nlet glbParents=[], glbMetaCache=null;\n\n/* materials (per-material state persisted) */\nlet materials=[];\nconst materialKeyByMaterial = new Map();   // Material -> key\nconst materialByKey = new Map();           // key -> Material\nconst matOriginals=new WeakMap();\nconst matState = new Map();                // key -> state\nconst imageBlobCache = new Map();\nlet filterColors = new Set();\nlet activeSheet = { sheetId:null, title:''pins'' };\n\nconst debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };\nconst debouncedSave = debounce(()=> upsertPinToSheet(), 500);\nconst PRESET_COLORS = [''#ff6b6b'',''#ffd166'',''#06d6a0'',''#118ab2'',''#ef476f'',''#b5179e'',''#4361ee'',''#4cc9f0'',''#ff9f1c''];\n\nfunction toast(msg){ el.statusLabel.textContent=msg; setTimeout(()=> el.statusLabel.textContent= viewOnly ? ''Èñ≤Ë¶ß„É¢„Éº„Éâ'' : ''Ready'', 1800); }\nfunction ensureArray(x){ return Array.isArray(x)?x:[]; }\nfunction normalizeHex(c){ const t = new THREE.Color(c); return ''#'' + t.getHexString(); }\nfunction enforceViewOnlyMode(){\n  if (!viewOnly) return;\n  document.body.classList.add(''viewonly'');\n  el.capTitle.readOnly = true; el.capBody.readOnly  = true;\n}\n\n/* ========= HEIC helpers ========= */\nfunction loadScriptOnce(src){\n  return new Promise((resolve,reject)=>{\n    const s=document.createElement(''script''); s.src=src; s.async=true; s.onload=resolve; s.onerror=reject;\n    document.head.appendChild(s);\n  });\n}\nasync function ensureHeic2any(){\n  if(typeof window.heic2any === ''function'') return true;\n  try{ await loadScriptOnce(''https://cdn.jsdelivr.net/npm/heic2any@0.0.5/dist/heic2any.min.js''); }catch{}\n  if(typeof window.heic2any === ''function'') return true;\n  try{ await loadScriptOnce(''https://unpkg.com/heic2any@0.0.5/dist/heic2any.min.js''); }catch{}\n  return (typeof window.heic2any === ''function'');\n}\nfunction upscaleThumbnailUrl(u, size=2048){\n  if(!u) return u;\n  try{\n    const url = new URL(u);\n    url.search = url.search.replace(/(\bs=)(\d+)/, `$1${size}`);\n    url.pathname = url.pathname.replace(/=s(\d+)/, `=s${size}`);\n    if(!/(\bs=)/.test(url.search) && !/=s\d+/.test(url.pathname)){\n      url.searchParams.set(''s'', String(size));\n    }\n    return url.toString();\n  }catch{ return u.replace(/=s(\d+)/, `=s${size}`); }\n}\n\n/* ========= UI wire ========= */\ndocument.getElementById(''btnSignIn'').addEventListener(''click'', startSignIn);\nconst _pc = document.getElementById(''previewClose''); if(_pc){ _pc.addEventListener(''click'', ()=>{ el.viewerPreview.classList.add(''hidden''); }); }\n(async () => { ensureGIS().catch(()=>{}); ensureGapiClient().catch(()=>{}); })();\n\n/* ========= Viewer ========= */\nlet rendererLoopId=null;\nfunction viewerInit(){\n  renderer = new THREE.WebGLRenderer({\n    canvas: el.viewerCanvas,\n    antialias: !IS_IOS,                 // iOS„ÅØAA„Ç™„Éï„ÅßÂÆâÂÆöÊÄß\n    powerPreference: ''low-power'',\n    preserveDrawingBuffer: false\n  });\n  const cap = IS_IOS ? 1 : 1.5;         // iOS„ÅØDPR=1Âõ∫ÂÆö„ÄÅ‰ªñ„ÅØ1.5‰∏äÈôê\n  renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, cap));\n\n  scene = new THREE.Scene();\n  scene.background = new THREE.Color(0x0a0f16);\n  perspCam = new THREE.PerspectiveCamera(60, 2, 0.1, 5000);\n  perspCam.position.set(2.8,1.6,3.6);\n  orthoCam = new THREE.OrthographicCamera(-2,2,2,-2, -5000, 5000);\n  camera = perspCam; usingOrtho=false;\n\n  const hemi = new THREE.HemisphereLight(0xffffff, 0x223355, 0.6); scene.add(hemi);\n  const dir = new THREE.DirectionalLight(0xffffff, 1.0); dir.position.set(3,5,4); scene.add(dir);\n\n  buildControls();\n\n  pinGroup = new THREE.Group(); scene.add(pinGroup);\n  loader = new GLTFLoader();\n\n  window.addEventListener(''resize'', resize, { passive:true });\n  el.viewerCanvas.addEventListener(''pointerdown'', onPointerDown, { passive:false });\n  el.projOrtho.addEventListener(''change'', ()=> { toggleProjection(el.projOrtho.checked); debouncedSaveMaterials(); });\n  resize();\n  const loop = ()=>{ renderer.render(scene,camera); updateConnector(); rendererLoopId=requestAnimationFrame(loop); };\n  loop();\n}\nfunction buildControls(){\n  if(controls){ controls.dispose(); }\n  controls = new OrbitControls(camera, el.viewerCanvas);\n  controls.target.set(0,0,0); controls.update();\n  controls.addEventListener(''change'', updateConnector);\n  if(tcontrols){ scene.remove(tcontrols); if(tcontrols && typeof tcontrols.dispose===''function''){ tcontrols.dispose(); } }\n  tcontrols = new TransformControls(camera, el.viewerCanvas);\n  tcontrols.setSize(0.9); tcontrols.setSpace(''world'');\n  tcontrols.addEventListener(''dragging-changed'', e=>{ controls.enabled = !e.value; });\n  tcontrols.addEventListener(''change'', ()=>{\n    if(!selectedPinId || !tcontrols.object || !tcontrols.visible) return;\n    const p=pins.find(x=>x.id===selectedPinId); if(!p) return;\n    p.pos.copy(tcontrols.object.position);\n    renderNow(); debouncedSave();\n  });\n  scene.add(tcontrols); tcontrols.visible=false; tcontrols.enabled=false;\n}\nfunction resize(){\n  const w = el.viewerCanvas.clientWidth || el.viewerCanvas.parentElement.clientWidth;\n  const h = el.viewerCanvas.clientHeight || el.viewerCanvas.parentElement.clientHeight;\n  renderer.setSize(w,h,false);\n  if(camera.isPerspectiveCamera){\n    camera.aspect = w/h;\n  }else{ fitOrthoFrustum(); }\n  camera.updateProjectionMatrix(); updateConnector();\n}\nfunction renderNow(){ renderer.render(scene,camera); updateConnector(); }\nfunction sceneBounds(){\n  if(!currentModel){ return { center:new THREE.Vector3(0,0,0), radius: 2 }; }\n  const box = new THREE.Box3().setFromObject(currentModel);\n  const size = box.getSize(new THREE.Vector3());\n  const center = box.getCenter(new THREE.Vector3());\n  const radius = Math.max(size.x,size.y,size.z)/2 || 1;\n  return { center, radius: radius*1.2 };\n}\nfunction focusOrigin(){\n  const { radius } = sceneBounds();\n  const dist = Math.max(radius*2.2, 1.5);\n  const dirv = new THREE.Vector3(1,0.6,1).normalize();\n  const origin = new THREE.Vector3(0,0,0);\n  camera.position.copy(origin.clone().addScaledVector(dirv, dist));\n  controls.target.copy(origin);\n  if(camera.isOrthographicCamera) fitOrthoFrustum();\n  controls.update(); updateConnector();\n}\nfunction fitOrthoFrustum(){\n  const { radius } = sceneBounds();\n  const w = el.viewerCanvas.clientWidth || 1;\n  const h = el.viewerCanvas.clientHeight || 1;\n  const aspect = w/h;\n  const size = radius*ORTHO_MARGIN;\n  orthoCam.left = -size*aspect;\n  orthoCam.right = size*aspect;\n  orthoCam.top = size;\n  orthoCam.bottom = -size;\n  orthoCam.updateProjectionMatrix();\n}\nfunction toggleProjection(useOrtho){\n  usingOrtho = !!useOrtho;\n  const origin = new THREE.Vector3(0,0,0);\n  const dir = camera.position.clone().sub(controls.target).normalize();\n  const dist = camera.position.distanceTo(controls.target);\n  if(usingOrtho){\n    fitOrthoFrustum();\n    orthoCam.position.copy(origin.clone().addScaledVector(dir, dist));\n    camera = orthoCam;\n  }else{\n    perspCam.position.copy(origin.clone().addScaledVector(dir, Math.max(dist, 0.1)));\n    camera = perspCam;\n  }\n  buildControls();\n  renderNow();\n}\n\n/* ========= Pins & Connector ========= */\nfunction addUndo(u){ undoStack.push(u); }\nfunction createPin(pos,color){\n  if(viewOnly) return;\n  const id=`p_${Date.now()}_${Math.random().toString(36).slice(2,7)}`;\n  const pin={id,pos:pos.clone(),color:normalizeHex(color||''#ff6b6b''),title:'''',body:'''',images:[],mesh:null};\n  pins.push(pin);\n  filterColors.add(pin.color);\n  placePinMesh(pin);\n  refreshPinsList();\n  buildColorFilter();\n  selectPin(id);\n  addUndo({type:''add'',id});\n  upsertPinToSheet();\n}\nfunction placePinMesh(pin){\n  if(pin.mesh){ pinGroup.remove(pin.mesh); pin.mesh.geometry.dispose(); pin.mesh.material.dispose(); pin.mesh=null; }\n  const geo=new THREE.SphereGeometry(0.006,16,16);\n  const mat=new THREE.MeshBasicMaterial({color:new THREE.Color(pin.color)});\n  const mesh=new THREE.Mesh(geo,mat);\n  mesh.position.copy(pin.pos); mesh.userData.pinId=pin.id;\n  pin.mesh=mesh; pinGroup.add(mesh);\n  applyPinVisibilityFilter();\n}\nfunction selectPin(id,{fly}={}){\n  selectedPinId=id;\n  const p=pins.find(x=>x.id===id);\n  if(!p){ el.rightEditor.classList.add(''hidden''); el.rightNoSel.classList.remove(''hidden''); updateViewerPreviewForPin(null); return; }\n  el.rightNoSel.classList.add(''hidden''); el.rightEditor.classList.remove(''hidden'');\n  el.capTitle.value = p.title || '''';\n  el.capBody.value  = p.body  || '''';\n  renderThumbs(p);\n  updateViewerPreviewForPin(p);\n  if(fly){ const {x,y,z}=p.pos; controls.target.set(0,0,0); camera.position.lerp(new THREE.Vector3(x,y,z).addScaledVector(new THREE.Vector3(1,0.6,1).normalize(), 0.6), 0.0); controls.update(); }\n  if(tcontrols.visible && p.mesh){ tcontrols.attach(p.mesh); }\n  updateConnector();\n}\nfunction onPointerDown(e){\n  if(!currentModel) return;\n  el.viewerCanvas.style.cursor = (addPinMode || e.shiftKey) && !viewOnly ? ''crosshair'' : ''default'';\n\n  const rect=el.viewerCanvas.getBoundingClientRect();\n  pointer.x=((e.clientX-rect.left)/rect.width)*2-1;\n  pointer.y=-((e.clientY-rect.top)/rect.height)*2+1;\n  raycaster.setFromCamera(pointer,camera);\n\n  const hitsPins = raycaster.intersectObjects(pinGroup.children,false);\n  if(hitsPins.length){ selectPin(hitsPins[0].object.userData.pinId, {fly:true}); return; }\n\n  if((e.shiftKey || addPinMode) && !viewOnly){\n    const hitModel = currentModel? raycaster.intersectObject(currentModel,true): [];\n    if(hitModel.length){\n      const pt = hitModel[0].point.clone();\n      createPin(pt,currentColor);\n      if(addPinMode){ addPinMode=false; el.btnAddPin.textContent=''Ôºã „Éî„É≥ËøΩÂä†„É¢„Éº„Éâ''; el.modeLabel.textContent=''Orbit''; el.viewerCanvas.style.cursor=''default''; }\n      return;\n    }\n  }\n}\nfunction updateConnector(){\n  const p = pins.find(x=>x.id===selectedPinId);\n  if(!p || !p.mesh || el.viewerPreview.classList.contains(''hidden'') || !pinGroup.visible || !p.mesh.visible){\n    el.connLine.style.display = ''none''; el.connDot.style.display = ''none''; return;\n  }\n  const v = p.pos.clone().project(camera);\n  const rect = el.viewerCanvas.getBoundingClientRect();\n  const x = (v.x + 1) / 2 * rect.width;\n  const y = (1 - (v.y + 1) / 2) * rect.height;\n  const rectPrev = el.viewerPreview.getBoundingClientRect();\n  const bx = (rectPrev.left - rect.left);\n  const by = (rectPrev.top - rect.top) + rectPrev.height/2;\n  const svg = el.connector;\n  svg.setAttribute(''viewBox'', `0 0 ${rect.width} ${rect.height}`);\n  el.connLine.setAttribute(''x1'', x); el.connLine.setAttribute(''y1'', y);\n  el.connLine.setAttribute(''x2'', bx); el.connLine.setAttribute(''y2'', by);\n  el.connLine.style.display = ''block'';\n  el.connDot.setAttribute(''cx'', x); el.connDot.setAttribute(''cy'', y);\n  el.connDot.style.display = ''block'';\n}\n\n/* ========= Preview ========= */\nlet previewZoom = 1.0;\nfunction applyPreviewZoom(){ el.previewInner.style.transform = `scale(${previewZoom})`; }\nel.previewZoom.addEventListener(''input'', ()=>{ previewZoom = parseFloat(el.previewZoom.value)||1; el.previewZoomVal.textContent = previewZoom.toFixed(2) + ''√ó''; applyPreviewZoom(); });\nel.previewReset.addEventListener(''click'', ()=>{ previewZoom = 1; el.previewZoom.value = 1; el.previewZoomVal.textContent = ''1.00√ó''; applyPreviewZoom(); });\n\nasync function setPreview(ref, p){\n  try{\n    const msg = document.getElementById(''previewMsg''); if(msg) msg.style.display=''none'';\n    if(ref){\n    el.previewErr.style.display=''none'';\n    const src = await resolveImageObjectURL(ref, {preferThumb:false});\n    el.previewImg.src = src;\n    el.previewImg.onerror = ()=>{ el.previewErr.style.display=''inline''; };\n    el.capTitleLine.textContent = (p && p.title) ? p.title : '''';\n    el.capBodyLine.textContent  = (p && p.body)  ? p.body  : '''';\n    el.viewerPreview.classList.remove(''hidden'');\n    applyPreviewZoom(); updateConnector();\n    }\n    else {\n      const msg = document.getElementById(''previewMsg'');\n      if(msg){ msg.textContent = ''ÁîªÂÉè„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì''; msg.style.display = ''block''; }\n      const img = document.getElementById(''previewImg''); if(img){ img.removeAttribute(''src''); }\n      el.capTitleLine.textContent = (p && p.title) ? p.title : '''';\n      el.capBodyLine.textContent  = (p && p.body)  ? p.body  : '''';\n      el.viewerPreview.classList.remove(''hidden'');\n      applyPreviewZoom(); updateConnector();\n    }\n  }\n  catch(e){\n    console.warn(''preview failed'', e);\n    el.previewErr.style.display=''inline'';\n    el.viewerPreview.classList.remove(''hidden'');\n  }\n}\nfunction updateViewerPreviewForPin(p){ setPreview(p && p.images && p.images[0] ? p.images[0] : null, p); }\n\n/* ========= Image resolve & Drive ========= */\nfunction parseImageRef(ref){\n  if(typeof ref === ''string'' && /^(blob:|data:|https?:)/i.test(ref)){ return { kind:''url'', url: ref }; }\n  if(typeof ref === ''string'' && ref.startsWith(''drive:'')){\n    const [, rest] = ref.split('':''); const [id, mime] = rest.split(''|'');\n    return { kind:''drive'', id, mime: mime||null };\n  }\n  if(typeof ref === ''string''){\n    const id = extractDriveFileId(ref);\n    if(id){ return { kind:''drive'', id, mime:null }; }\n  }\n  return { kind:''url'', url: String(ref) };\n}\nasync function resolveImageObjectURL(ref, {preferThumb=false}={}){\n  const key = typeof ref===''string''?ref:JSON.stringify(ref);\n  if(imageBlobCache.has(key)) return imageBlobCache.get(key);\n\n  const info = parseImageRef(ref);\n  let outUrl;\n\n  if(info.kind === ''url''){ imageBlobCache.set(key, info.url); return info.url; }\n\n  const meta = await driveFileMeta(info.id);\n  const isHeic = isHeicMimeOrExt(meta.mimeType, meta.fileExtension);\n\n  if(isHeic){\n    const ok = await ensureHeic2any();\n    if(ok){\n      const blob = await driveFileFetchBlob(meta.id);\n      const jpegBlob = await window.heic2any({ blob, toType:''image/jpeg'', quality:1.0 });\n      const jpg = Array.isArray(jpegBlob) ? jpegBlob[0] : jpegBlob;\n      outUrl = URL.createObjectURL(jpg);\n    }else if(meta.hasThumbnail && meta.thumbnailLink){\n      const hi = upscaleThumbnailUrl(meta.thumbnailLink, 2048);\n      const sep = hi.includes(''?'') ? ''&'' : ''?'';\n      outUrl = hi + sep + ''access_token='' + encodeURIComponent(accessToken);\n    }else{\n      throw new Error(''HEIC preview unavailable (no heic2any & no thumbnailLink)'');\n    }\n  }else{\n    if(preferThumb && meta.hasThumbnail && meta.thumbnailLink){\n      const hi = upscaleThumbnailUrl(meta.thumbnailLink, 1024);\n      const sep = hi.includes(''?'') ? ''&'' : ''?'';\n      outUrl = hi + sep + ''access_token='' + encodeURIComponent(accessToken);\n    }else{\n      const blob = await driveFileFetchBlob(meta.id);\n      outUrl = URL.createObjectURL(blob);\n    }\n  }\n\n  imageBlobCache.set(key, outUrl);\n  return outUrl;\n}\nasync function driveFileMeta(fileId){\n  const meta = await gapi.client.drive.files.get({\n    fileId, fields:''id,name,mimeType,fileExtension,hasThumbnail,thumbnailLink,parents'',\n    supportsAllDrives:true\n  });\n  return meta.result;\n}\nasync function driveFileFetchBlob(fileId, retry=1){\n  const dlUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&supportsAllDrives=true`;\n  const res = await fetch(dlUrl, { headers:{ Authorization:`Bearer ${accessToken}` } });\n  if(res.status === 401 && retry>0){\n    try{ tokenClient && tokenClient.requestAccessToken({ prompt:'''' }); }catch{}\n    return driveFileFetchBlob(fileId, retry-1);\n  }\n  if(!res.ok) throw new Error(''image fetch failed ''+res.status);\n  return await res.blob();\n}\nfunction isHeicMimeOrExt(mime, ext){ return /heic|heif/i.test(mime||'''') || /heic|heif/i.test(ext||''''); }\n\n\nfunction extractDriveFileId(input){\n  try{\n    if(!input) return '''';\n    let s = String(input).trim();\n    // URL patterns first\n    let m = s.match(/\bfile\/d\/([A-Za-z0-9_-]{20,})/); if(m && m[1]) return m[1];\n    m = s.match(/[?&]id=([A-Za-z0-9_-]{20,})/); if(m && m[1]) return m[1];\n    // bare-like\n    s = s.split(/[\s\u3000]+/)[0];\n    s = s.replace(/^[^A-Za-z0-9_-]+|[^A-Za-z0-9_-]+$/g, '''');\n    if(/^[A-Za-z0-9_-]{30,}$/.test(s)) return s; // Drive IDs are typically >=30 chars\n    return '''';\n  }catch(e){ return ''''; }\n}\nfunction extractSpreadsheetId(input){\n  try{\n    if(!input) return '''';\n    let s = String(input).trim();\n    if(/^[A-Za-z0-9_-]{20,}$/.test(s)) return s;\n    let m = s.match(/spreadsheets\/d\/([A-Za-z0-9_-]{10,})/); if(m && m[1]) return m[1];\n    m = s.match(/[?&]id=([A-Za-z0-9_-]{10,})/); if(m && m[1]) return m[1];\n    s = s.split(/[\s\u3000]+/)[0];\n    s = s.replace(/^[^A-Za-z0-9_-]+|[^A-Za-z0-9_-]+$/g, '''');\n    return /^[A-Za-z0-9_-]{10,}$/.test(s) ? s : '''';\n  }catch(e){ return ''''; }\n}\nfunction makeDriveRef(id, mime){ return `drive:${id}|${mime||''''}`; }\n\n/* ========= Materials ========= */\nfunction ensureMatRecord(m){\n  if(matOriginals.has(m)) return;\n  matOriginals.set(m, {\n    color: (m.color ? m.color.clone() : new THREE.Color(0xffffff)),\n    map: m.map || null,\n    alphaMap: m.alphaMap || null,\n    transparent: !!m.transparent,\n    opacity: (m.opacity ?? 1),\n    alphaTest: (m.alphaTest ?? 0),\n    side: m.side ?? THREE.FrontSide,\n    depthWrite: m.depthWrite,\n    depthTest: m.depthTest,\n    blending: m.blending,\n    toneMapped: m.toneMapped,\n    wasUnlit: false,\n    unlitMat: null\n  });\n}\nfunction objectPath(node) {\n  const names = [];\n  let cur = node;\n  while (cur && cur.parent) {\n    names.push(cur.name && cur.name.trim() ? cur.name : ''_'' + ((cur.uuid && cur.uuid.slice ? cur.uuid.slice(0,8) : '''') || ''node''));\n    cur = cur.parent;\n  }\n  names.reverse();\n  return names.join(''/'');\n}\nfunction indexMaterialsByKey(){\n  materialKeyByMaterial.clear();\n  materialByKey.clear();\n  if (!currentModel) return;\n  currentModel.traverse(obj=>{\n    if (!obj.material) return;\n    const basePath = objectPath(obj);\n    if (Array.isArray(obj.material)) {\n      obj.material.forEach((m, idx)=>{\n        const key = `${basePath}#${idx}`;\n        materialKeyByMaterial.set(m, key);\n        materialByKey.set(key, m);\n        ensureMatRecord(m);\n        if(!matState.has(key)){\n          matState.set(key, { unlit:false, doubleSided:(m.side===THREE.DoubleSide), opacity:(m.opacity??1), invertRGB:false, whiteToAlpha:false, alphaTest:(m.alphaTest??0) });\n        }\n      });\n    } else {\n      const key = `${basePath}#0`;\n      materialKeyByMaterial.set(obj.material, key);\n      materialByKey.set(key, obj.material);\n      const m = obj.material; ensureMatRecord(m);\n      if(!matState.has(key)){\n        matState.set(key, { unlit:false, doubleSided:(m.side===THREE.DoubleSide), opacity:(m.opacity??1), invertRGB:false, whiteToAlpha:false, alphaTest:(m.alphaTest??0) });\n      }\n    }\n  });\n}\nfunction collectMaterials(){\n  materials=[]; \n  const set = new Set();\n  if(!currentModel) return;\n\n  indexMaterialsByKey();\n  currentModel.traverse(obj=>{\n    const m=obj.material;\n    if(Array.isArray(m)){ m.forEach(mm=>{ if(mm && !set.has(mm)){ set.add(mm); materials.push(mm); ensureMatRecord(mm); } }); }\n    else if(m){ if(!set.has(m)){ set.add(m); materials.push(m); ensureMatRecord(m); } }\n  });\n\n  el.matSelect.innerHTML = ''<option value="__all__">ÔºàÂÖ®„Éû„ÉÜ„É™„Ç¢„É´ÔºöÁ∑®ÈõÜ‰∏çÂèØÔºâ</option>'';\n  materials.forEach((m,idx)=>{\n    const key = materialKeyByMaterial.get(m);\n    if(!key) return;\n    const name = (m.name && m.name.trim()) ? m.name : `Material_${idx}`;\n    const opt=document.createElement(''option''); \n    opt.value=key;\n    opt.textContent=name;\n    el.matSelect.appendChild(opt);\n    if(!matState.has(key)){\n      matState.set(key, {\n        unlit:false,\n        doubleSided:(m.side===THREE.DoubleSide),\n        opacity:(m.opacity??1),\n        invertRGB:false,\n        whiteToAlpha:false,\n        alphaTest:(m.alphaTest??0)\n      });\n    }\n  });\n\n  if(el.matSelect.options.length>1){\n    el.matSelect.value = el.matSelect.options[1].value;\n  }else{\n    el.matSelect.value = ''__all__'';\n  }\n  applyMaterialUIFromSelection();\n}\nfunction getSelectedOriginalMaterial(){\n  const val=el.matSelect.value;\n  if(val===''__all__'') return null;\n  return materialByKey.get(val) || null;\n}\nfunction applyMaterialUIFromSelection(){\n  const key = el.matSelect.value;\n  const disable = (key === ''__all__'');\n  [''matUnlit'',''matDoubleSided'',''matOpacity'',''matInvert'',''matWhiteTransparent'',''matThreshold'']\n    .forEach(id=>{ document.getElementById(id).disabled = disable || viewOnly; });\n  if(disable) return;\n  const st = matState.get(key) || { unlit:false,doubleSided:false,opacity:1,invertRGB:false,whiteToAlpha:false,alphaTest:0 };\n  el.matUnlit.checked = !!st.unlit;\n  el.matDoubleSided.checked = !!st.doubleSided;\n  el.matOpacity.value = String(st.opacity ?? 1);\n  el.matOpacityVal.textContent = (Number(st.opacity ?? 1)).toFixed(2);\n  el.matInvert.checked = !!st.invertRGB;\n  el.matWhiteTransparent.checked = !!st.whiteToAlpha;\n  el.matThreshold.value = String(st.alphaTest ?? 0);\n  el.matThresholdVal.textContent = (Number(st.alphaTest ?? 0)).toFixed(2);\n}\nel.matSelect.addEventListener(''change'', ()=> applyMaterialUIFromSelection());\n\nasync function applyMaterialFromUIToSelected(){\n  const orig = getSelectedOriginalMaterial();\n  if(!orig) return;\n  const key = materialKeyByMaterial.get(orig);\n  const st = matState.get(key) || {};\n  st.unlit = !!el.matUnlit.checked;\n  st.doubleSided = !!el.matDoubleSided.checked;\n  st.opacity = Number(el.matOpacity.value ?? 1);\n  st.invertRGB = !!el.matInvert.checked;\n  st.whiteToAlpha = !!el.matWhiteTransparent.checked;\n  st.alphaTest = Number(el.matThreshold.value ?? 0);\n  matState.set(key, st);\n  await applyStateToMaterial(orig, st);\n  renderNow();\n  debouncedSaveMaterials();\n}\n[''change'',''input''].forEach(ev=>{\n  [''matUnlit'',''matDoubleSided'',''matOpacity'',''matInvert'',''matWhiteTransparent'',''matThreshold'']\n    .forEach(id=> document.getElementById(id).addEventListener(ev, ()=> applyMaterialFromUIToSelected()));\n});\nel.matOpacity.addEventListener(''input'', ()=> el.matOpacityVal.textContent = parseFloat(el.matOpacity.value).toFixed(2));\nel.matThreshold.addEventListener(''input'', ()=> el.matThresholdVal.textContent = parseFloat(el.matThreshold.value).toFixed(2));\n\nfunction getActiveMaterialFor(originalM){\n  const rec = matOriginals.get(originalM);\n  return (rec && rec.wasUnlit && rec.unlitMat) ? rec.unlitMat : originalM;\n}\nfunction copyTextureParams(from, to){\n  to.wrapS = from.wrapS; to.wrapT = from.wrapT;\n  to.repeat.copy(from.repeat); to.offset.copy(from.offset);\n  to.center.copy(from.center); to.rotation = from.rotation;\n  to.flipY = from.flipY;\n  to.magFilter = from.magFilter; to.minFilter = from.minFilter;\n  to.generateMipmaps = from.generateMipmaps;\n  to.anisotropy = from.anisotropy;\n  to.colorSpace = from.colorSpace ?? THREE.SRGBColorSpace;\n}\nasync function processTextureToCanvasTextureFromOriginal(originalTex, { invertRGB=false, alphaFromWhite=false, threshold=0 }){\n  if(!originalTex || !originalTex.image) return null;\n  const image = originalTex.image;\n  const w = image.width || image.videoWidth || 0;\n  const h = image.height || image.videoHeight || 0;\n  if(!w || !h) return null;\n  const canvas = document.createElement(''canvas''); canvas.width = w; canvas.height = h;\n  const ctx = canvas.getContext(''2d'');\n  try{ ctx.drawImage(image, 0, 0, w, h); }\n  catch(e){ try{ const bmp = await createImageBitmap(image); ctx.drawImage(bmp,0,0,w,h); } catch(e2){ return null; } }\n  const img = ctx.getImageData(0,0,w,h); const data = img.data;\n  for(let i=0;i<data.length;i+=4){\n    let r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];\n    if(invertRGB){ r=255-r; g=255-g; b=255-b; }\n    let alpha=a;\n    if(alphaFromWhite){\n      const L = (0.2126*r + 0.7152*g + 0.0722*b)/255;\n      let alf = 1 - L;\n      if(threshold>0){ alf = (alf >= threshold) ? alf : 0; }\n      alpha = Math.round(Math.min(1,Math.max(0,alf))*255);\n    }\n    data[i]=r; data[i+1]=g; data[i+2]=b; data[i+3]=alpha;\n  }\n  ctx.putImageData(img,0,0);\n  const ctex = new THREE.CanvasTexture(canvas);\n  copyTextureParams(originalTex, ctex);\n  ctex.needsUpdate = true;\n  return ctex;\n}\nasync function applyStateToMaterial(origM, st){\n  ensureMatRecord(origM);\n  const rec = matOriginals.get(origM);\n\n  \n  // Guard: if model not ready, queue material update and return\n  try{\n    if (!currentModel){\n      (window.__matQueue || (window.__matQueue = [])).push([origM, st]);\n      return;\n    }\n  }catch(_){}\nif(st.unlit && !rec.wasUnlit){\n    const active = getActiveMaterialFor(origM);\n    const um = new THREE.MeshBasicMaterial();\n    um.color = (active.color ? active.color.clone() : rec.color.clone());\n    um.map = active.map || rec.map || null;\n    um.transparent = active.transparent;\n    um.opacity = active.opacity;\n    um.alphaTest = active.alphaTest;\n    um.side = active.side;\n    um.depthWrite = active.depthWrite;\n    um.depthTest = active.depthTest;\n    um.blending = active.blending;\n    um.toneMapped = false;\n    rec.unlitMat = um; rec.wasUnlit = true;\n    currentModel.traverse(obj=>{\n      const m=obj.material;\n      if(m===origM || m===active){ obj.material = um; }\n      else if(Array.isArray(m)){ obj.material = m.map(x=> (x===origM||x===active)? um : x ); }\n    });\n  }else if(!st.unlit && rec.wasUnlit){\n    currentModel.traverse(obj=>{\n      const m=obj.material;\n      if(m===rec.unlitMat){ obj.material = origM; }\n      else if(Array.isArray(m)){ obj.material = m.map(x=> (x===rec.unlitMat)? origM : x ); }\n    });\n    rec.wasUnlit = false;\n  }\n\n  const mat = getActiveMaterialFor(origM);\n  mat.side = st.doubleSided ? THREE.DoubleSide : THREE.FrontSide;\n  const willTransparent = (st.whiteToAlpha || (st.opacity < 1.0));\n  mat.transparent = willTransparent;\n  mat.opacity = st.opacity ?? 1;\n  mat.alphaTest = st.alphaTest ?? 0;\n  mat.depthWrite = !mat.transparent || (mat.alphaTest>0);\n\n  if((st.invertRGB || st.whiteToAlpha) && matOriginals.get(origM).map){\n    try{\n      const processed = await processTextureToCanvasTextureFromOriginal(matOriginals.get(origM).map, { invertRGB: st.invertRGB, alphaFromWhite: st.whiteToAlpha, threshold: st.alphaTest||0 });\n      if(processed){ mat.map = processed; mat.map.needsUpdate = true; }\n    }catch(e){ console.warn(''texture process failed'', e); }\n  }else{\n    const rec0 = matOriginals.get(origM);\n    mat.map = rec0.map || null;\n    if(mat.map) mat.map.needsUpdate = true;\n  }\n  if(!mat.color && matOriginals.get(origM).color){ mat.color = matOriginals.get(origM).color.clone(); }\n  if(mat.color) mat.color.needsUpdate = true;\n  mat.needsUpdate = true;\n}\n\n/* ========= Camera views ========= */\nel.viewFront.addEventListener(''click'', ()=> { setNamedView(''front''); debouncedSaveMaterials(); });\nel.viewBack.addEventListener(''click'',  ()=> { setNamedView(''back'');  debouncedSaveMaterials(); });\nel.viewLeft.addEventListener(''click'',  ()=> { setNamedView(''left'');  debouncedSaveMaterials(); });\nel.viewRight.addEventListener(''click'', ()=> { setNamedView(''right''); debouncedSaveMaterials(); });\nel.viewTop.addEventListener(''click'',   ()=> { setNamedView(''top'');   debouncedSaveMaterials(); });\nel.viewBottom.addEventListener(''click'',()=> { setNamedView(''bottom'');debouncedSaveMaterials(); });\n\nfunction setNamedView(name){\n  const { radius } = sceneBounds();\n  const d = Math.max(radius*2.2, 1.5);\n  let dir = new THREE.Vector3(d,0,0);\n  switch(name){\n    case ''front'': dir.set(d,0,0); break;\n    case ''back'':  dir.set(-d,0,0); break;\n    case ''left'':  dir.set(0,0,-d); break;\n    case ''right'': dir.set(0,0,d); break;\n    case ''top'':   dir.set(0,d,0); break;\n    case ''bottom'':dir.set(0,-d,0); break;\n  }\n  const origin = new THREE.Vector3(0,0,0);\n  camera.position.copy(origin.clone().add(dir));\n  controls.target.copy(origin);\n  if(camera.isOrthographicCamera) fitOrthoFrustum();\n  controls.update(); renderNow();\n}\n\n/* ========= SheetsÔºöÂêåÈöéÂ±§„Åß‰ΩúÊàê/Ê§úÁ¥¢ ========= */\nasync function findOrCreateSpreadsheetInGlbFolder(glbMeta){\n  if (!glbMeta || !glbMeta.id) throw new Error(''GLB„É°„Çø„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'');\n  const parents = glbMeta.parents || [];\n  let found = null;\n  for (const parent of (parents.length ? parents : [''root''])) {\n    const q = [\n      `''${parent}'' in parents`,\n      `mimeType=''application/vnd.google-apps.spreadsheet''`,\n      `trashed=false`,\n      `appProperties has { key=''lociFor'' and value=''${glbMeta.id}'' }`\n    ].join('' and '');\n    const resp = await gapi.client.drive.files.list({\n      q, fields: ''files(id,name)'',\n      includeItemsFromAllDrives: true, supportsAllDrives: true, pageSize: 10,\n    });\n    if ((resp.result && resp.result.files && resp.result.files.length)) { found = resp.result.files[0]; break; }\n  }\n  if (found) return found.id;\n\n  const name = `LociMyu - ${glbMeta.name}`;\n  const create = await gapi.client.drive.files.create({\n    resource: {\n      name,\n      mimeType: ''application/vnd.google-apps.spreadsheet'',\n      parents: (parents && parents.length) ? parents : undefined,\n      appProperties: { lociFor: glbMeta.id },\n    },\n    fields: ''id'',\n    supportsAllDrives: true\n  });\n  const spreadsheetId = create.result.id;\n\n  await gapi.client.sheets.spreadsheets.batchUpdate({\n    spreadsheetId,\n    resource: {\n      requests: [\n        { updateSpreadsheetProperties: { properties: { title: name }, fields: ''title'' } },\n        { addSheet: { properties: { title: ''pins'' } } }\n      ]\n    }\n  });\n  await gapi.client.sheets.spreadsheets.values.update({\n    spreadsheetId, range: ''pins!A1'',\n    valueInputOption:''RAW'',\n    resource:{ values: [[ ''pin_id'',''title'',''body'',''x'',''y'',''z'',''color'',''images'',''updated_at'' ]] }\n  });\n  return spreadsheetId;\n}\n\n/* ========= MetaÔºàK/LÂàóÔºâ ‰øùÂ≠ò„ÉªÂæ©ÂÖÉ ========= */\nconst META_MARKER_RANGE = ()=> `${activeSheet.title}!K1`;\nconst META_MAT_KEY_RANGE = ()=> `${activeSheet.title}!K2:L2`;\nconst META_VIEW_KEY_RANGE = ()=> `${activeSheet.title}!K3:L3`;\n\nfunction safeParseJSON(s, fallback){ try{ return s ? JSON.parse(s) : fallback; }catch{ return fallback; } }\n\nasync function loadSheetMeta(spreadsheetId){\n  try{\n    const get = await gapi.client.sheets.spreadsheets.values.batchGet({\n      spreadsheetId,\n      ranges: [ META_MARKER_RANGE(), META_MAT_KEY_RANGE(), META_VIEW_KEY_RANGE() ]\n    });\n    const vals = (get.result.valueRanges || []).map(v=>v.values||[]);\n    const matJson = ((vals[1] && vals[1][0]) ? vals[1][0][1] : undefined) || '''';\n    const viewJson = ((vals[2] && vals[2][0]) ? vals[2][0][1] : undefined) || '''';\n    const m = safeParseJSON(matJson, null);\n    const materials = normalizeMaterialsJSON(m);\n    const viewer = safeParseJSON(viewJson, { version:1, bgColor:''#0a0f16'', projection:''perspective'' });\n    return { materials, viewer };\n  }catch(e){\n    console.warn(''loadSheetMeta failed'', e);\n    return { materials:{version:2,byKey:{}}, viewer:{version:1,bgColor:''#0a0f16'',projection:''perspective''} };\n  }\n}\nfunction normalizeMaterialsJSON(m){\n  if(!m) return { version:2, byKey:{} };\n  if(m.version===2 && m.byKey) return m;\n  if(Array.isArray(m.items)){\n    const byKey = {};\n    m.items.forEach(it=>{\n      if(!it || !it.key) return;\n      byKey[it.key] = {\n        unlit: !!it.unlit,\n        doubleSided: !!it.doubleSided,\n        opacity: Number(it.opacity ?? 1),\n        invertRGB: !!it.invertRGB,\n        whiteToAlpha: !!it.whiteToAlpha,\n        alphaTest: Number(it.alphaTest ?? 0)\n      };\n    });\n    return { version:2, byKey };\n  }\n  return { version:2, byKey:{} };\n}\nasync function saveSheetMeta(spreadsheetId, { materials, viewer }){\n  if(viewOnly) return;\n  const data = [\n    { range: META_MARKER_RANGE(), values: [[ ''LOCI_META_V1'' ]] },\n    { range: META_MAT_KEY_RANGE(), values: [[ ''materials_json'', JSON.stringify(materials) ]] },\n    { range: META_VIEW_KEY_RANGE(), values: [[ ''viewer_json'', JSON.stringify(viewer) ]] },\n  ];\n  await gapi.client.sheets.spreadsheets.values.batchUpdate({\n    spreadsheetId,\n    valueInputOption:''RAW'',\n    data\n  });\n}\nfunction serializeMaterialsForSheet(){\n  const byKey = {};\n  for(const [key, st] of matState){\n    if(materialByKey.has(key)){\n      byKey[key] = {\n        unlit: !!st.unlit,\n        doubleSided: !!st.doubleSided,\n        opacity: Number(st.opacity ?? 1),\n        invertRGB: !!st.invertRGB,\n        whiteToAlpha: !!st.whiteToAlpha,\n        alphaTest: Number(st.alphaTest ?? 0)\n      };\n    }\n  }\n  return { version:2, byKey };\n}\nfunction serializeViewerPrefs(){\n  return {\n    version: 1,\n    bgColor: el.bgColor.value || ''#0a0f16'',\n    projection: usingOrtho ? ''orthographic'' : ''perspective''\n  };\n}\nasync function applyMaterialsFromSheet(materialsData){\n  if(!materialsData || !materialsData.byKey) return;\n  for(const [key, st] of Object.entries(materialsData.byKey)){\n    matState.set(key, { ...st });\n  }\n  for(const [key, st] of matState){\n    const mat = materialByKey.get(key);\n    if(!mat) continue;\n    await applyStateToMaterial(mat, st);\n  }\n  applyMaterialUIFromSelection();\n  renderNow();\n}\nasync function applyViewerPrefs(viewerData){\n  if(!viewerData) return;\n  if(viewerData.bgColor){\n    el.bgColor.value = viewerData.bgColor;\n    scene.background = new THREE.Color(viewerData.bgColor);\n  }\n  if(viewerData.projection){\n    const wantOrtho = (viewerData.projection === ''orthographic'');\n    el.projOrtho.checked = wantOrtho;\n    toggleProjection(wantOrtho);\n  }\n  renderNow();\n}\nconst debouncedSaveMaterials = debounce(async ()=>{\n  if(viewOnly) return;\n  const spreadsheetId = extractSpreadsheetId(el.inputSheet.value.trim());\n  if (!spreadsheetId || !activeSheet.sheetId) return;\n  const materialsData = serializeMaterialsForSheet();\n  const viewerData = serializeViewerPrefs();\n  try{ await saveSheetMeta(spreadsheetId, { materials: materialsData, viewer: viewerData }); }\n  catch(e){ console.warn(''saveSheetMeta failed'', e); }\n}, 600);\nel.bgColor.addEventListener(''input'', ()=>{ scene.background = new THREE.Color(el.bgColor.value); renderNow(); debouncedSaveMaterials(); });\n\n/* ========= Thumbs / Preview ========= */\nfunction renderThumbs(p){\n  const thumbs=el.thumbs; thumbs.innerHTML='''';\n  ensureArray(p.images).forEach(async (ref, idx)=>{\n    const wrap=document.createElement(''div''); wrap.className=''thumb''; thumbs.appendChild(wrap);\n    const img=document.createElement(''img''); img.alt = ''thumb'';\n    const del=document.createElement(''div''); del.className=''del''; del.textContent=''√ó''; del.title=''„Åì„ÅÆÁîªÂÉè„Çí„Ç≠„É£„Éó„Ç∑„Éß„É≥„Åã„ÇâÂ§ñ„Åô'';\n    del.addEventListener(''click'', (ev)=>{\n      if(viewOnly) return;\n      ev.stopPropagation(); const wasPreview = (el.previewImg.src && el.previewImg.src === img.src);\n      p.images.splice(idx,1); renderThumbs(p);\n      if(wasPreview){ const next = p.images[0] || null; setPreview(next, p); }\n      upsertPinToSheet();\n    });\n    wrap.appendChild(img); wrap.appendChild(del);\n    try{\n      const src = await resolveImageObjectURL(ref, {preferThumb:true});\n      img.src = src;\n      img.addEventListener(''click'', async ()=>{ setPreview(ref, p); });\n    }catch{\n      wrap.classList.add(''error''); wrap.title = ''ÁîªÂÉè„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü'';\n    }\n  });\n}\n\n/* ========= Caption bindings ========= */\ndocument.getElementById(''btnSavePin'').addEventListener(''click'', ()=> upsertPinToSheet());\nel.capTitle.addEventListener(''input'', ()=>{ const p=pins.find(x=>x.id===selectedPinId); if(p){ p.title=el.capTitle.value; refreshPinsList(); upsertPinToSheet(); updateViewerPreviewForPin(p); } });\nel.capBody.addEventListener(''input'',  ()=>{ const p=pins.find(x=>x.id===selectedPinId); if(p){ p.body=el.capBody.value; upsertPinToSheet(); updateViewerPreviewForPin(p); } });\n\n/* ========= Pin color presets ========= */\nconst PRESET_LIST = [''#ff6b6b'',''#ffd166'',''#06d6a0'',''#118ab2'',''#ef476f'',''#b5179e'',''#4361ee'',''#4cc9f0'',''#ff9f1c''];\nfunction buildColorPresets(){\n  const holder = el.colorPresets; holder.innerHTML='''';\n  PRESET_LIST.forEach(c=>{\n    const b=document.createElement(''button'');\n    b.style.width=''18px''; b.style.height=''18px'';\n    b.style.borderRadius=''999px''; b.style.border=''2px solid #223146'';\n    b.style.background=c; b.title=c;\n    b.addEventListener(''click'',()=>{\n      currentColor=c;\n      const pId=selectedPinId;\n      if(pId){\n        const p=pins.find(x=>x.id===pId);\n        p.color=normalizeHex(c);\n        placePinMesh(p);\n        refreshPinsList();\n        filterColors.add(p.color); // Êñ∞Ëâ≤„ÇíÂàùÊúüË°®Á§∫\n        buildColorFilter();\n        debouncedSave();\n      }\n    });\n    holder.appendChild(b);\n  });\n}\nbuildColorPresets();\n\nfunction uniquePinColors(){ const set = new Set(); pins.forEach(p=> set.add(normalizeHex(p.color))); return Array.from(set); }\nfunction buildColorFilter(){\n  const list = el.colorFilterList; list.innerHTML='''';\n  const colors = uniquePinColors().sort();\n  if(colors.length===0){ list.innerHTML = ''<div class="small">„Éî„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>''; return; }\n  colors.forEach(c=>{\n    const row = document.createElement(''label''); row.style.display=''flex''; row.style.alignItems=''center''; row.style.gap=''8px''; row.style.margin=''4px 0'';\n    const sw = document.createElement(''span''); sw.style.width=''14px''; sw.style.height=''14px''; sw.style.borderRadius=''50%''; sw.style.border=''2px solid #223146''; sw.style.display=''inline-block''; sw.style.background=c;\n    const cb = document.createElement(''input''); cb.type=''checkbox''; cb.value=c; cb.checked = (filterColors.size===0 || filterColors.has(c));\n    const name = document.createElement(''span''); name.textContent = c; name.className=''small'';\n    row.appendChild(cb); row.appendChild(sw); row.appendChild(name);\n    cb.addEventListener(''change'', ()=>{\n      if(cb.checked) filterColors.add(c); else filterColors.delete(c);\n      if(filterColors.size===0){ colors.forEach(k=> filterColors.add(k)); }\n      applyPinVisibilityFilter();\n    });\n    list.appendChild(row);\n  });\n  if(filterColors.size===0){ colors.forEach(k=> filterColors.add(k)); }\n  applyPinVisibilityFilter();\n}\nfunction pinPassesFilter(p){ if(filterColors.size===0) return true; return filterColors.has(normalizeHex(p.color)); }\nfunction applyPinVisibilityFilter(){\n  pins.forEach(p=>{ if(p.mesh){ p.mesh.visible = pinPassesFilter(p); } });\n  refreshPinsList(); renderNow();\n}\nel.btnColorFilter.addEventListener(''click'', ()=>{\n  el.colorFilterPanel.style.display = (el.colorFilterPanel.style.display===''none'' || !el.colorFilterPanel.style.display) ? ''block'' : ''none'';\n});\ndocument.getElementById(''btnFilterAll'').addEventListener(''click'', ()=>{ filterColors.clear(); uniquePinColors().forEach(c=> filterColors.add(c)); buildColorFilter(); });\ndocument.getElementById(''btnFilterNone'').addEventListener(''click'', ()=>{ filterColors.clear(); applyPinVisibilityFilter(); buildColorFilter(); });\ndocument.getElementById(''btnFilterClose'').addEventListener(''click'', ()=> el.colorFilterPanel.style.display=''none'');\n\nfunction refreshPinsList(){\n  el.pinsList.innerHTML='''';\n  pins.filter(pinPassesFilter).forEach(p=>{\n    const row=document.createElement(''div''); row.className=''row''; row.dataset.id=p.id;\n    const left=document.createElement(''div''); left.style.display=''flex''; left.style.alignItems=''center''; left.style.gap=''8px'';\n    const dot=document.createElement(''div''); dot.style.width=''10px''; dot.style.height=''10px''; dot.style.borderRadius=''999px''; dot.style.background=p.color;\n    const title=document.createElement(''div''); title.className=''title''; title.textContent=p.title||''(ÁÑ°È°å)'';\n    const meta=document.createElement(''div''); meta.className=''meta''; meta.textContent=`x:${p.pos.x.toFixed(2)} y:${p.pos.y.toFixed(2)} z:${p.pos.z.toFixed(2)}`;\n    left.appendChild(dot); left.appendChild(title);\n    row.appendChild(left); row.appendChild(meta);\n    row.addEventListener(''click'',()=>selectPin(p.id,{fly:true}));\n    el.pinsList.appendChild(row);\n  });\n}\n\n/* ========= Load/Save pins ========= */\nfunction rebuildPinsScene(){\n  pinGroup.children.slice().forEach(ch=> pinGroup.remove(ch));\n  pins.forEach(p=> placePinMesh(p));\n  if(tcontrols.visible && selectedPinId){\n    const p=pins.find(x=>x.id===selectedPinId);\n    if((p && p.mesh)) tcontrols.attach(p.mesh); else tcontrols.detach();\n  }\n  renderNow();\n}\nasync function loadPinsFromActiveSheet(spreadsheetId){\n  pins=[]; selectedPinId=null; el.rightEditor.classList.add(''hidden''); el.rightNoSel.classList.remove(''hidden'');\n  try{\n    const resp = await gapi.client.sheets.spreadsheets.values.get({\n      spreadsheetId, range: `${activeSheet.title}!A2:I`\n    });\n    const rows = resp.result.values || [];\n    rows.forEach(r=>{\n      const [pid, title, body, x, y, z, color, imagesJson] = r;\n      const p = {\n        id: pid || `p_${Math.random().toString(36).slice(2)}`,\n        title: title || '''',\n        body: body || '''',\n        pos: new THREE.Vector3(parseFloat(x)||0, parseFloat(y)||0, parseFloat(z)||0),\n        color: normalizeHex(color || ''#ff6b6b''),\n        images: [],\n        mesh: null\n      };\n      try{ p.images = JSON.parse(imagesJson||''[]''); }catch{ p.images = []; }\n      pins.push(p);\n    });\n    rebuildPinsScene();\n    refreshPinsList();\n    buildColorFilter();\n\n    const meta = await loadSheetMeta(spreadsheetId);\n    await applyMaterialsFromSheet(meta.materials);\n    await applyViewerPrefs(meta.viewer);\n    applyMaterialUIFromSelection();\n  }catch(e){ console.error(''loadPinsFromActiveSheet failed'', e); }\n}\nasync function upsertPinToSheet(){\n  if(viewOnly) return;\n  const spreadsheetId = extractSpreadsheetId(el.inputSheet.value.trim()); if(!spreadsheetId) return;\n  const p = pins.find(x=>x.id===selectedPinId) || pins[pins.length-1]; if(!p) return;\n  try{\n    const col = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId, range: `${activeSheet.title}!A:A` });\n    const rows = col.result.values || [];\n    let rowIndex = -1;\n    for(let i=0;i<rows.length;i++){ if(rows[i][0]===p.id){ rowIndex=i; break; } }\n    const values = [[ p.id, p.title||'''', p.body||'''', p.pos.x, p.pos.y, p.pos.z, p.color, JSON.stringify(ensureArray(p.images)), new Date().toISOString() ]];\n    if(rowIndex>=0){\n      const range = `${activeSheet.title}!A${rowIndex+1}:I${rowIndex+1}`;\n      await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId, range, valueInputOption:''RAW'', resource:{ values } });\n    }else{\n      await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId, range: `${activeSheet.title}!A1`, valueInputOption:''RAW'', resource:{ values } });\n    }\n  }catch(e){ console.error(e); }\n}\nasync function deletePinFromActiveSheet(spreadsheetId, pinId){\n  const col = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId, range: `${activeSheet.title}!A:A` });\n  const rows = col.result.values || [];\n  let rowIndex = -1;\n  for(let i=0;i<rows.length;i++){ if(rows[i][0]===pinId){ rowIndex=i; break; } }\n  if(rowIndex<0) return;\n  await gapi.client.sheets.spreadsheets.batchUpdate({\n    spreadsheetId,\n    resource:{\n      requests:[{ deleteDimension:{\n        range:{ sheetId: activeSheet.sheetId, dimension:''ROWS'', startIndex:rowIndex, endIndex:rowIndex+1 }\n      }}]\n    }\n  });\n}\n\n/* ========= Attach / Upload ========= */\nel.btnAttach.addEventListener(''click'', async ()=>{\n  if(viewOnly) return;\n  const fileInput = el.imgLocal;\n  fileInput.value = '''';\n  fileInput.onchange = async ()=>{\n    const file = (fileInput.files && fileInput.files[0]);\n    const p = pins.find(x=>x.id===selectedPinId);\n    if(!file || !p){ return; }\n    try{\n      const blob = await toUploadableBlob(file);\n      const uploaded = await driveMultipartUpload(blob, sanitizeName(file.name), glbParents);\n      const ref = makeDriveRef(uploaded.id, blob.type || ''image/jpeg'');\n      p.images = ensureArray(p.images); p.images.push(ref);\n      renderThumbs(p);\n      setPreview(ref, p);\n      toast(''ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü'');\n      upsertPinToSheet();\n    }catch(err){ console.error(err); alert(''ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü''); }\n  };\n  fileInput.click();\n});\nfunction sanitizeName(n){ return n.replace(/[^\p{Letter}\p{Number}\s._-]+/gu,''_''); }\nasync function toUploadableBlob(file){\n  const ext = (file.name.split(''.'').pop()||'''').toLowerCase();\n  if(ext===''heic'' || ext===''heif''){\n    const ok = await ensureHeic2any();\n    if(!ok) throw new Error(''heic2any unavailable'');\n    const jpegBlob = await window.heic2any({ blob:file, toType:''image/jpeg'', quality:0.95 });\n    return Array.isArray(jpegBlob) ? jpegBlob[0] : jpegBlob;\n  }\n  return file;\n}\nasync function driveMultipartUpload(blob, name, parents){\n  const meta = { name, parents: parents && parents.length ? parents : undefined };\n  const boundary = ''-------loci'' + Math.random().toString(36).slice(2);\n  const bufMeta = new TextEncoder().encode(`\r\n--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(meta)}\r\n\r\n--${boundary}\r\nContent-Type: ${blob.type || ''application/octet-stream''}\r\n\r\n`);\n  const bufTail = new TextEncoder().encode(`\r\n--${boundary}--`);\n  const stream = new Blob([ bufMeta, blob, bufTail ], { type: ''multipart/related; boundary=''+boundary });\n  const res = await fetch(''https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&supportsAllDrives=true'', {\n    method: ''POST'',\n    headers: { ''Authorization'': ''Bearer '' + accessToken },\n    body: stream\n  });\n  if(!res.ok) throw new Error(''Drive upload failed '' + res.status);\n  return await res.json();\n}\n\n/* ========= Folder Picker ========= */\nel.btnPickFromFolder.addEventListener(''click'', openPickerModal);\nel.btnPickerClose.addEventListener(''click'', ()=> el.pickerModal.style.display=''none'');\nel.btnPickerReload.addEventListener(''click'', loadFolderImages);\n\nasync function openPickerModal(){\n  if(!glbParents || !glbParents.length){ alert(''GLB„ÅÆË¶™„Éï„Ç©„É´„ÉÄ„Åå‰∏çÊòé„Åß„Åô„ÄÇÂÖà„Å´GLB„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ''); return; }\n  await loadFolderImages();\n  el.pickerModal.style.display=''grid'';\n}\nasync function loadFolderImages(){\n  if(!accessToken){ alert(''ÂÖà„Å´„Çµ„Ç§„É≥„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ''); return; }\n  el.pickerGrid.innerHTML = ''<div class="small">Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶</div>'';\n  const cells = [];\n  try{\n    for(const parent of glbParents){\n      const q = `''${parent}'' in parents and trashed=false and (mimeType contains ''image/'')`;\n      const resp = await gapi.client.drive.files.list({\n        q, pageSize: 200,\n        fields: ''files(id,name,mimeType,fileExtension,hasThumbnail,thumbnailLink)'',\n        includeItemsFromAllDrives: true,\n        supportsAllDrives: true\n      });\n      const files = resp.result.files || [];\n      for(const f of files){\n        const id = f.id;\n        const mime = f.mimeType || '''';\n        const isHeic = isHeicMimeOrExt(mime, f.fileExtension);\n        const ref = makeDriveRef(id, mime);\n        const cell = document.createElement(''div''); cell.style.background=''#0c1118''; cell.style.border=''1px solid #223146''; cell.style.borderRadius=''12px''; cell.style.padding=''8px''; cell.style.cursor=''pointer''; cell.style.display=''flex''; cell.style.flexDirection=''column''; cell.style.gap=''6px'';\n        const img = document.createElement(''img''); img.alt = f.name; img.style.width=''100%''; img.style.height=''110px''; img.style.objectFit=''cover''; img.style.borderRadius=''8px'';\n        const tag = document.createElement(''div''); tag.className=''small''; tag.textContent = isHeic ? ''HEIC/HEIF (Â§âÊèõ/„Çµ„É†„ÉçË°®Á§∫)'' : (mime||''image'');\n        const cap = document.createElement(''div''); cap.textContent = f.name; cap.className=''small'';\n\n        let usedFallback = false;\n        if(f.hasThumbnail && f.thumbnailLink){\n          const hi = upscaleThumbnailUrl(f.thumbnailLink, isHeic? 1024 : 512);\n          const sep = hi.includes(''?'') ? ''&'' : ''?'';\n          img.src = hi + sep + ''access_token='' + encodeURIComponent(accessToken);\n          img.onerror = async ()=>{\n            usedFallback = true;\n            try{\n              const url = await resolveImageObjectURL(ref, {preferThumb:true});\n              img.src = url;\n            }catch{ cell.style.opacity=''.5''; cell.style.pointerEvents=''none''; }\n          };\n        }else{\n          try{\n            const url = await resolveImageObjectURL(ref, {preferThumb:true});\n            img.src = url;\n          }catch{ cell.style.opacity=''.5''; cell.style.pointerEvents=''none''; }\n        }\n\n        img.onerror = ()=>{ if(!usedFallback){ cell.style.opacity=''.5''; cell.style.pointerEvents=''none''; } };\n        cell.appendChild(img); cell.appendChild(cap); cell.appendChild(tag);\n        cell.addEventListener(''click'', ()=>{ if(cell.style.pointerEvents===''none'') return; chooseFolderImage(ref); });\n        cells.push(cell);\n      }\n    }\n    el.pickerGrid.innerHTML='''';\n    if(!cells.length){\n      el.pickerGrid.innerHTML = ''<div class="small">„Éï„Ç©„É´„ÉÄ„Å´ÁîªÂÉè„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</div>'';\n    }else{\n      cells.forEach(c=> el.pickerGrid.appendChild(c));\n    }\n  }catch(e){\n    console.error(e);\n    el.pickerGrid.innerHTML = ''<div class="small">Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ</div>'';\n  }\n}\nfunction chooseFolderImage(ref){\n  el.pickerModal.style.display=''none'';\n  const p = pins.find(x=>x.id===selectedPinId);\n  if(!p){ alert(''ÂÖà„Å´„Éî„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ''); return; }\n  p.images = ensureArray(p.images); p.images.push(ref);\n  renderThumbs(p);\n  setPreview(ref, p);\n  upsertPinToSheet();\n}\n\n/* ========= Caption Lists ========= */\nasync function refreshCaptionLists(spreadsheetId){\n  const resp = await gapi.client.sheets.spreadsheets.get({\n    spreadsheetId,\n    fields: ''sheets(properties(sheetId,title,index))''\n  });\n  const sheets = (resp.result.sheets || []).map(s => s.properties);\n  el.listSelect.innerHTML = '''';\n  sheets.forEach(p => {\n    const o = document.createElement(''option'');\n    o.value = String(p.sheetId);\n    o.textContent = p.title;\n    el.listSelect.appendChild(o);\n  });\n  let pick = sheets.find(s => s.title === ''pins'') || sheets[0];\n  if (!activeSheet.sheetId) {\n    if (pick){ activeSheet = { sheetId: pick.sheetId, title: pick.title }; }\n  } else {\n    const same = sheets.find(s => s.sheetId === activeSheet.sheetId);\n    if (!same) {\n      pick = sheets.find(s => s.title === ''pins'') || sheets[0];\n      if (pick){ activeSheet = { sheetId: pick.sheetId, title: pick.title }; }\n    } else {\n      activeSheet.title = same.title;\n    }\n  }\n  if (activeSheet.sheetId){ el.listSelect.value = String(activeSheet.sheetId); }\n  if(!viewOnly){ [''listNew'',''listDelete''].forEach(id=>document.getElementById(id).disabled=false); }\n}\nel.listSelect.addEventListener(''change'', async (e)=>{\n  const spreadsheetId = extractSpreadsheetId(el.inputSheet.value.trim());\n  if(!spreadsheetId) return;\n  const sheetId = Number(e.target.value);\n  const title = e.target.options[e.target.selectedIndex].textContent;\n  activeSheet = { sheetId, title };\n  await loadPinsFromActiveSheet(spreadsheetId);\n  toast(`„Ç≠„É£„Éó„Ç∑„Éß„É≥„É™„Çπ„Éà„ÇíÂàáÊõø: ${title}`);\n});\nel.listNew.addEventListener(''click'', async ()=>{\n  if(viewOnly) return;\n  const spreadsheetId = extractSpreadsheetId(el.inputSheet.value.trim());\n  if(!spreadsheetId) return;\n  const title = prompt(''Êñ∞„Åó„ÅÑ„Ç≠„É£„Éó„Ç∑„Éß„É≥„É™„Çπ„ÉàÂêç„ÇíÂÖ•Âäõ'', `pins_${Date.now().toString().slice(-5)}`);\n  if(!title) return;\n  const add = await gapi.client.sheets.spreadsheets.batchUpdate({\n    spreadsheetId,\n    resource:{ requests:[ { addSheet:{ properties:{ title } } } ] }\n  });\n  const newSheetId = add.result.replies[0].addSheet.properties.sheetId;\n  await gapi.client.sheets.spreadsheets.values.update({\n    spreadsheetId, range: `${title}!A1`,\n    valueInputOption:''RAW'',\n    resource:{ values: [[ ''pin_id'',''title'',''body'',''x'',''y'',''z'',''color'',''images'',''updated_at'' ]] }\n  });\n  await refreshCaptionLists(spreadsheetId);\n  activeSheet = { sheetId: newSheetId, title };\n  el.listSelect.value = String(newSheetId);\n  pins = []; selectedPinId = null; rebuildPinsScene(); refreshPinsList();\n\n  await saveSheetMeta(spreadsheetId, {\n    materials: {version:2, byKey:{}},\n    viewer: {version:1, bgColor: el.bgColor.value || ''#0a0f16'', projection: usingOrtho ? ''orthographic'' : ''perspective'' }\n  });\n\n  toast(`Êñ∞„Åó„ÅÑ„É™„Çπ„Éà„Çí‰ΩúÊàê: ${title}`);\n});\nel.listDelete.addEventListener(''click'', async ()=>{\n  if(viewOnly) return;\n  const spreadsheetId = extractSpreadsheetId(el.inputSheet.value.trim());\n  if(!spreadsheetId || !activeSheet.sheetId) return;\n  const g = await gapi.client.sheets.spreadsheets.get({ spreadsheetId, fields: ''sheets(properties(sheetId))'' });\n  const count = (g.result.sheets||[]).length;\n  if(count <= 1){ alert(''ÊúÄÂæå„ÅÆ„Ç∑„Éº„Éà„ÅØÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì''); return; }\n  if(!confirm(`„Ç≠„É£„Éó„Ç∑„Éß„É≥„É™„Çπ„Éà„Äå${activeSheet.title}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;\n  await gapi.client.sheets.spreadsheets.batchUpdate({\n    spreadsheetId,\n    resource:{ requests:[ { deleteSheet:{ sheetId: activeSheet.sheetId } } ] }\n  });\n  await refreshCaptionLists(spreadsheetId);\n  await loadPinsFromActiveSheet(spreadsheetId);\n  toast(''„É™„Çπ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü'');\n});\n\n/* ========= Buttons ========= */\nel.btnLoad.addEventListener(''click'', async ()=>{\n  const raw = el.inputGLB.value.trim();\n  const fid = extractDriveFileId(raw);\n  if(!fid){\n    alert(''GLB„ÅÆ FileId/URL „ÇíÊ≠£„Åó„ÅèÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n„Éí„É≥„Éà: ÂÖ±ÊúâURL„ÅÆ„Åæ„ÅæË≤º‰ªò„ÅßOK„Åß„Åô„ÄÇIDÂçò‰Ωì„ÅÆÂ†¥Âêà„ÅØ30ÊñáÂ≠ó‰ª•‰∏ä„Åß„ÄÅÊú´Â∞æ„Åå _ „ÅßÁµÇ„Çè„Å£„Å¶„ÅÑ„Å™„ÅÑÂÆåÂÖ®„Å™ID„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'');\n    return;\n  }\n  el.inputGLB.value = fid;\n  await loadGLBByFileId(fid);\n});\nel.btnViewOnly.addEventListener(''click'', ()=>{\n  const fid = extractDriveFileId(el.inputGLB.value.trim());\n  const sid = extractSpreadsheetId(el.inputSheet.value.trim());\n  const url = new URL(location.href);\n  if (fid) url.searchParams.set(''fileId'', fid);\n  if (sid) url.searchParams.set(''sheetId'', sid);\n  url.searchParams.set(''view'', ''1'');\n  navigator.clipboard.writeText(url.toString());\n  toast(''Èñ≤Ë¶ß„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'');\n});\nel.btnWide.addEventListener(''click'', ()=>{\n  document.body.classList.toggle(''wide'');\n  el.btnWide.textContent = document.body.classList.contains(''wide'') ? ''üìã „Éë„Éç„É´Ë°®Á§∫'' : ''üì∫ „Éì„É•„Éº„Ç¢Êã°Â§ß'';\n  setTimeout(()=>{ resize(); updateConnector(); }, 50);\n});\nel.btnTogglePins.addEventListener(''click'', ()=>{\n  pinGroup.visible = !pinGroup.visible;\n  el.btnTogglePins.textContent = ''„Éî„É≥Ë°®Á§∫: '' + (pinGroup.visible? ''ON'' : ''OFF'');\n  applyPinVisibilityFilter(); renderNow();\n});\nel.btnAddPin.addEventListener(''click'', ()=>{\n  if(viewOnly) return;\n  addPinMode = !addPinMode;\n  el.viewerCanvas.style.cursor = addPinMode ? ''crosshair'' : ''default'';\n  el.modeLabel.textContent = addPinMode ? ''AddPin'' : ''Orbit'';\n  el.btnAddPin.textContent = addPinMode ? ''Ôºã „Éî„É≥ËøΩÂä†: ON'' : ''Ôºã „Éî„É≥ËøΩÂä†„É¢„Éº„Éâ'';\n});\nel.btnGizmo.addEventListener(''click'', ()=>{\n  if(viewOnly) return;\n  const enable = !tcontrols.visible;\n  tcontrols.visible = enable; tcontrols.enabled = enable;\n  el.btnGizmo.textContent = ''„ÇÆ„Ç∫„É¢: '' + (enable ? ''ON'' : ''OFF'');\n  const p = pins.find(x=>x.id===selectedPinId);\n  if(enable && p && p.mesh){ tcontrols.attach(p.mesh); }\n  else{ tcontrols.detach(); }\n});\nel.btnUndo.addEventListener(''click'', ()=>{\n  if(viewOnly) return;\n  const last = undoStack.pop(); if(!last) return;\n  if(last.type===''add''){ const idx = pins.findIndex(p=>p.id===last.id); if(idx>=0){ const pin = pins[idx]; if(pin.mesh) pinGroup.remove(pin.mesh); pins.splice(idx,1); refreshPinsList(); renderNow(); upsertPinToSheet(); } }\n});\nel.btnDeletePin.addEventListener(''click'', async ()=>{\n  if(viewOnly) return;\n  const p = pins.find(x=>x.id===selectedPinId); if(!p) return;\n  const spreadsheetId = extractSpreadsheetId(el.inputSheet.value.trim());\n  if(p.mesh) pinGroup.remove(p.mesh);\n  pins = pins.filter(x=>x.id!==p.id);\n  selectedPinId = null;\n  refreshPinsList(); updateViewerPreviewForPin(null); el.rightEditor.classList.add(''hidden''); el.rightNoSel.classList.remove(''hidden'');\n  renderNow();\n  if(spreadsheetId){ try{ await deletePinFromActiveSheet(spreadsheetId, p.id); }catch(e){ console.error(e); } }\n});\n\n\n/* ========= GLB Load from URL ========= */\nasync function loadGLBFromURL(url, opts={}){\n  try{\n    if(!loader) loader = new GLTFLoader();\n    // cleanup previous model\n    if(currentModel){\n      try{\n        scene.remove(currentModel);\n        currentModel.traverse(obj=>{\n          if(obj.geometry) obj.geometry.dispose();\n          if(obj.material){\n            const mats = Array.isArray(obj.material) ? obj.material : [obj.material];\n            mats.forEach(m=>{\n              try{\n                if(m.map) m.map.dispose();\n                if(m.normalMap) m.normalMap.dispose();\n                if(m.roughnessMap) m.roughnessMap.dispose();\n                if(m.metalnessMap) m.metalnessMap.dispose();\n                if(m.aoMap) m.aoMap.dispose();\n                if(m.emissiveMap) m.emissiveMap.dispose();\n                m.dispose && m.dispose();\n              }catch(_){}\n            });\n          }\n        });\n      }catch(_){}\n      currentModel = null;\n    }\n    const gltf = await loader.loadAsync(url);\n    const root = gltf.scene || (gltf.scenes && gltf.scenes[0]);\n    if(!root) throw new Error(''GLB has no scene'');\n    currentModel = root;\n    scene.add(root);\n    // reset pins group above model if needed\n    if(pinGroup) scene.add(pinGroup);\n    // collect materials/UI refresh\n    try{ collectMaterials(); }catch(_){}\n    try{ focusOrigin(); }catch(_){}\n    try{ if(window.M3DUI && typeof window.M3DUI.modelLoaded===''function'') window.M3DUI.modelLoaded(); }catch(_){}\n    return root;\n  }catch(e){\n    console.error(''loadGLBFromURL failed'', e);\n    throw e;\n  }\n}\n\n/* ========= GLB Load (LOW-MEM for iOS) ========= */\n\n\nasync function loadGLBByFileId(fileId){\n  try{\n    const tokenObj = (window.gapi && gapi.client && gapi.client.getToken && gapi.client.getToken()) || null;\n    const token = (tokenObj && tokenObj.access_token) || window.accessToken || '''';\n    if(!token){ alert(''„Çµ„Ç§„É≥„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ''); return; }\n\n    // 1) Fetch Drive metadata (need parents to locate spreadsheet)\n    let meta = null;\n    try{\n      const r = await gapi.client.drive.files.get({\n        fileId, fields: ''id,name,mimeType,parents'', supportsAllDrives: true\n      });\n      meta = r.result;\n    }catch(e){\n      console.warn(''meta fetch failed (non-fatal)'', e);\n    }\n\n    // 2) Download GLB binary with Bearer\n    const url = `https://www.googleapis.com/drive/v3/files/${encodeURIComponent(fileId)}?alt=media&supportsAllDrives=true`;\n    const res = await fetch(url, { headers: { ''Authorization'': ''Bearer '' + token } });\n    if(!res.ok){\n      const txt = await res.text().catch(()=>'''');\n      throw new Error(''GLB download failed: '' + res.status + '' '' + txt + ''\n\nID„ÅåÊ≠£„Åó„ÅÑ„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂÖ±ÊúâURL„ÅÆ„Ç≥„Éî„Éö„ÄÅ„Åæ„Åü„ÅØ30ÊñáÂ≠ó‰ª•‰∏ä„ÅÆÂÆåÂÖ®„Å™FileId„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'');\n    }\n    const blob = await res.blob();\n    const objUrl = URL.createObjectURL(blob);\n    try{\n      await loadGLBFromURL(objUrl, {name: (meta && meta.name) || ''model.glb''});\n    }finally{\n      URL.revokeObjectURL(objUrl);\n    }\n\n    // 3) Spreadsheet„ÇíÁ¢∫ÂÆö„Åó„Å¶„Éî„É≥Ë™≠„ÅøËæº„Åø\n    try{\n      const spreadsheetId = await findOrCreateSpreadsheetInGlbFolder(meta || {id:fileId, name:''model''});\n      if (spreadsheetId){\n        if (el && el.inputSheet) el.inputSheet.value = spreadsheetId;\n        await loadPinsFromActiveSheet(spreadsheetId);\n      }\n    }catch(e){\n      console.warn(''pin spreadsheet resolve failed'', e);\n    }\n  }catch(e){\n    console.error(''loadGLBByFileId failed'', e);\n    alert(''GLB„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: '' + (e && e.message ? e.message : e));\n  }\n}\n\n\n\n/* ========= Save viewer prefs ========= */\n[''viewFront'',''viewBack'',''viewLeft'',''viewRight'',''viewTop'',''viewBottom''].forEach(id=>{\n  document.getElementById(id).addEventListener(''click'', ()=> debouncedSaveMaterials());\n});\n\n/* ========= Entry ========= */\nfunction buildColorPresetsOnce(){\n  el.colorPresets.innerHTML='''';\n  PRESET_COLORS.forEach(c=>{\n    const b=document.createElement(''button'');\n    b.style.width=''18px''; b.style.height=''18px'';\n    b.style.borderRadius=''999px''; b.style.border=''2px solid #223146'';\n    b.style.background=c; b.title=c;\n    b.addEventListener(''click'',()=>{\n      currentColor=c;\n      if(selectedPinId){\n        const p=pins.find(x=>x.id===selectedPinId);\n        p.color=normalizeHex(c);\n        placePinMesh(p);\n        refreshPinsList();\n        filterColors.add(p.color);\n        buildColorFilter();\n        debouncedSave();\n      }\n    });\n    el.colorPresets.appendChild(b);\n  });\n}\nbuildColorPresetsOnce();\n\nfunction viewerInitWrap(){ viewerInit(); }\nviewerInitWrap();\n\n</script>
<!-- M3D vNext UI containers -->
<div id="m3d-caption-layer" aria-label="caption overlay layer" hidden></div>
<div id="m3d-mobile-caption" aria-label="mobile caption panel" hidden>
  <div class="m3d-cap__title" id="m3d-mcap-title"></div>
  <div class="m3d-cap__imgwrap">
    <img id="m3d-mcap-img" class="m3d-cap__img" alt="caption image" />
    <div id="m3d-mcap-ph" class="m3d-cap__placeholder">ÁîªÂÉè„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>
  </div>
  <div class="m3d-cap__body" id="m3d-mcap-body"></div>
  <div class="m3d-cap__actions" id="m3d-mcap-actions"></div>
</div>
<script>
(function(){
  if (window.M3DUI && window.M3DUI.__ready) return;

  function $(id){ return document.getElementById(id); }
  function isMobile(){
    try{ return window.matchMedia("(max-width: 900px)"").matches; }\n    catch(e){ return (window.innerWidth||1024) <= 900; }\n  }\n\n  var state = { desktopWindows:{}, activePin:null };\n\n  function ensureRoot(){\n    document.body.classList.add('m3d-ui-vnext');\n    var overlay = $(""m3d-caption-layer"");\n    var mcap    = $(""m3d-mobile-caption"");\n    var viewer  = $(""viewer"");\n    // keep hidden until first use\n    /* if (overlay) overlay.hidden = false;\n    if (mcap)    mcap.hidden = false; */\n    if (viewer){\n      if (getComputedStyle(viewer).position === 'static'){ viewer.style.position = 'relative'; }\n      // ensure overlay is a child of #viewer for proper absolute positioning\n      if (overlay && overlay.parentElement !== viewer){ viewer.appendChild(overlay); }\n      // on mobile, place mobile caption just after viewer\n      if (isMobile() && mcap && mcap.parentElement !== viewer.parentElement){\n        viewer.parentElement.insertBefore(mcap, viewer.nextSibling);\n      }\n    }\n  }\n\n  function makeDraggable(handle, target){\n    var sx=0, sy=0, ox=0, oy=0, dragging=false;\n    handle.addEventListener('mousedown', function(e){\n      dragging=true; sx=e.clientX; sy=e.clientY;\n      var r = target.getBoundingClientRect(); ox=r.left + window.scrollX; oy=r.top + window.scrollY;\n      e.preventDefault();\n    });\n    document.addEventListener('mousemove', function(e){\n      if(!dragging) return;\n      var dx=e.clientX-sx, dy=e.clientY-sy;\n      target.style.left = (ox+dx) + 'px';\n      target.style.top  = (oy+dy) + 'px';\n    });\n    document.addEventListener('mouseup', function(){ dragging=false; });\n  }\n\n  function createCapWindow(pin){\n    try{ if(!(window.M3DUI && window.M3DUI.__modelReady)) return null; }catch(_){ return null; }\n    var overlay = $(""m3d-caption-layer"");\n    if(!overlay) return null;\n    overlay.hidden = false;\n    var div = document.createElement('div');\n    div.className = 'm3d-capwin';\n    div.style.left = (24 + Math.floor(Math.random()*60)) + 'px';\n    div.style.top  = (24 + Math.floor(Math.random()*40)) + 'px';\n\n    var bar = document.createElement('div'); bar.className = 'm3d-capwin__titlebar';\n    var title = document.createElement('div'); title.textContent = (pin && pin.title) ? pin.title : '„Ç≠„É£„Éó„Ç∑„Éß„É≥';\n    var btnX = document.createElement('button'); btnX.className='m3d-capwin__close'; btnX.textContent='‚úï';\n    btnX.addEventListener('click', function(){ if(div.parentElement) div.parentElement.removeChild(div); });\n    bar.appendChild(title); bar.appendChild(btnX);\n    div.appendChild(bar);\n\n    var body = document.createElement('div'); body.className='m3d-capwin__body';\n    if(pin && pin.img){\n      var img = document.createElement('img'); img.className='m3d-capwin__img'; img.src=pin.img; img.alt='caption image';\n      body.appendChild(img);\n      var act = document.createElement('div'); act.className='m3d-capwin__actions';\n      var a = document.createElement('a'); a.href=pin.img; a.target='_blank'; a.rel='noopener'; a.textContent='ÂÖÉÁîªÂÉè„ÇíÈñã„Åè';\n      act.appendChild(a); body.appendChild(act);\n    }else{\n      var ph = document.createElement('div'); ph.className='m3d-cap__placeholder'; ph.textContent='ÁîªÂÉè„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì';\n      body.appendChild(ph);\n    }\n    var meta = document.createElement('div'); meta.className='m3d-capwin__meta'; meta.textContent = (pin && pin.id) ? ('#'+pin.id) : '';\n    body.appendChild(meta);\n    var text = document.createElement('div'); text.textContent = (pin && pin.body) ? pin.body : '';\n    body.appendChild(text);\n\n    div.appendChild(body);\n    overlay.appendChild(div);\n    makeDraggable(bar, div);\n    return div;\n  }\n\n  function showMobileCaption(pin){\n    var panel = $(""m3d-mobile-caption""); if(!panel) return;\n    var t=$(""m3d-mcap-title""), b=$(""m3d-mcap-body""), img=$(""m3d-mcap-img""), ph=$(""m3d-mcap-ph""), acts=$(""m3d-mcap-actions"");\n    t.textContent = (pin && pin.title) ? pin.title : '„Ç≠„É£„Éó„Ç∑„Éß„É≥';\n    b.textContent = (pin && pin.body)  ? pin.body  : '';\n    acts.innerHTML = '';\n    if(pin && pin.img){\n      img.src = pin.img; img.style.display='block'; ph.style.display='none';\n      var a = document.createElement('a'); a.href=pin.img; a.target='_blank'; a.rel='noopener'; a.textContent='ÂÖÉÁîªÂÉè„ÇíÈñã„Åè';\n      acts.appendChild(a);\n    }else{\n      img.removeAttribute('src'); img.style.display='none'; ph.style.display='flex';\n    }\n    try{\n      var viewer=$(""viewer"");\n      if(viewer){\n        var vw = viewer.clientWidth || window.innerWidth || 360;\n        var vh = viewer.clientHeight|| Math.max(320, Math.floor((window.innerHeight||640)*0.6));\n        img.style.maxWidth  = Math.round(vw*0.5) + 'px';\n        img.style.maxHeight = Math.round(vh*0.4) + 'px';\n      }\n    }catch(_){}\n  }\n\n  function readCurrentPinFromLegacy(){\n    var imgEl = document.getElementById('previewImg');\n    var title = (document.getElementById('capTitleLine')||{}).textContent || '';\n    var body  = (document.getElementById('capBodyLine')||{}).textContent || '';\n    var id    = (window.currentPin && window.currentPin.id) || '';\n    var src   = (imgEl && imgEl.src) || '';\n    var hasImg= !!(imgEl && imgEl.naturalWidth);\n    return { id:id||'', title:title||'', body:body||'', img: hasImg ? src : '' };\n  }\n\n  function onPinSelected(pinLike){\n    var pin = pinLike || readCurrentPinFromLegacy();\n    state.activePin = pin;\n    if (isMobile()){ showMobileCaption(pin); }\n    else { createCapWindow(pin); }\n  }\n\n  window.M3DUI = { __ready:true, onPinSelected:onPinSelected, showMobileCaption:showMobileCaption, createCapWindow:createCapWindow };\n\n  document.addEventListener('DOMContentLoaded', function(){\n    ensureRoot();\n    if (typeof window.selectPin === 'function'){\n      var orig = window.selectPin;\n      window.selectPin = function(){\n        try{ orig.apply(this, arguments); }catch(e){ console.warn(e); }\n        try{ if(window.M3DUI && window.M3DUI.onPinSelected) window.M3DUI.onPinSelected(); }catch(e){ console.warn(e); }\n      };\n    }\n    });window.addEventListener('resize', function(){\n    try{ if (isMobile() && state.activePin) showMobileCaption(state.activePin); }catch(_){}\n  });\n})();\n</script>
<script>

document.addEventListener('DOMContentLoaded'', function(){\n  try{\n    var rc = document.getElementById(''rightCaption'');\n    if(!rc) return;\n    var body = rc.querySelector(''.body'') || rc;\n    if(!document.getElementById(''m3d-caplist'')){\n      var list = document.createElement(''div''); list.id=''m3d-caplist''; body.insertBefore(list, body.firstChild);\n    }\n    if(!document.getElementById(''m3d-capeditor'')){\n      var ed = document.createElement(''div''); ed.id=''m3d-capeditor''; body.appendChild(ed);\n    }\n    // Move known editor block to bottom if exists\n    var editor = document.getElementById(''editor'');\n    if(editor && editor.parentElement !== document.getElementById(''m3d-capeditor'')){\n      document.getElementById(''m3d-capeditor'').appendChild(editor);\n    }\n    // Move known preview out of right pane (overlay/mobile handles viewing)\n    var prev = document.getElementById(''viewerPreview'');\n    if(prev && prev.parentElement === body){\n      // leave it where it is or let overlay handle; no action\n    }\n    // Heuristic: move non-editor controls to list\n    var caplist = document.getElementById(''m3d-caplist'');\n    Array.from(body.children).forEach(function(node){\n      var id = node.id||'''';\n      if(id===''m3d-caplist'' || id===''m3d-capeditor'' || id===''editor'') return;\n      if(node === caplist || node === document.getElementById(''m3d-capeditor'')) return;\n      // keep tabs/headers at top of list\n      if(caplist && node.parentElement===body){\n        caplist.appendChild(node);\n      }\n    });\n  }catch(e){ console.warn(''right panel split failed'', e); }\n});\n\n</script>

<script>
(function(){
  if(!window.M3DUI) return;
  window.M3DUI.__modelReady = false;
  window.M3DUI.modelLoaded = function(){
    window.M3DUI.__modelReady = true;
    try{
      var p = window.M3DUI.__pendingPin;
      if(p){
        window.M3DUI.__pendingPin = null;
        if (window.matchMedia && window.matchMedia('(max-width: 900px)'').matches){\n          window.M3DUI.showMobileCaption(p);\n          var mcapEl=document.getElementById(''m3d-mobile-caption''); if(mcapEl) mcapEl.hidden=false;\n        }else{\n          window.M3DUI.createCapWindow(p);\n          var overlayEl=document.getElementById(''m3d-caption-layer''); if(overlayEl) overlayEl.hidden=false;\n        }\n      }\n    }catch(_){}\n  };\n  function wrapSuccess(fnName){\n    try{\n      var fn = window[fnName];\n      if(typeof fn !== ''function'') return;\n      window[fnName] = async function(){\n        var res = await fn.apply(this, arguments);\n        try{ window.M3DUI.modelLoaded(); }catch(_){}\n        return res;\n      };\n    }catch(_){}\n  }\n  wrapSuccess(''loadGLBFromURL'');\n  wrapSuccess(''loadGLBByFileId'');\n  if(typeof window.M3DUI.onPinSelected === ''function''){\n    var orig = window.M3DUI.onPinSelected;\n    window.M3DUI.onPinSelected = function(pinLike){\n      try{\n        if(!window.M3DUI.__modelReady){\n          window.M3DUI.__pendingPin = pinLike;\n          return;\n        }\n      }catch(_){}\n      return orig.apply(this, arguments);\n    };\n  }\n})();\n</script>


<!-- Minimal HUD & material-queue drain -->
<style>
#_m3d_hud_overlay{position:fixed;inset:0;display:none;background:rgba(0,0,0,.35);z-index:99999}
#_m3d_hud_center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;text-align:center;font:14px system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
._m3d_spinner{width:48px;height:48px;border:4px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:m3dspin 1s linear infinite;margin:0 auto 10px}
@keyframes m3dspin{to{transform:rotate(360deg)}}
</style>
<div id="_m3d_hud_overlay" aria-hidden="true"><div id="_m3d_hud_center"><div class="_m3d_spinner"></div><div id="_m3d_hud_msg">ÈÄö‰ø°‰∏≠‚Ä¶</div></div></div>
<script>
(function(){
  var overlay, msg, ref=0;
  function ensure(){
    overlay = document.getElementById('_m3d_hud_overlay'');\n    msg = document.getElementById(''_m3d_hud_msg'');\n  }\n  window.M3DBusy = {\n    show: function(m){ try{ ensure(); if(m) msg.textContent=m; ref++; overlay.style.display=''block''; }catch(_){}},\n    hide: function(){ try{ ensure(); ref=Math.max(0,ref-1); if(ref===0) overlay.style.display=''none''; }catch(_){} }\n  };\n  // Drain queued material updates after modelLoaded\n  (function(){\n    if(!window.M3DUI) window.M3DUI = {};\n    var orig = window.M3DUI.modelLoaded;\n    window.M3DUI.modelLoaded = function(){\n      try{\n        var q = window.__matQueue || [];\n        window.__matQueue = [];\n        for (var i=0;i<q.length;i++){\n          try{ applyStateToMaterial(q[i][0], q[i][1]); }catch(e){}\n        }\n      }catch(_){}\n      if (typeof orig===''function'') return orig.apply(this, arguments);\n    };\n  })();\n  // Optional: hook fetch/XHR to show busy on Drive/Sheets calls\n  try{\n    var _fetch = window.fetch;\n    window.fetch = function(input, init){\n      try{\n        var url = (typeof input===''string'') ? input : (input && input.url ? input.url : '''');\n        var busy = url && (url.indexOf(''alt=media'')>0 || url.indexOf(''googleapis.com'')>0 || url.indexOf(''/spreadsheets/'')>0);\n        if (busy) M3DBusy.show(''ÈÄö‰ø°‰∏≠‚Ä¶'');\n        var p = _fetch.apply(this, arguments);\n        if (p && typeof p.then===''function''){\n          return p.then(function(v){ if(busy) M3DBusy.hide(); return v; }, function(e){ if(busy) M3DBusy.hide(); throw e; });\n        }\n        if (busy) M3DBusy.hide();\n        return p;\n      }catch(e){ try{ return _fetch.apply(this, arguments); }catch(e2){ throw e2; } }\n    };\n  }catch(_){}\n  try{\n    var X = window.XMLHttpRequest;\n    if (X){\n      var H = function(){ var x = new X(); var url=''''; var open=x.open; x.open=function(m,u){url=String(u||''''); return open.apply(this, arguments);}; var send=x.send; x.send=function(){ var busy=(url.indexOf(''alt=media'')>0||url.indexOf(''googleapis.com'')>0||url.indexOf(''/spreadsheets/'')>0); if(busy) M3DBusy.show(''ÈÄö‰ø°‰∏≠‚Ä¶''); x.addEventListener(''loadend'', function(){ if(busy) M3DBusy.hide(); }); return send.apply(this, arguments); }; return x; };\n      H.prototype = X.prototype; window.XMLHttpRequest = H;\n    }\n  }catch(_){}\n})();\n</script>
</body>
</html>
