<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LociMyu v6.6 (ESM/CDN)</title>
  <link rel="icon" href="data:," />
  <!-- Google OAuth (keys are read by boot.esm.cdn.js) -->
  <meta name="google-oauth-client_id" content="595200751510-ncahnf7edci6b9925becn5to49r6cguv.apps.googleusercontent.com">
  <meta name="google-api-key" content="AIzaSyCUnTCr5yWUWPdEXST9bKP1LpgawU5rIbI">
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --bg:#0f1115; --panel:#0b0d11; --line:#1f2937; --acc:#94a3b8; --text:#cbd5e1; --sel:#60a5fa;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    #app{display:flex;height:100%;}
    #stage{flex:1;position:relative;background:var(--panel);}
    #ui{width:360px;max-width:360px;min-width:320px;border-left:1px solid var(--line);
        display:flex;flex-direction:column;overflow:hidden;}
    header#topbar{display:flex;justify-content:space-between;align-items:center;
      padding:8px 12px;border-bottom:1px solid var(--line);}
    header #brand{font-weight:600;opacity:.85}
    button,select,input{background:#111827;border:1px solid var(--line);color:var(--text);
      border-radius:8px;padding:6px 8px}
    input[type="text"]{width:100%;box-sizing:border-box}
    .row{display:flex;gap:8px;align-items:center}
    .row > *{flex:1}
    .tabs{display:flex;border-bottom:1px solid var(--line)}
    .tabs button{flex:1;border:0;border-bottom:2px solid transparent;padding:8px 12px;
      background:transparent;color:var(--acc);cursor:pointer}
    .tabs button[aria-selected="true"]{color:var(--text);border-bottom-color:#64748b}
    .pane{display:none;padding:12px;overflow:auto;max-width:100%;box-sizing:border-box}
    .pane[data-active="true"]{display:block}
    #gl{width:100%;height:100%;display:block}
    .pad{padding:12px}
    .grp{margin:10px 0}
    .hint{opacity:.7;font-size:12px}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{width:18px;height:18px;border-radius:50%;border:1px solid #0003;cursor:pointer;box-shadow:0 0 0 1px #0004 inset}
    #caption-list{height:160px;overflow:auto;border:1px solid var(--line);border-radius:8px}

    /* Material pane layout */
    .mat-grid{display:grid;grid-template-columns: 1fr; gap:12px; max-width:100%}
    .mat-card{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0c1016}
    .mat-card h4{margin:0 0 8px 0;font-size:13px;opacity:.8}
    .mat-row{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center}
    .nowrap{white-space:nowrap}
    .full{text-align:left;width:100%}
    .inline{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    #pm-opacity{display:grid;grid-template-columns: 1fr auto 48px;gap:10px;align-items:center}
    #pm-opacity output{min-width:3ch;text-align:right;opacity:.8}
    /* Prevent horizontal scroll in the right panel */
    #ui *{max-width:100%}
    #ui{overflow-x:hidden}
  </style>

  <!-- ESM import map (viewer uses these) -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.155.0/build/three.module.js",
      "three/examples/jsm/": "https://unpkg.com/three@0.155.0/examples/jsm/"
    }
  }
  </script>
</head>

<body>
  <div id="app">
    <div id="stage"><canvas id="gl"></canvas></div>

    <aside id="ui">
      <header id="topbar">
        <div id="brand">LociMyu v6.6</div>
        <div class="row" style="gap:6px;flex:0 0 auto">
          <button id="auth-signin">Sign in</button>
        </div>
      </header>

      <div class="pad" style="border-bottom:1px solid var(--line)">
        <div class="row">
          <input id="glbUrl" type="text" placeholder="Drive fileId / GLB URL" />
          <button id="btnGlb">Load</button>
        </div>
        <div class="row" style="margin-top:8px">
          <select id="save-target-sheet"><option value="">Select sheet…</option></select>
          <button id="save-target-create">Create</button>
        </div>
      </div>

      <nav class="tabs" role="tablist">
        <button id="tab-caption" role="tab" aria-selected="true" data-tab="caption">Caption</button>
        <button id="tab-material" role="tab" aria-selected="false" data-tab="material">Material</button>
        <button id="tab-views" role="tab" aria-selected="false" data-tab="views">Views</button>
      </nav>

      <!-- Caption pane (unchanged structure) -->
      <section id="pane-caption" class="pane" data-pane="caption" data-active="true">
        <div class="grp">
          <div class="hint">Pin color</div>
          <div id="pinColorChips" class="chips"></div>
        </div>
        <div class="grp">
          <div class="hint">Filter</div>
          <div id="pinFilterChips" class="chips"></div>
        </div>
        <div class="grp">
          <div class="hint">Caption list</div>
          <div id="caption-list"></div>
        </div>
        <div class="grp">
          <div class="hint">Title / Body</div>
          <input id="caption-title" placeholder="Title" />
          <input id="caption-body" placeholder="Body" />
        </div>
        <div class="grp">
          <div class="hint">Images (auto from GLB folder)</div>
          <div id="images-grid"></div>
          <div class="row" style="margin-top:8px">
            <button id="btnRefreshImages" class="full">Refresh images</button>
          </div>
          <div id="images-status" class="hint" style="margin-top:6px"></div>
        </div>
      </section>

      <!-- Material pane (refined) -->
      <section id="pane-material" class="pane" data-pane="material">
        <div class="mat-grid">

          <div class="mat-card">
            <h4>Per‑material opacity (saved per sheet)</h4>
            <div id="pm-opacity">
              <select id="pm-material" aria-label="Select material">
                <option value="">— Select material —</option>
              </select>
              <input type="range" id="pm-opacity-range" min="0" max="1" step="0.01" value="1" />
              <output id="pm-opacity-val">1.00</output>
            </div>
            <div class="hint">Pick a material, then set its opacity. This does not change global opacity above.</div>
          </div>

          <div class="mat-card">
            <h4>Shading</h4>
            <div class="inline">
              <label class="nowrap"><input id="pm-flag-doublesided" type="checkbox"> Double‑sided</label>
              <label class="nowrap"><input id="pm-flag-unlit" type="checkbox"> Unlit‑like</label>
            </div>
          </div>

          <div class="mat-card">
            <h4>Chroma key</h4>
            <!-- Row 1: Enable + Color -->
            <div class="inline" style="margin-bottom:8px">
              <label class="nowrap"><input id="pm-chroma-enable" type="checkbox"> Enable</label>
              <input id="pm-chroma-color" type="color" value="#000000" aria-label="Color">
            </div>
            <!-- Row 2: Tolerance -->
            <div class="mat-row" style="margin-bottom:6px">
              <span class="nowrap">Tolerance</span>
              <input id="pm-chroma-tol" type="range" min="0" max="1" step="0.01" value="0.10">
            </div>
            <!-- Row 3: Feather -->
            <div class="mat-row">
              <span class="nowrap">Feather</span>
              <input id="pm-chroma-feather" type="range" min="0" max="1" step="0.01" value="0.00">
            </div>
          </div>

        </div>
      </section>

      <section id="pane-views" class="pane" data-pane="views">
        <div class="grp">
          <button id="view-save">Save view</button>
          <div class="row"><label><input type="checkbox" id="proj-ortho" /> Orthographic</label></div>
        </div>
        <div id="views-preset-list"></div>
      </section>
    </aside>
  </div>

  <!-- Tabs behavior -->
  <script>
    (function(){
      const tabs = document.querySelectorAll('[role="tab"]');
      const panes = document.querySelectorAll('.pane');
      tabs.forEach(t => t.addEventListener('click', () => {
        tabs.forEach(x => x.setAttribute('aria-selected', String(x===t)));
        panes.forEach(p => p.dataset.active = String(p.dataset.pane===t.dataset.tab));
      }));
    })();
  </script>

  <!-- Boot runtime -->
  <script type="module" src="./boot.esm.cdn.js"></script>
  <link rel="stylesheet" href="app.sheet-rename.css" />
  <script type="module" src="sheet-rename.module.js"></script>

  <!-- Robust, idempotent material orchestrator (UI-only; no breaking changes) -->
  <script type="module">
    const $ = (s)=>document.querySelector(s);

    function listFromViewer(viewer){
      try { return (viewer?.listMaterials?.() || []).map(r=>r?.name).filter(Boolean); }
      catch { return []; }
    }
    function listFromScene(){
      const names = new Set();
      const s = window.__LM_SCENE;
      s?.traverse(o=>{
        if (!o.isMesh || !o.material) return;
        (Array.isArray(o.material)?o.material:[o.material]).forEach(m=>m?.name && names.add(m.name));
      });
      return [...names];
    }
    function dedup(names){ return [...new Set(names)].filter(n=>!/^#\d+$/.test(n)); }

    function fillSelect(names){
      const sel = $('#pm-material'); if (!sel) return;
      const cur = sel.value;
      sel.innerHTML = '<option value=\"\">— Select material —</option>' +
        names.map(n=>`<option value=\"${n}\">${n}</option>`).join('');
      if (cur && names.includes(cur)) sel.value = cur;
      updateValueDisplay();
    }

    function setOpacityByName(name, v){
      v = Math.max(0, Math.min(1, Number(v)));
      import('./viewer.module.cdn.js').then(viewer=>{
        if (viewer?.applyMaterialPropsByName) {
          viewer.applyMaterialPropsByName(name, { opacity:v });
          return;
        }
        const s = window.__LM_SCENE;
        s?.traverse(o=>{
          if (!o.isMesh || !o.material) return;
          (Array.isArray(o.material)?o.material:[o.material]).forEach(m=>{
            if ((m?.name||'')===name){ m.transparent=v<1; m.opacity=v; m.depthWrite=v>=1; m.needsUpdate=true; }
          });
        });
      });
    }

    function getOpacityByName(name){
      let val=null;
      const s = window.__LM_SCENE;
      s?.traverse(o=>{
        if (val!=null) return;
        if (!o.isMesh || !o.material) return;
        (Array.isArray(o.material)?o.material:[o.material]).some(m=>{
          if ((m?.name||'')===name){ val = Number(m.opacity ?? 1); return true; }
          return false;
        });
      });
      return (val==null?1:Math.max(0,Math.min(1,val)));
    }

    // UI wiring
    const sel = $('#pm-material');
    const rng = $('#pm-opacity-range');
    const out = $('#pm-opacity-val');
    function updateValueDisplay(){
      const n = sel?.value; const v = n ? getOpacityByName(n) : 1;
      if (rng) rng.value = v; if (out) out.textContent = (Number(v)||1).toFixed(2);
    }
    sel?.addEventListener('change', updateValueDisplay);
    rng?.addEventListener('input', ()=>{
      const n = sel?.value; if (!n) return;
      const v = Number(rng.value||1);
      out.textContent = v.toFixed(2);
      setOpacityByName(n, v);
    }, {passive:true});

    // Flags + chroma → dispatch events for runtime (non-breaking)
    function fire(id, type, payload){
      const name = sel?.value; if (!name) return;
      document.dispatchEvent(new CustomEvent(type, { detail: { name, ...payload }}));
    }
    $('#pm-flag-doublesided')?.addEventListener('change', e=>fire('pm-flag-doublesided','pm:flag-change',{doubleSided: e.target.checked}));
    $('#pm-flag-unlit')?.addEventListener('change', e=>fire('pm-flag-unlit','pm:flag-change',{unlitLike: e.target.checked}));
    $('#pm-chroma-enable')?.addEventListener('change', e=>fire('pm-chroma-enable','pm:chroma-change',{
      enabled:e.target.checked, color:$('#pm-chroma-color')?.value || '#000000',
      tolerance:Number($('#pm-chroma-tol')?.value||0), feather:Number($('#pm-chroma-feather')?.value||0)
    }));
    ['pm-chroma-color','pm-chroma-tol','pm-chroma-feather'].forEach(id=>{
      $('#'+id)?.addEventListener('input', ()=>$('#pm-chroma-enable')?.checked && fire(id,'pm:chroma-change',{
        enabled:true, color:$('#pm-chroma-color')?.value || '#000000',
        tolerance:Number($('#pm-chroma-tol')?.value||0), feather:Number($('#pm-chroma-feather')?.value||0)
      }), {passive:true});
    });

    // Populate materials only after model is truly ready
    async function populateWhenReady(){
      // 1) Wait for scene-ready (bridge guarantees after GLB load)
      if (!window.__LM_SCENE) {
        await new Promise(r=>document.addEventListener('lm:scene-ready', r, {once:true}));
      }
      // 2) Also wait a micro-queue for materials to attach in slow models
      await new Promise(r=>setTimeout(r, 50));
      // 3) Try multiple times (max ~6s) until we get non-empty
      let tries=0;
      let names=[];
      const viewer = await import('./viewer.module.cdn.js').catch(()=>({}));
      while (tries++ < 30) {
        names = [...new Set([ ...(viewer?.listMaterials?.()||[]).map(m=>m?.name).filter(Boolean),
                               ...(() => { const s=window.__LM_SCENE, set=new Set(); s?.traverse(o=>{
                                  if (!o.isMesh||!o.material) return;
                                  (Array.isArray(o.material)?o.material:[o.material]).forEach(m=>m?.name&&set.add(m.name));
                               }); return [...set]; })()
                             ])].filter(n=>!/^#\d+$/.test(n));
        if (names.length) break;
        await new Promise(r=>setTimeout(r, 200));
      }
      if (names.length) {
        const sel = document.querySelector('#pm-material');
        if (sel) {
          const cur = sel.value;
          sel.innerHTML = '<option value=\"\">— Select material —</option>' + names.map(n=>`<option value=\"${n}\">${n}</option>`).join('');
          if (cur && names.includes(cur)) sel.value = cur;
        }
      } else {
        console.warn('[mat-orch] materials still empty after retries (will wait for next model)');
      }
    }

    // Trigger on load and on Model-ready events
    populateWhenReady();
    document.addEventListener('lm:model-ready', populateWhenReady); // fallback if both exist
    document.addEventListener('lm:materials-ready', populateWhenReady);

    // Also refresh when user opens Material tab
    document.getElementById('tab-material')?.addEventListener('click', populateWhenReady);
  </script>

  <!-- Keep existing modules (they listen to our custom events if needed) -->
  <script type="module" src="./viewer.bridge.module.js"></script>
  <script type="module" src="./material.orchestrator.js"></script>
</body>
</html>
