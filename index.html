<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LociMyu — 3D+Caption Tool</title>

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 16 16%27%3E%3Ccircle cx=%228%22 cy=%228%22 r=%228%22 fill=%22%236ea8fe%22/%3E%3Ctext x=%228%22 y=%2211%22 font-size=%2210%22 text-anchor=%22middle%22 fill=%22%230b1220%22%3EL%3C/text%3E%3C/svg%3E" />

  <link rel="stylesheet" href="css/styles.css" />

  <!-- three.js importmap -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <!-- デバッグUI（必要なら残す、不要なら削除可） -->
  <style>
    #locimyu-badge{position:fixed;left:8px;bottom:8px;background:#51cf66;color:#0b1f12;padding:6px 10px;border-radius:999px;font:12px/1 ui-sans-serif,system-ui;box-shadow:0 2px 10px #0006;display:none;z-index:99998}
    #locimyu-debug{position:fixed;right:8px;bottom:8px;background:#111c;color:#fff;border:1px solid #444;border-radius:8px;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;padding:6px 8px;max-width:50vw;max-height:35vh;overflow:auto;display:none;z-index:99999}
  </style>
</head>
<body>
  <!-- デバッグ表示 -->
  <div id="locimyu-badge">READY</div>
  <div id="locimyu-debug"><b>Debug</b><div id="locimyu-log"></div></div>
  <script>
    (function(){
      const badge=document.getElementById('locimyu-badge');
      const box=document.getElementById('locimyu-debug');
      const logEl=document.getElementById('locimyu-log');
      function log(msg){
        box.style.display='block';
        const d=document.createElement('div');
        d.textContent=msg;
        logEl.appendChild(d);
      }
      function setStatus(msg){
        badge.textContent = msg || "READY";
        badge.style.display='inline-block';
      }
      window.__LMY = { showBadge(){ badge.style.display='inline-block'; }, log, setStatus };
      window.addEventListener('error', e=>log('[window.error] '+(e.message||e.error)));
      window.addEventListener('unhandledrejection', e=>log('[unhandled] '+(e.reason&&e.reason.message||e.reason)));
    })();
  </script>

  <header class="topbar">
    <div class="brand">LociMyu</div>
    <nav class="top-actions">
      <button id="signinBtn" class="btn primary">Googleにサインイン</button>
      <button id="signoutBtn" class="btn" disabled>サインアウト</button>
      <a id="manualLink" class="btn link" href="#" target="_blank">マニュアルPDF</a>
      <button id="readonlyLinkBtn" class="btn" title="閲覧専用URLをコピー">閲覧専用リンク</button>
      <button id="selfTestBtn" class="btn">SelfTest</button>
    </nav>
  </header>

  <main class="layout">
    <section id="viewerPane" class="viewer-pane">
      <div id="viewer" class="viewer"></div>
      <div id="loadingOverlay" class="overlay hidden">
        <div class="spinner"></div>
        <div class="overlay-text">読み込み中...</div>
      </div>
    </section>

    <aside id="deskPane" class="desk-pane">
      <div class="block">
        <label for="modelUrl">モデルURL / fileId</label>
        <div class="row">
          <input id="modelUrl" placeholder="共有URL もしくは fileId" />
          <button id="loadModelBtn" class="btn primary">読み込み</button>
        </div>
        <div class="row small">
          <label for="saveSlot">セーブデータ</label>
          <select id="saveSlot"></select>
          <button id="newSaveBtn" class="btn small">新規</button>
          <button id="dupSaveBtn" class="btn small">コピー</button>
          <button id="renameSaveBtn" class="btn small">名称変更</button>
        </div>
      </div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="captions">キャプション</button>
        <button class="tab-btn" data-tab="materials">マテリアル</button>
        <button class="tab-btn" data-tab="camera">カメラ</button>
      </div>

      <div class="tab-contents">
        <!-- キャプション（ホーム統合、縦並び） -->
        <section id="tab-captions" class="tab active">
          <div class="caption-pane vertical">
            <div class="caption-list" id="captionList"></div>
            <div class="caption-detail">
              <div class="row"><label>タイトル</label><input id="capTitle" /></div>
              <div class="row"><label>本文</label><textarea id="capBody" rows="5"></textarea></div>
              <div class="row">
                <label>画像</label>
                <div class="grid-2">
                  <select id="capImageSelect"></select>
                  <input id="capImageLocal" type="file" accept="image/*,.heic,.heif" />
                </div>
              </div>
              <div class="row"><img id="capImagePreview" style="max-width:100%;max-height:160px;border:1px solid var(--line);border-radius:8px;display:none"/></div>
              <div class="row">
                <label>ピン色</label>
                <select id="capColor">
                  <option value="red">赤</option><option value="orange">橙</option>
                  <option value="yellow">黄</option><option value="green">緑</option>
                  <option value="cyan">水</option><option value="blue">青</option>
                  <option value="magenta">紫</option><option value="white">白</option>
                </select>
              </div>
              <div class="row">
                <button id="addPinBtn" class="btn">ピン追加</button>
                <label for="pinFilter" style="margin-left:8px">ピン表示色</label>
                <select id="pinFilter">
                  <option value="all">すべて</option>
                  <option value="red">赤</option><option value="orange">橙</option>
                  <option value="yellow">黄</option><option value="green">緑</option>
                  <option value="cyan">水</option><option value="blue">青</option>
                  <option value="magenta">紫</option><option value="white">白</option>
                </select>
              </div>
              <div class="row">
                <button id="capSaveBtn" class="btn primary">キャプションを保存</button>
                <button id="capDeleteBtn" class="btn danger">削除</button>
              </div>
            </div>
          </div>
        </section>

        <!-- マテリアル -->
        <section id="tab-materials" class="tab">
          <div class="row">
            <label>透明度</label>
            <input id="matOpacity" type="range" min="0" max="1" step="0.01" value="1" />
            <span id="matOpacityVal">1.00</span>
          </div>
          <div class="row"><label><input id="matDoubleSided" type="checkbox" /> 裏面描画</label></div>
          <div class="row"><label><input id="matUnlit" type="checkbox" /> 光源無視</label></div>
          <div class="row">
            <label><input id="matWhiteKey" type="checkbox" /> 白を透明として描画</label>
            <input id="matWhiteKeyThr" type="range" min="0" max="1" step="0.01" value="0.95" />
          </div>
          <div class="row">
            <label><input id="matBlackKey" type="checkbox" /> 黒を透明として描画</label>
            <input id="matBlackKeyThr" type="range" min="0" max="1" step="0.01" value="0.05" />
          </div>
        </section>

        <!-- カメラ -->
        <section id="tab-camera" class="tab">
          <div class="grid-3">
            <button class="btn camPreset" data-v="front">前</button>
            <button class="btn camPreset" data-v="back">後</button>
            <button class="btn camPreset" data-v="left">左</button>
            <button class="btn camPreset" data-v="right">右</button>
            <button class="btn camPreset" data-v="top">上</button>
            <button class="btn camPreset" data-v="bottom">下</button>
          </div>
          <div class="row"><label><input id="orthoToggle" type="checkbox" /> 平行投影</label></div>
          <div class="row">
            <label for="bgColor">背景色</label>
            <input id="bgColor" type="color" value="#202225" />
          </div>
        </section>
      </div>
    </aside>
  </main>

  <footer class="bottombar mobile-only">
    <button id="mobileHome" class="btn small">ホーム</button>
    <button id="mobileMaterials" class="btn small">マテ</button>
    <button id="mobileCamera" class="btn small">カメラ</button>
    <button id="mobileCaptions" class="btn small">キャプ</button>
  </footer>

  <!-- アプリ設定 -->
  <script>
    window.__LOCIMYU_CONFIG__ = {
      apiKey: "AIzaSyCUnTCr5yWUWPdEXST9bKP1LpgawU5rIbI",
      clientId: "595200751510-ncahnf7edci6b9925becn5to49r6cguv.apps.googleusercontent.com",
      spreadsheetTitleSuffix: "__LociMyu",
      manualPdfPath: "manual.pdf",
      readOnlyParam: "readonly"
    };
  </script>

  <!-- 依存スクリプト -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="https://unpkg.com/heic2any@0.0.4/dist/heic2any.min.js"></script>

  <!-- ▼▼ フェーズ1パッチ（統合済み） ▼▼ -->
  <script type="module" src="js/phase1_patch.js"></script>
  <!-- エントリーポイント -->
  <script type="module" src="js/main.js"></script>
</body>
</html>
