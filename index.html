<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LociMyu â€” Sign-in Safe Full Build</title>
  <link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" fill="%230b0f14"/><text x="32" y="39" font-size="28" text-anchor="middle" fill="%2353b7ff" font-family="Arial">L</text></svg>'>

  <style>
    :root{ --bg:#0b0f14; --panel:#121922; --text:#e6edf3; --accent:#53b7ff; --muted:#8fa3bd; --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.3);}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    .app{display:grid;grid-template-rows:auto 1fr;height:100vh}
    header{display:flex;gap:.75rem;align-items:center;padding:10px 12px;background:linear-gradient(180deg,#0e1520,#0b0f14);border-bottom:1px solid #1e2837}
    .pill{background:rgba(255,255,255,.06);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.08);font-weight:700}
    input[type=text], select, textarea{background:#0f1722;border:1px solid #203049;color:var(--text);border-radius:10px;padding:8px 10px;min-width:260px}
    button{background:#152133;color:var(--text);border:1px solid #223146;border-radius:10px;padding:8px 12px;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    button:hover{background:#1a2b45}
    .accent{border-color:#2c82c9}
    .main{display:grid;grid-template-columns:360px 1fr 420px;gap:10px;padding:10px;height:calc(100vh - 58px)}
    .panel{background:#121922;border:1px solid #1e2837;border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;min-height:0}
    .panel h3{margin:0;padding:10px 12px;border-bottom:1px solid #203049;background:#0f1722;font-size:.95rem;font-weight:600}
    .panel .body{padding:10px;overflow:auto}
    #viewer{position:relative}
    #viewerCanvas{display:block;width:100%;height:100%;background:#0a0f16;border-radius:var(--radius)}
    #connector{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}
    #connector line{stroke:#7cc4ff;stroke-width:2;stroke-opacity:.9;filter:url(#dropshadow)}
    #connector circle{fill:#7cc4ff;opacity:.9}
    .hud{position:absolute;left:10px;bottom:10px;display:flex;gap:8px}
    .chip{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px}
    .spinner{position:absolute;inset:0;display:grid;place-items:center;background:linear-gradient(180deg, rgba(10,15,22,.75), rgba(10,15,22,.75));backdrop-filter: blur(2px);}
    .spinner[hidden]{display:none}
    .lds{width:64px;height:64px;border-radius:50%;border:6px solid rgba(255,255,255,.12);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .signin-gate{position:fixed;inset:0;display:grid;place-items:center;background:radial-gradient(1200px 600px at 50% 15%, rgba(83,183,255,.08), transparent 60%), linear-gradient(180deg,#0a0f16,#05070b);z-index:20}
    .card{width:min(560px,92vw);background:#0c1118;border:1px solid #1d2a3d;border-radius:24px;box-shadow:var(--shadow);padding:20px}
    .card h1{margin:4px 0 8px;font-size:1.35rem}
    .card p{color:#c2d0e2;opacity:.9}
    .list{display:flex;flex-direction:column;gap:8px}
    .list .row{display:flex;align-items:center;justify-content:space-between;gap:8px;background:#0f1722;border:1px solid #203049;border-radius:12px;padding:10px;cursor:pointer}
    .row .title{font-weight:600}
    .row .meta{color:#a9b8cf;font-size:.85rem}
    .row:hover{background:#132035}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .small{font-size:.85rem;color:#a9b8cf}
    .grid2{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .thumb{position:relative}
    .thumb img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid #223146;display:block}
    .thumb .del{position:absolute;top:-6px;right:-6px;width:20px;height:20px;border-radius:50%;background:#1e2a3b;border:1px solid #334966;color:#e8f0ff;line-height:18px;text-align:center;font-weight:700;cursor:pointer}
    .thumb .del:hover{background:#2a3b55}
    .hidden{display:none !important}
    .field{display:flex;gap:8px;align-items:center;margin:8px 0}
    .field label{min-width:120px;color:#a9b8cf}
    input[type="range"]{width:160px}
    .subtle{opacity:.8}
    .viewgrid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:40}
    .modal[hidden]{display:none}
    .modal .box{width:min(90vw,980px);max-height:80vh;background:#0f1722;border:1px solid #203049;border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
    .modal header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#0c131d;border-bottom:1px solid #203049}
    .modal .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;padding:10px;overflow:auto}
    .modal .cell{background:#0c1118;border:1px solid #223146;border-radius:12px;padding:8px;cursor:pointer;display:flex;flex-direction:column;gap:6px}
    .modal .cell img{width:100%;height:110px;object-fit:cover;border-radius:8px}
    .modal .cell .tag{font-size:.75rem;color:#a9b8cf}
    #viewerPreview{position:absolute;top:10px;right:10px;max-height:60%;border:1px solid #203049;border-radius:8px;background:#0a0f16cc;backdrop-filter: blur(2px);display:grid;grid-template-rows:auto 1fr auto;gap:6px;resize:both;overflow:hidden;min-width:220px;min-height:180px;padding:0}
    #viewerPreview.hidden{display:none}
    #previewControls{position:sticky;top:0;background:#0a0f16f0;border-bottom:1px solid #203049;padding:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;z-index:1}
    #previewWrap{position:relative;overflow:auto;padding:8px}
    #previewInner{transform-origin: top left;}
    #previewInner img{display:block;max-width:none;max-height:none;border-radius:6px}
    #viewerPreview .cap{font-size:.8rem;color:#a9b8cf;border-top:1px solid #203049;padding:6px 8px;background:#0a0f16f0}
    @media (max-width: 1100px){ .main{grid-template-columns:1fr; grid-template-rows: 360px 1fr 480px} }
    .dropdown{position:relative;display:inline-block}
    .dropdown-panel{position:absolute;top:100%;right:0;background:#0f1722;border:1px solid #203049;border-radius:10px;box-shadow:var(--shadow);padding:10px;min-width:220px;z-index:15}
    .dropdown-panel[hidden]{display:none}
  </style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
      "three/examples/jsm/": "https://unpkg.com/three@0.157.0/examples/jsm/"
    }
  }
  </script>
  <script src="https://unpkg.com/heic2any@0.0.4/dist/heic2any.min.js"></script>
</head>

<body>
<div class="app">
  <header>
    <span class="pill">LociMyu</span>
    <div class="toolbar" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input id="inputGLB" type="text" placeholder="GLB fileId or share URL" />
      <input id="inputSheet" type="text" placeholder="SpreadsheetId or share URLï¼ˆç©ºãªã‚‰è‡ªå‹•ä½œæˆï¼‰" />
      <button id="btnLoad" class="accent" disabled>GLBã‚’èª­ã¿è¾¼ã‚€</button>
      <button id="btnViewOnly">é–²è¦§ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ</button>
      <span id="statusLabel" class="chip">ã‚µã‚¤ãƒ³ã‚¤ãƒ³å¾…ã¡â€¦</span>
    </div>
  </header>

  <div class="main">
    <section class="panel" id="leftToolbox">
      <h3>ãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ï¼ˆãƒãƒ†ãƒªã‚¢ãƒ« & ã‚«ãƒ¡ãƒ© & ãƒ”ãƒ³ï¼‰</h3>
      <div class="body">
        <div class="small subtle">Shift + ã‚¯ãƒªãƒƒã‚¯ ã§ãƒ”ãƒ³ã‚’é…ç½®</div>
        <div class="flex" style="margin-top:6px;margin-bottom:6px">
          <button id="btnAddPin" disabled>ï¼‹ ãƒ”ãƒ³è¿½åŠ ãƒ¢ãƒ¼ãƒ‰</button>
          <button id="btnGizmo" disabled>ã‚®ã‚ºãƒ¢: OFF</button>
          <button id="btnUndo" disabled>Ctrl+Z</button>
        </div>

        <hr style="border-color:#203049;border-width:1px 0;margin:12px 0">

        <div class="small" style="margin:4px 0 6px">ãƒãƒ†ãƒªã‚¢ãƒ«ç·¨é›†</div>
        <div class="field"><label>å¯¾è±¡</label><select id="matSelect"><option value="__all__">ï¼ˆå…¨ãƒãƒ†ãƒªã‚¢ãƒ«ï¼‰</option></select></div>
        <div class="field"><label>Unlit</label><input id="matUnlit" type="checkbox"><span class="small">æ˜æš—ãªã—</span></div>
        <div class="field"><label>è£é¢æç”»</label><input id="matDoubleSided" type="checkbox"><span class="small">DoubleSide</span></div>
        <div class="field"><label>ä¸é€æ˜åº¦</label><input id="matOpacity" type="range" min="0" max="1" step="0.01" value="1"><span id="matOpacityVal" class="small">1.00</span></div>
        <div class="field"><label>ç™½â†’é€æ˜</label><input id="matWhiteTransparent" type="checkbox"><span class="small">ç™½ã»ã©é€æ˜</span></div>
        <div class="field"><label>é»’â†’é€æ˜ï¼ˆåè»¢ï¼‰</label><input id="matBlackTransparent" type="checkbox"><span class="small">é»’ã»ã©é€æ˜</span></div>
        <div class="field"><label>é–¾å€¤ï¼ˆÎ±Testï¼‰</label><input id="matThreshold" type="range" min="0" max="1" step="0.01" value="0"><span id="matThresholdVal" class="small">0.00</span></div>

        <hr style="border-color:#203049;border-width:1px 0;margin:12px 0">

        <div class="small" style="margin:4px 0 6px">ãƒ“ãƒ¥ãƒ¼</div>
        <div class="viewgrid" style="margin-bottom:8px">
          <button id="viewFront">å‰é¢</button>
          <button id="viewBack">èƒŒé¢</button>
          <button id="viewLeft">å·¦é¢</button>
          <button id="viewRight">å³é¢</button>
          <button id="viewTop">ä¸Šé¢</button>
          <button id="viewBottom">ä¸‹é¢</button>
        </div>
        <div class="field"><label>å¹³è¡ŒæŠ•å½±</label><input id="projOrtho" type="checkbox"><span class="small">ON: Orthographic</span></div>
        <div class="field"><label>èƒŒæ™¯è‰²</label><input id="bgColor" type="color" value="#0a0f16"></div>
      </div>
    </section>

    <section class="panel" id="viewer">
      <div class="spinner" id="loading" hidden><div class="lds"></div></div>
      <canvas id="viewerCanvas"></canvas>

      <svg id="connector">
        <defs>
          <filter id="dropshadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="0" stdDeviation="2" flood-color="#001a33" flood-opacity="0.9"/>
          </filter>
        </defs>
        <line id="connLine" x1="0" y1="0" x2="0" y2="0" style="display:none"/>
        <circle id="connDot" r="3" cx="0" cy="0" style="display:none"/>
      </svg>

      <div class="hud"><div class="chip" id="modeLabel">Orbit</div></div>
    </section>

    <section class="panel" id="rightCaption">
      <h3>ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³</h3>
      <div class="body">
        <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:6px">
          <div class="small">ãƒ”ãƒ³ä¸€è¦§</div>
          <div class="flex" style="gap:6px;align-items:center">
            <div class="dropdown">
              <button id="btnColorFilter" disabled>è‰²ãƒ•ã‚£ãƒ«ã‚¿ â–¾</button>
              <div id="colorFilterPanel" class="dropdown-panel" hidden>
                <div class="small" style="margin-bottom:6px">è¡¨ç¤ºã™ã‚‹è‰²ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div>
                <div id="colorFilterList"></div>
                <div class="flex" style="justify-content:flex-end;margin-top:8px">
                  <button id="btnFilterAll">ã™ã¹ã¦</button>
                  <button id="btnFilterNone">ãªã—</button>
                  <button id="btnFilterClose">é–‰ã˜ã‚‹</button>
                </div>
              </div>
            </div>
            <button id="btnTogglePins" disabled>ãƒ”ãƒ³è¡¨ç¤º: ON</button>
          </div>
        </div>

        <div id="pinsList" class="list" style="margin:8px 0 14px"></div>

        <div id="noSelection">ãƒ”ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</div>

        <div id="editor" class="hidden">
          <div class="grid2">
            <label>ã‚¿ã‚¤ãƒˆãƒ«<input id="capTitle" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" /></label>
            <button id="btnSavePin" class="accent" disabled>ä¿å­˜ï¼ˆSheetsï¼‰</button>
          </div>
          <label>æœ¬æ–‡<textarea id="capBody" rows="6" placeholder="ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³æœ¬æ–‡"></textarea></label>

          <div class="flex">
            <input id="imgLocal" type="file" accept="image/*,.heic,.HEIC" />
            <button id="btnAttach" class="accent" disabled>ç”»åƒã‚’æ·»ä»˜ã—ã¦Driveã«ä¿å­˜</button>
          </div>
          <div class="flex">
            <button id="btnPickFromFolder" class="accent" disabled>ğŸ“ Driveã‹ã‚‰ä¿å­˜</button>
          </div>

          <div class="thumbs" id="thumbs"></div>

          <div class="flex" style="justify-content:space-between;margin-top:8px;margin-bottom:8px">
            <button id="btnDeletePin" style="border-color:#5a1f26;color:#ffb4b4" disabled>ãƒ”ãƒ³å‰Šé™¤</button>
            <span class="small" id="autosaveTip">å…¥åŠ›ã¯æ•°ç§’å¾Œã«è‡ªå‹•ä¿å­˜</span>
          </div>
          <div class="small subtle">â€» ãƒ”ãƒ³é¸æŠã§ãƒ“ãƒ¥ãƒ¼ãŒè‡ªå‹•ã§å¯„ã‚Šã¾ã™</div>
        </div>
      </div>
    </section>
  </div>
</div>

<div id="pickerModal" class="modal" hidden>
  <div class="box">
    <header>
      <strong>ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ç”»åƒã‚’é¸æŠ</strong>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnPickerReload">å†èª­ã¿è¾¼ã¿</button>
        <button id="btnPickerClose">é–‰ã˜ã‚‹</button>
      </div>
    </header>
    <div id="pickerGrid" class="grid"></div>
  </div>
</div>

<div class="signin-gate" id="gate">
  <div class="card">
    <h1>Googleã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³</h1>
    <p>æœ¬ãƒ„ãƒ¼ãƒ«ã¯ Google Drive / Google Sheets ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚å…ˆã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button id="btnSignIn" class="accent" style="font-weight:700" disabled>ğŸ” Sign in with Google</button>
      <span class="meta" style="opacity:.8">OAuth2 (Drive.file / Sheets)</span>
    </div>
  </div>
</div>

<script>
  // ãƒ•ãƒ©ã‚°ï¼šGoogleãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ­ãƒ¼ãƒ‰
  window.__flags = { gapi:false, gis:false };
  function onGapi(){ window.__flags.gapi = true; }
  function onGis(){  window.__flags.gis  = true; }
</script>
<script async defer src="https://accounts.google.com/gsi/client" onload="onGis()"></script>
<script async defer src="https://apis.google.com/js/api.js" onload="onGapi()"></script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';
import { TransformControls } from 'three/examples/jsm/controls/TransformControls.js';

/* ===================== Google API è¨­å®š ===================== */
const CLIENT_ID = '595200751510-ncahnf7edci6b9925becn5to49r6cguv.apps.googleusercontent.com';
const API_KEY   = 'AIzaSyCUnTCr5yWUWPdEXST9bKP1LpgawU5rIbI';
const DISCOVERY_DOCS = [
  'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
  'https://www.googleapis.com/discovery/v1/apis/sheets/v4/rest'
];
const SCOPES = [
  'https://www.googleapis.com/auth/drive.file',
  'https://www.googleapis.com/auth/drive.readonly',
  'https://www.googleapis.com/auth/drive.metadata.readonly',
  'https://www.googleapis.com/auth/spreadsheets'
].join(' ');

/* ===================== è¦ç´ å‚ç…§ ===================== */
const el = {
  gate: document.getElementById('gate'),
  btnSignIn: document.getElementById('btnSignIn'),
  statusLabel: document.getElementById('statusLabel'),
  inputGLB: document.getElementById('inputGLB'),
  inputSheet: document.getElementById('inputSheet'),
  btnLoad: document.getElementById('btnLoad'),
  btnViewOnly: document.getElementById('btnViewOnly'),
  loading: document.getElementById('loading'),
  viewerCanvas: document.getElementById('viewerCanvas'),
  // å·¦ãƒ‘ãƒãƒ«æŠœç²‹ï¼ˆæœ¬ä»¶ã®ä¿®æ­£ã«ç›´æ¥é–¢ä¿‚ã®ãªã„UIã¯çœç•¥ã›ãšãã®ã¾ã¾ã‚ã‚Šã¾ã™ï¼‰
  matSelect: document.getElementById('matSelect'),
  matUnlit: document.getElementById('matUnlit'),
  matDoubleSided: document.getElementById('matDoubleSided'),
  matOpacity: document.getElementById('matOpacity'),
  matOpacityVal: document.getElementById('matOpacityVal'),
  matWhiteTransparent: document.getElementById('matWhiteTransparent'),
  matBlackTransparent: document.getElementById('matBlackTransparent'),
  matThreshold: document.getElementById('matThreshold'),
  matThresholdVal: document.getElementById('matThresholdVal'),
  // ã‚«ãƒ¡ãƒ©
  viewFront: document.getElementById('viewFront'),
  viewBack: document.getElementById('viewBack'),
  viewLeft: document.getElementById('viewLeft'),
  viewRight: document.getElementById('viewRight'),
  viewTop: document.getElementById('viewTop'),
  viewBottom: document.getElementById('viewBottom'),
  projOrtho: document.getElementById('projOrtho'),
  bgColor: document.getElementById('bgColor'),
};

const PRESET_COLORS = ['#ff6b6b','#ffd166','#06d6a0','#118ab2','#a78bfa','#f472b6','#f59e0b','#22c55e','#60a5fa'];

/* ===================== çŠ¶æ…‹ ===================== */
const state = {
  isViewOnly: new URL(location.href).searchParams.get('view') === '1',
  authReady: false,
  tokenClient: null,
  glbFileId: '',
  sheetId: '',
  scene:null, camera:null, renderer:null, controls:null, tcontrols:null,
};

/* ===================== Google åˆæœŸåŒ–ï¼ˆå¤šé‡ã‚¬ãƒ¼ãƒ‰ï¼‰ ===================== */
let __initPromise = null;
async function initGoogle(){
  if (__initPromise) return __initPromise;
  __initPromise = (async ()=>{
    // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ã¾ã§å¾…æ©Ÿ
    await new Promise(r => {
      const tm = setInterval(()=>{
        if (window.__flags?.gapi && window.__flags?.gis){ clearInterval(tm); r(); }
      }, 60);
    });

    // gapi client åˆæœŸåŒ–
    await new Promise((resolve, reject)=>{
      gapi.load('client', async ()=>{
        try{
          await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
          resolve();
        }catch(e){ reject(e); }
      });
    });

    // Token Client æº–å‚™
    state.tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (resp) => {
        if(resp?.error) return;
        state.authReady = true;
        el.gate.style.display = 'none';
        ensureAuthUIs();
        maybeEnableLoadFromViewLink();
      }
    });

    // ã‚²ãƒ¼ãƒˆã®ãƒœã‚¿ãƒ³æ´»æ€§åŒ–
    el.btnSignIn.disabled = false;
    ensureAuthUIs();
  })();
  return __initPromise;
}

function ensureAuthUIs(){
  const signedIn = state.authReady;
  el.statusLabel.textContent = signedIn ? 'ã‚µã‚¤ãƒ³ã‚¤ãƒ³å®Œäº†' : 'ã‚µã‚¤ãƒ³ã‚¤ãƒ³å¾…ã¡â€¦';
  el.btnLoad.disabled = !signedIn;
}

/* ===================== ã‚µã‚¤ãƒ³ã‚¤ãƒ³ UIï¼ˆåˆæœŸåŒ–å¾…ã¡â†’ç™ºè¡Œï¼‰ ===================== */
el.btnSignIn.addEventListener('click', async ()=>{
  try{
    if(!state.tokenClient){
      await initGoogle();                 // â† åˆæœŸåŒ–å®Œäº†ã‚’å¾…ã¤
    }
    state.tokenClient.requestAccessToken({ prompt: '' });
  }catch(e){
    console.error('Sign-in failed', e);
    alert('Google API ã®åˆæœŸåŒ–ä¸­ã§ã™ã€‚æ•°ç§’å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
  }
});

/* ===================== Three.js ãƒ“ãƒ¥ãƒ¼ã‚¢ ===================== */
function viewerInit(){
  const canvas = el.viewerCanvas;
  const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:false});
  renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
  renderer.setSize(canvas.clientWidth, canvas.clientHeight, false);
  renderer.outputColorSpace = THREE.SRGBColorSpace;

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(50, 1, 0.01, 2000);
  camera.position.set(2.5, 1.5, 2.5);

  const controls = new OrbitControls(camera, canvas);
  controls.enableDamping = true;
  controls.dampingFactor = 0.08;

  const tcontrols = new TransformControls(camera, canvas);
  tcontrols.visible = false;
  scene.add(tcontrols);

  scene.add(new THREE.AmbientLight(0xffffff, 0.7));
  const dir = new THREE.DirectionalLight(0xffffff, 0.8);
  dir.position.set(1,2,1);
  scene.add(dir);

  state.scene=scene; state.camera=camera; state.renderer=renderer; state.controls=controls; state.tcontrols=tcontrols;

  function loop(){ requestAnimationFrame(loop);
    controls.update();
    renderer.setSize(canvas.clientWidth, canvas.clientHeight, false);
    camera.aspect = canvas.clientWidth / canvas.clientHeight;
    camera.updateProjectionMatrix();
    renderer.render(scene, camera);
  }
  loop();
}
viewerInit();

/* ===================== ã‚«ãƒ¡ãƒ©/èƒŒæ™¯ UI ===================== */
function focusOrigin(){
  state.controls.target.set(0,0,0);
  state.controls.update();
}
el.bgColor.addEventListener('input', ()=> state.renderer.setClearColor(new THREE.Color(el.bgColor.value)));
const setView = (x,y,z)=>{ state.camera.position.set(x,y,z); focusOrigin(); }
el.viewFront.addEventListener('click', ()=> setView(0, 0, 2.2));
el.viewBack .addEventListener('click', ()=> setView(0, 0,-2.2));
el.viewLeft .addEventListener('click', ()=> setView( 2.2, 0, 0));
el.viewRight.addEventListener('click', ()=> setView(-2.2, 0, 0));
el.viewTop  .addEventListener('click', ()=> setView(0, 2.2, 0));
el.viewBottom.addEventListener('click', ()=> setView(0,-2.2, 0));
el.projOrtho.addEventListener('change', ()=>{
  const canvas = el.viewerCanvas;
  const aspect = canvas.clientWidth / canvas.clientHeight;
  if(el.projOrtho.checked){
    const h=1.8; const o=new THREE.OrthographicCamera(-h*aspect,h*aspect,h,-h,0.01,2000);
    o.position.copy(state.camera.position); o.lookAt(state.controls.target);
    state.camera=o; state.controls.object=o;
  }else{
    const p=new THREE.PerspectiveCamera(50, aspect, 0.01, 2000);
    p.position.copy(state.camera.position); p.lookAt(state.controls.target);
    state.camera=p; state.controls.object=p;
  }
});

/* ===================== Drive / Sheetsï¼ˆå¿…è¦æœ€å°é™ï¼‰ ===================== */
function extractDriveFileId(input){
  if(!input) return '';
  const m1 = input.match(/\/file\/d\/([a-zA-Z0-9_-]{10,})/); if(m1) return m1[1];
  const m2 = input.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);     if(m2) return m2[1];
  const m3 = input.match(/^([a-zA-Z0-9_-]{20,})$/);          if(m3) return m3[1];
  return input.trim();
}
function extractSpreadsheetId(input){
  if(!input) return '';
  const m1 = input.match(/spreadsheets\/d\/([a-zA-Z0-9_-]{10,})/); if(m1) return m1[1];
  const m2 = input.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);           if(m2) return m2[1];
  const m3 = input.match(/^([a-zA-Z0-9_-]{20,})$/);                if(m3) return m3[1];
  return input.trim();
}
function maybeEnableLoadFromViewLink(){
  const url = new URL(location.href);
  const fid = extractDriveFileId(url.searchParams.get('glb')||'');
  const sid = extractSpreadsheetId(url.searchParams.get('sheet')||'');
  if (state.isViewOnly && fid){
    el.inputGLB.value = fid;
    if (sid) el.inputSheet.value = sid;
    setTimeout(()=> el.btnLoad.click(), 0);
  }
}
async function ensureSignedIn(){
  if (state.authReady) return true;
  if (!state.tokenClient) await initGoogle();
  return new Promise(resolve=>{
    state.tokenClient.requestAccessToken({ prompt:'' });
    const tm=setInterval(()=>{ if(state.authReady){ clearInterval(tm); resolve(true);} },80);
  });
}
async function driveGetContentURL(fileId){
  return `https://www.googleapis.com/drive/v3/files/${encodeURIComponent(fileId)}?alt=media&supportsAllDrives=true`;
}

/* ===================== GLB èª­ã¿è¾¼ã¿ ===================== */
const loader = new GLTFLoader();
async function loadGLBByFileId(fileId){
  await ensureSignedIn();
  state.glbFileId = fileId;
  el.loading.hidden = false;
  try{
    const url = await driveGetContentURL(fileId);
    const resp = await fetch(url, { headers:{ 'Authorization':'Bearer '+gapi.client.getToken().access_token }});
    const arrbuf = await resp.arrayBuffer();

    if(state.model){
      state.scene.remove(state.model);
    }
    const gltf = await new Promise((res,rej)=> loader.parse(arrbuf,'',res,rej));
    state.model = gltf.scene;
    state.scene.add(state.model);
    state.renderer.setClearColor(new THREE.Color(el.bgColor.value));
    focusOrigin();
  }catch(e){
    console.error('GLB load failed', e);
    alert('GLBèª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }finally{
    el.loading.hidden = true;
  }
}

/* ===================== ãƒ˜ãƒƒãƒ€ãƒ¼æ“ä½œ ===================== */
el.btnLoad.addEventListener('click', async ()=>{
  const fid = extractDriveFileId(el.inputGLB.value);
  if(!fid) return alert('GLBã® fileId ã¾ãŸã¯å…±æœ‰URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  const sid = extractSpreadsheetId(el.inputSheet.value);
  if (sid) state.sheetId = sid;
  await loadGLBByFileId(fid);
});
el.btnViewOnly.addEventListener('click', ()=>{
  const fid = extractDriveFileId(el.inputGLB.value||state.glbFileId);
  const sid = extractSpreadsheetId(el.inputSheet.value||state.sheetId);
  if(!fid) return alert('GLBã®IDã‚’å…ˆã«å…¥åŠ›ã—ã¦ãã ã•ã„');
  const u = new URL(location.href);
  u.searchParams.set('view','1');
  u.searchParams.set('glb',fid);
  if(sid) u.searchParams.set('sheet',sid);
  navigator.clipboard.writeText(u.toString());
  alert('é–²è¦§ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
});

/* ===================== èµ·å‹•æ™‚å‡¦ç† ===================== */
(async ()=>{
  try{
    // æ—©ã‚ã«åˆæœŸåŒ–ã‚’é–‹å§‹ï¼ˆå®Œäº†å‰ã§ã‚‚ã‚¯ãƒªãƒƒã‚¯å®‰å…¨ï¼‰
    initGoogle();
  }catch(e){ console.warn('initGoogle kickoff failed', e); }
})();
</script>
</body>
</html>
